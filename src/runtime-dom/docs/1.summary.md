# Vue3 æ‰‹å†™ Element å…ƒç´ çš„æ›´æ–°

ä¹‹å‰æˆ‘ä»¬å®ç°äº† element å…ƒç´ çš„æŒ‚è½½ï¼Œè¿˜æ²¡æœ‰å®ç°å½“å…ƒç´ å†…çš„æ•°æ®å‘ç”Ÿæ”¹å˜çš„æ—¶å€™ï¼Œè¦å¯¹å…ƒç´ è¿›è¡Œæ›´æ–°æ“ä½œã€‚

ä¸ºæ­¤æˆ‘å‡†å¤‡äº†ä¸€ä¸ªå° demoï¼ŒæœŸæœ›ç”¨æˆ·åœ¨ç‚¹å‡» button æŒ‰é’®çš„æ—¶å€™èƒ½è®©`count`åŠ ä¸€ï¼š

```typescript
import { ref, h } from '../../lib/guide-toy-vue3.esm.js'
export const App = {
  name: 'app',
  setup() {
    const count = ref(0)
    const click = () => {
      count.value++
    }
    return {
      count,
      click,
    }
  },
  render() {
    return h('div', {}, [
      h('p', {}, `count: ${this.count}`),
      h('button', { onClick: this.click }, 'ç‚¹å‡»æ›´æ–°'),
    ])
  },
}
```

[![XwtJqU.md.png](https://s1.ax1x.com/2022/06/05/XwtJqU.md.png)](https://imgtu.com/i/XwtJqU)

å¯ä»¥çœ‹åˆ° this.count å¹¶æ²¡æœ‰æ‰“å°å‡ºæ•°å€¼è€Œæ˜¯ä¸€ä¸ª`[Object object]`ï¼Œä¸ºä»€ä¹ˆä¼šè¿™æ ·å‘¢ï¼Ÿæˆ‘ä»¬å†è¿›ä¸€æ­¥æ‰“å°`this.count`æ˜¯ä»€ä¹ˆã€‚

[![Xwtosf.md.png](https://s1.ax1x.com/2022/06/05/Xwtosf.md.png)](https://imgtu.com/i/Xwtosf)

ä»–æ˜¯ä¸€ä¸ª ref å¯¹è±¡ï¼Œæˆ‘ä»¬æƒ³è¦çš„å€¼åœ¨`_value`é‡Œé¢ï¼Œé‚£è¦æ€ä¹ˆå»é™¤è¿™ä¸ªå€¼å‘¢ï¼Ÿæˆ‘ä»¬ä¹‹å‰æ˜¯ä¸æ˜¯å®ç°äº†`proxyRefs`ï¼Œæˆ‘å½“æ—¶è¯´è¿‡ä»–æ˜¯ç”¨æ¥åœ¨ h å‡½æ•°é‡Œé¢è‡ªåŠ¨è§£åŒ… ref çš„ã€‚

ç”Ÿæ€•ä½ ä»¬å¿˜äº†æˆ‘åœ¨è¿™é‡Œå†è´´ä¸€æ¬¡è¿™æ®µä»£ç çš„å®ç°å§ã€‚

```typescript
// é€šå¸¸ç”¨åœ¨vue3 templateé‡Œé¢refå–å€¼ï¼Œåœ¨templateé‡Œé¢ä¸éœ€è¦.valueå°±å¯ä»¥æ‹¿åˆ°refçš„å€¼
export function proxyRefs<T extends object>(obj: T) {
  return isReactive(obj)
    ? obj
    : new Proxy<any>(obj, {
        get(target, key) {
          // unrefå·²ç»å¤„ç†äº†æ˜¯å¦refçš„æƒ…å†µæ‰€ä»¥æˆ‘ä»¬ä¸éœ€è¦è‡ªå·±ifå¤„ç†ï¼Œå¦‚æœæ˜¯ï¼Œè¿”å›.valueï¼Œå¦‚æœä¸æ˜¯ï¼Œç›´æ¥è¿”å›å€¼
          return unref(Reflect.get(target, key))
        },
        set(target, key, value) {
          // å› ä¸ºvalueä¸ºæ™®é€šå€¼ç±»å‹çš„æƒ…å†µç‰¹æ®Šï¼Œè¦æŠŠvalueèµ‹å€¼ç»™refçš„.value
          if (isRef(target[key]) && !isRef(value)) {
            target[key].value = value
            return true
          } else {
            return Reflect.set(target, key, value)
          }
        },
      })
}
```

æˆ‘ä»¬åªéœ€è¦å¯¹ setup çš„è¿”å›å€¼è¿›è¡Œè§£åŒ…å°±å¥½äº†ã€‚

åœ¨ runtime-core é‡Œé¢çš„ component.ts é‡Œé¢æ·»åŠ  proxyRefs çš„è°ƒç”¨æ“ä½œ

```typescript
function handleSetupResult(instance: any, setupResult: any) {
  // TODO handle function
  if (isFunction(setupResult)) {
    instance.render = setupResult
  } else if (isObject(setupResult)) {
    // æŠŠsetupè¿”å›çš„å¯¹è±¡æŒ‚è½½åˆ°setupStateä¸Š  proxyRefså¯¹setupResultè§£åŒ…
    instance.setupState = proxyRefs(setupResult) // æ–°å¢
  }
}
```

è¿™æ · ref çš„ value å°±èƒ½æ­£å¸¸æ˜¾ç¤ºå‡ºæ¥äº†ã€‚

[![XwUu3n.md.png](https://s1.ax1x.com/2022/06/05/XwUu3n.md.png)](https://imgtu.com/i/XwUu3n)

ä¸‹ä¸€æ­¥æˆ‘ä»¬æ¥å®Œæˆå…ƒç´ çš„æ›´æ–°

é¡µé¢ä¸Šçš„å…ƒç´ éƒ½æ˜¯è™šæ‹Ÿ dom å¯¹è±¡

```typescript
{
  type: 'div',
  props: {},
  children:{},
  el: {},
  shapeFlag: 2
  ...
}
```

å…ƒç´ æ›´æ–°çš„æ—¶å€™éœ€è¦ç”Ÿæˆæ–°çš„ vnode å¯¹è±¡ï¼Œç„¶åé€šè¿‡æ—§çš„ vnode å’Œæ–°çš„ vnode è¿›è¡Œå¯¹æ¯”ï¼Œä»è€Œæ‰¾å‡ºè¦æ›´æ–°çš„åœ°æ–¹ã€‚å¦‚æœæ˜¯æ–‡æœ¬æ›´æ–°ï¼Œé‚£æˆ‘ä»¬å¯ä»¥ç”¨ dom.textContext å±æ€§æ›´æ–°ã€‚ [![XgflVI.md.png](https://s1.ax1x.com/2022/06/12/XgflVI.md.png)](https://imgtu.com/i/XgflVI)

å‰ææ˜¯æˆ‘ä»¬éœ€è¦è·å–æ—§çš„ vnode å’Œæ–°çš„ vnodeã€‚æ–°çš„ vnode æ€ä¹ˆè·å–ï¼Ÿé‡æ–°æ‰§è¡Œä¸€æ¬¡`render`å‡½æ•°å°±å¯ä»¥äº†å•Šï¼Œé‚£ä»€ä¹ˆæ—¶å€™åº”è¯¥é‡æ–°æ‰§è¡Œä¸€æ¬¡ render å‡½æ•°å‘¢ï¼Ÿä¸Šé¢çš„ count å€¼æ˜¯ä¸€ä¸ª ref å“åº”å¼å¯¹è±¡ï¼Œåªè¦ count å‘ç”Ÿæ”¹å˜ï¼Œè§†å›¾ä¸­çš„ text å°±åº”è¯¥å‘ç”Ÿæ›´æ–°å•Šï¼Œrender å‡½æ•°å°±åº”è¯¥é‡æ–°æ‰§è¡Œä¸€æ¬¡ç”Ÿæˆä¸€ä¸ª vnode å¯¹è±¡ã€‚

ä¹‹å‰çš„ç« èŠ‚æˆ‘ä»¬å®ç°äº†`effect`ï¼Œå®ƒçš„ä¸»è¦ä½œç”¨æ˜¯å“åº”å¼å¯¹è±¡çš„å€¼å‘ç”Ÿæ”¹å˜çš„æ—¶å€™ï¼Œä¼šæ‰§è¡Œä¸€æ¬¡å¯¹è¯¥å“åº”å¼å¯¹è±¡ç›¸å…³è”çš„`effect`ï¼ˆè§¦å‘ä¾èµ–ï¼‰ã€‚

æˆ‘ä»¬åªéœ€è¦åœ¨ render å‡½æ•°è¢«æ‰§è¡Œçš„å‡½æ•°é‡Œé¢ï¼Œç”¨ effect åŒ…è£¹èµ·æ¥ã€‚ç­‰åˆ° count å‘ç”Ÿæ”¹å˜çš„æ—¶å€™ï¼Œå°±ä¼šé‡æ–°æ‰§è¡Œä¸€æ¬¡ render å‡½æ•°äº†ã€‚

```typescript
// In renderer.ts
function setupRenderEffect(instance: any, vnode: any, container: any) {
  effect(() => {
    const subTree = instance.render.call(instance.proxy)
    console.log('subTree===>', subTree)
    patch(subTree, container, instance)
    vnode.el = subTree.el
    instance.isMounted = true
  })
}
```

### ä¾èµ–æ”¶é›†

```typescript
render() {
  // è§¦å‘äº†refçš„getæ“ä½œï¼ˆä¾èµ–æ”¶é›†ï¼‰
    return h('div', {}, [
      h('p', {}, `count: ${this.count}`),
      h('button', { onClick: this.click }, 'ç‚¹å‡»æ›´æ–°'),
    ])
  },
```

### è§¦å‘ä¾èµ–

```typescript
setup() {
    const count = ref(0)
    const click = () => {
      // è§¦å‘äº†refçš„setæ“ä½œï¼ˆæ‰§è¡Œeffectå›è°ƒå‡½æ•°ï¼‰
      count.value++
    }
    return {
      count,
      click,
    }
  },
```

[![XgH4PA.md.png](https://s1.ax1x.com/2022/06/12/XgH4PA.md.png)](https://imgtu.com/i/XgH4PA)

æ ¹æ®ç°åœ¨çš„é€»è¾‘ï¼Œå¯ä»¥çœ‹åˆ°å¤šæ¬¡ç‚¹å‡» button ä¹‹åï¼Œè™½ç„¶ count æ›´æ–°äº†ï¼Œä½†æ˜¯é‡å¤çš„å…ƒç´ ä¹Ÿè¢« mount è¿› dom æ ‘ä¸Šé¢ã€‚åŸå› æ˜¯æ‰§è¡Œ render çš„å‡½æ•°çš„æ—¶å€™å®ƒå¹¶ä¸çŸ¥é“ç»„ä»¶æ˜¯å¦å·²ç»è¢«æŒ‚è½½ã€‚

æ‰€ä»¥éœ€è¦åœ¨ç»„ä»¶å®ä¾‹ä¸Šæ–°å¢ä¸€ä¸ªå±æ€§`isMounted`ï¼Œè¯¥å±æ€§å€¼æ˜¯ boolean ç±»å‹ï¼Œè¡¨ç¤ºç»„ä»¶æ˜¯å¦å·²ç»è¢«æŒ‚è½½ã€‚

```typescript
export function createComponentInstance(vnode: any, parentComponent: any) {
  console.log('createComponentInstance', parentComponent)
  const type = vnode.type
  const instance = {
    vnode,
    type,
    render: null,
    setupState: {},
    props: {},
    emit: () => {},
    slots: {},
    isMounted: false, // æ–°å¢
    provides: parentComponent
      ? parentComponent.provides
      : ({} as Record<string, any>),
    parent: parentComponent,
  }
  instance.emit = emit.bind(null, instance) as any
  return instance
}
```

æ›´æ”¹ setupRenderEffect å†…éƒ¨é€»è¾‘

```typescript
function setupRenderEffect(instance: any, vnode: any, container: any) {
  effect(() => {
    if (!instance.isMounted) {
      // è¿™é‡Œå¤„ç†ç¬¬ä¸€æ¬¡è¢«æŒ‚è½½çš„é€»è¾‘
      const subTree = instance.render.call(instance.proxy)
      instance.subTree = subTree
      patch(null, subTree, container, instance)
      vnode.el = subTree.el
      instance.isMounted = true
    } else {
      // è¿™é‡Œå¤„ç†æ›´æ–°çš„é€»è¾‘
      console.log('update')
    }
  })
}
```

> æ³¨æ„ï¼šç¬¬ä¸€æ¬¡è¢«æŒ‚è½½çš„é€»è¾‘å®Œæˆä¹‹åï¼Œè¿˜éœ€è¦æŠŠ isMounted è®¾ç½®ä¸º trueï¼Œè¿™æ ·ä¸‹æ¬¡æ›´æ–°çš„æ—¶å€™ï¼Œå°±ä¸ä¼šæ‰§è¡Œç¬¬ä¸€æ¬¡çš„é€»è¾‘äº†ã€‚

æˆ‘ä»¬æŠŠæ³¨æ„åŠ›èšç„¦åˆ°æ›´æ–°çš„é€»è¾‘ã€‚

æˆ‘ä»¬éœ€è¦ä¸¤ä¸ª vnodeï¼Œæ–°çš„å’Œæ—§çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬åŒæ ·è¦æ‰§è¡Œä¸€é render å‡½æ•°ï¼Œä¸ºäº†èƒ½åœ¨æ›´æ–°çš„æ—¶å€™æ‹¿åˆ°è€çš„ vnodeï¼Œæˆ‘ä»¬è¿˜éœ€è¦åœ¨ä¸Šä¸€æ¬¡ render å‡½æ•°æ‰§è¡Œçš„æ—¶å€™å¾—åˆ°çš„ vnode èµ‹å€¼ç»™ä¸€ä¸ªæ–°çš„å±æ€§`subTree`ï¼Œè¿™ä¸ªå±æ€§åŒæ ·æ˜¯åœ¨ç»„ä»¶å®ä¾‹ instance ä¸Šã€‚

è¿™å°±å¾ˆå¥½è§£é‡Šäº†ä¸ºä»€ä¹ˆæˆ‘åœ¨ç¬¬ä¸€æ¬¡æŒ‚è½½çš„é€»è¾‘ä¸­åŠ å…¥äº†`instance.subTree = subTree`è¿™ä¸ªè¡¨è¾¾å¼ã€‚

```typescript
export function createComponentInstance(vnode: any, parentComponent: any) {
  console.log('createComponentInstance', parentComponent)
  const type = vnode.type
  const instance = {
    vnode,
    type,
    render: null,
    setupState: {},
    props: {},
    emit: () => {},
    slots: {},
    isMounted: false,
    subTree: {}, // æ–°å¢
    provides: parentComponent
      ? parentComponent.provides
      : ({} as Record<string, any>),
    parent: parentComponent, // çˆ¶ç»„ä»¶çš„ç»„ä»¶å®ä¾‹
  }
  instance.emit = emit.bind(null, instance) as any
  return instance
}

function setupRenderEffect(instance: any, vnode: any, container: any) {
  effect(() => {
    if (!instance.isMounted) {
      // è¿™é‡Œå¤„ç†ç¬¬ä¸€æ¬¡è¢«æŒ‚è½½çš„é€»è¾‘
      const subTree = instance.render.call(instance.proxy)
      instance.subTree = subTree
      patch(null, subTree, container, instance)
      vnode.el = subTree.el
      instance.isMounted = true
    } else {
      // è¿™é‡Œå¤„ç†æ›´æ–°çš„é€»è¾‘
      // æ–°çš„vnode
      const subTree = instance.render.call(instance.proxy)
      // è€çš„vnode
      const prevSubTree = instance.subTree
      // å­˜å‚¨è¿™ä¸€æ¬¡çš„vnodeï¼Œä¸‹ä¸€æ¬¡æ›´æ–°é€»è¾‘ä½œä¸ºè€çš„vnode
      instance.subTree = subTree
      patch(prevSubTree, subTree, container, instance)
    }
  })
}
```

## element çš„ props æ›´æ–°

æˆ‘ä»¬è®²ä¸€ä¸‹å…ƒç´ çš„å±æ€§çš„æ›´æ–°ã€‚

æœ‰ä¸‰ç§æƒ…å†µéœ€è¦æˆ‘ä»¬å¤„ç†ï¼š

1. æ–°çš„ props å’Œæ—§çš„ props ä¸åŒï¼ˆæ–°å¢ï¼Œä¿®æ”¹ï¼‰
2. æ–°çš„ props è¢«èµ‹å€¼ä¸º null æˆ–è€… undefinedï¼ˆåˆ é™¤ï¼‰
3. æ—§çš„ props æœ‰äº›å±æ€§åœ¨æ–°çš„ props ä¸­æ²¡æœ‰ï¼ˆåˆ é™¤ï¼‰

[![X2VJHg.png](https://s1.ax1x.com/2022/06/12/X2VJHg.png)](https://imgtu.com/i/X2VJHg)

ç›®å‰æˆ‘ä»¬åªå¤„ç†å…ƒç´ çš„æƒ…å†µï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨`patch`ä¸­åªä¿®æ”¹`processElement`å†…éƒ¨çš„é€»è¾‘ã€‚

ç»™ patch ä¼ å…¥`n1`å’Œ`n2`ï¼Œå…¶ä¸­ n1 ä»£è¡¨æ—§çš„ vnodeï¼Œn2 ä»£è¡¨æ–°çš„ vnodeã€‚

```typescript
function patch(n1: any, n2: any, container: any, parentComponent: any) {
  // æ£€æŸ¥æ˜¯ä»€ä¹ˆç±»å‹çš„vnode
  const { type } = n2
  switch (type) {
    case Fragment:
      processFragment(n2, container, parentComponent)
      break
    case Text:
      processText(n2, container)
      break
    default: {
      if (n2.shapeFlag & ShapeFlags.ELEMENT) {
        processElement(n1, n2, container, parentComponent)
      } else if (n2.shapeFlag & ShapeFlags.STATEFUL_COMPONENT) {
        // æ˜¯ä¸€ä¸ªç»„ä»¶ï¼Ÿå¤„ç†vnodeæ˜¯ç»„ä»¶çš„æƒ…å†µ
        processComponent(n2, container, parentComponent)
      }
      break
    }
  }
}
```

å½“ n2 çš„ shapeFlag è¡¨ç¤ºå…ƒç´ çš„æ—¶å€™ï¼Œæˆ‘ä»¬åŒæ ·æŠŠ n1 å’Œ n2 ä¼ å…¥ processElement å‡½æ•°ã€‚

```typescript
// å¤„ç†å…ƒç´ çš„æƒ…å†µ
function processElement(
  n1: any,
  n2: any,
  container: any,
  parentComponent: any
) {
  if (!n1) {
    mountElement(n2, container, parentComponent)
  } else {
    patchElement(n1, n2, container)
  }
}
```

å…¶ä¸­éœ€è¦å¤„ç† n1 ä¸º null çš„æƒ…å†µï¼Œå³ç¬¬ä¸€æ¬¡æŒ‚è½½åˆ° dom ä¸Šçš„æƒ…å†µï¼Œå¦åˆ™å¯¹ n1 å’Œ n2 åšå¯¹æ¯” patchã€‚æˆ‘æŠŠå¯¹æ¯”çš„æ“ä½œæŠ½ç¦»æˆäº†ä¸€ä¸ªå‡½æ•° `patchElement`ã€‚

patchElement çš„å…·ä½“å®ç°å¦‚ä¸‹ï¼š

```typescript
function patchElement(n1: any, n2: any, container: any) {
  // è¿™é‡Œçš„EMPTY_OBJæ˜¯ä¸€ä¸ªç©ºå¯¹è±¡ï¼Œåœ¨shareFlags.tsä¸­å®šä¹‰ï¼šconst EMPTY_OBJ = {}
  const oldProps = n1.props || EMPTY_OBJ
  const newProps = n2.props || EMPTY_OBJ
  const el = (n2.el = n1.el)
  patchProps(el, oldProps, newProps)
}
```

åœ¨`patchProps()`å†…éƒ¨éå† n2ï¼ˆæ–°çš„ vnodeï¼‰çš„ propsï¼Œçœ‹çœ‹ n1 çš„ props å’Œ n2 çš„ props æ˜¯å¦ç›¸åŒã€‚

```typescript
// newPropså°±æ˜¯n2.props
// oldPropså°±æ˜¯n1.props
for (let key in newProps) {
  const newProp = newProps[key]
  const oldProp = oldProps[key]
  if (newProp !== oldProp) {
    patchProp(el, key, oldProp, newProp)
  }
}
```

`patchProp()`åœ¨ä¹‹å‰çš„ç¯‡ç« å·²ç»å‡ºç°è¿‡äº†ï¼Œå®ƒæ˜¯é€šè¿‡ DOM API å°† h å‡½æ•°çš„ propï¼ˆh å‡½æ•°çš„ç¬¬äºŒä¸ªå‚æ•°ï¼‰èµ‹å€¼ç»™çœŸå®çš„ dom å…ƒç´ ã€‚è¿™é‡Œæˆ‘å¯ä»¥é‡æ–°è´´ä¸€ä¸‹å…·ä½“çš„ä»£ç å®ç°ã€‚

```typescript
export function patchProp(el: any, key: string, oldValue: any, newValue: any) {
  // è¿™é‡Œå¤„ç†å±æ€§å€¼æœ‰å¤šä¸ªçš„æƒ…å†µï¼Œæ¯”å¦‚class="flex flex-column flex-grow-1"
  if (Array.isArray(newValue)) {
    el.setAttribute(key, newValue.join(' '))
  } else if (isOn(key) && isFunction(newValue)) {
    el.addEventListener(key.slice(2).toLowerCase(), newValue)
  } else {
    el.setAttribute(key, newValue)
  }
}
```

å…¶å®åˆ°è¿™é‡Œåå·²ç»å®ç°äº†ä¸‰ç§æƒ…å†µçš„ç¬¬ä¸€ç§äº†ï¼ˆæ–°å¢å’Œä¿®æ”¹ï¼‰

å½“ n2 çš„ props æœ‰å±æ€§å€¼æ˜¯ null æˆ–è€… undefined çš„æ—¶å€™ï¼Œæˆ‘ä»¬ä¹Ÿåº”è¯¥ç§»é™¤è¿™ä¸ªå±æ€§ã€‚æ­¤æ—¶æˆ‘ä»¬å¯ä»¥ä¿®æ”¹`patchProp`

```typescript
export function patchProp(el: any, key: string, oldValue: any, newValue: any) {
  if (Array.isArray(newValue)) {
    el.setAttribute(key, newValue.join(' '))
  } else if (isOn(key) && isFunction(newValue)) {
    // æ·»åŠ äº‹ä»¶
    el.addEventListener(key.slice(2).toLowerCase(), newValue)
  } else {
    // propså±æ€§çš„å±æ€§å€¼æ˜¯undefinedæˆ–è€…nullï¼Œåˆ é™¤è¯¥å±æ€§
    if (newValue === null || newValue === undefined) {
      el.removeAttribute(key)
    } else {
      el.setAttribute(key, newValue)
    }
  }
}
```

è¿™æ ·å°±æ˜¯å®ç°äº†ç¬¬äºŒç§æƒ…å†µäº†

æ¥ç€å› ä¸ºéœ€è¦æ£€æŸ¥ n1 çš„ props æ˜¯ä¸æ˜¯åœ¨ n2 çš„ props ä¸­è¢«åˆ é™¤äº†ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦éå† n1 çš„ propsï¼Œçœ‹çœ‹æ˜¯ä¸æ˜¯åœ¨ n2 çš„ props ä¸­ä¸å¤å­˜åœ¨ã€‚

```typescript
for (let key in oldProps) {
  // æ–°çš„propsæ²¡æœ‰è¯¥å±æ€§
  if (!(key in newProps)) {
    patchProp(el, key, oldProps[key], null)
  }
}
```

è¦æƒ³åˆ é™¤å±æ€§ï¼Œåªéœ€è¦ç»™ patchProp ä¼ å…¥ null å³å¯ï¼Œåœ¨å†…éƒ¨ä¼šè°ƒç”¨`el.removeAttribute`ã€‚

å¥½äº†ï¼Œä¸‰ç§æƒ…å†µéƒ½å·²ç»è§£å†³äº†ã€‚

## element çš„ children æ›´æ–°

element çš„ children æ›´æ–°æ¶‰åŠåˆ°ä»¥ä¸‹å››ç§æƒ…å†µï¼š

1. æ—§çš„å­èŠ‚ç‚¹æ˜¯ array ç±»å‹ ==> æ–°çš„å­èŠ‚ç‚¹æ˜¯ string ç±»å‹
2. æ—§çš„å­èŠ‚ç‚¹æ˜¯ string ç±»å‹ ==> æ–°çš„å­èŠ‚ç‚¹æ˜¯ string ç±»å‹
3. æ—§çš„å­èŠ‚ç‚¹æ˜¯ string ç±»å‹ ==> æ–°çš„å­èŠ‚ç‚¹æ˜¯ array ç±»å‹
4. æ—§çš„å­èŠ‚ç‚¹æ˜¯ array ç±»å‹ ==> æ–°çš„å­èŠ‚ç‚¹æ˜¯ array ç±»å‹

å½“ç„¶å…¶ä»–æƒ…å†µæ¯”å¦‚æ—§çš„å­èŠ‚ç‚¹æ˜¯ç©ºçš„ï¼Œæ–°çš„å­èŠ‚ç‚¹å¯èƒ½æ˜¯ç©ºçš„ã€‚

### ç¬¬ä¸€ç§æƒ…å†µï¼šå­èŠ‚ç‚¹ä»æ•°ç»„å˜ä¸ºå­—ç¬¦ä¸²

[![XOMoz4.png](https://s1.ax1x.com/2022/06/18/XOMoz4.png)](https://imgtu.com/i/XOMoz4)

> å…¶ä¸­`shapeFlag`æ˜¯åŒºåˆ† vnode çš„ä¸€ä¸ªæ ‡è¯†

ä»¥ä¸‹ä¸ºç”¨äºè§£å†³è¿™ç§å…ƒç´  children æ›´æ–°çš„æµ‹è¯• demo

```typescript
export const App = {
  name: 'app',
  setup() {},
  render() {
    // this.countè¿›è¡Œä¾èµ–æ”¶é›†ï¼Œ
    return h('div', {}, [
      h('p', {}, 'ä¸»é¡µ'),
      // æ—§çš„æ˜¯æ•°ç»„ æ–°çš„æ˜¯æ–‡æœ¬
      h(arrayToText),
    ])
  },
}
export default {
  name: 'arrayToText',
  setup() {
    const isChange = ref(false)
    // æŠŠrefå¯¹è±¡æŒ‚è½½åœ¨windowæ˜¯ä¸ºäº†æ–¹ä¾¿åœ¨å¤–éƒ¨æ”¹å˜refçš„å€¼
    window.isChange = isChange
    return {
      isChange,
    }
  },
  render() {
    return this.isChange
      ? h('div', {}, 'new text')
      : h('div', {}, [h('div', {}, 'A'), h('div', {}, 'B')])
  },
}
```

é¢„æœŸéœ€æ±‚ï¼š

å½“æˆ‘åœ¨ console ä¸­è¾“å…¥`isChange.value = true`ï¼Œç„¶ååœ¨æµè§ˆå™¨ä¸­æŸ¥çœ‹ç»“æœï¼Œä¼šå‘ç°å­èŠ‚ç‚¹ä»æ˜¾ç¤º'A'å’Œ'B'æ›´æ–°ä¸º'new text'ã€‚è¿™æ ·å°±èƒ½è¾¾åˆ°æ•°æ®é©±åŠ¨è§†å›¾çš„æ•ˆæœã€‚

ç”±äºä¹‹å‰å·²ç»å®ç°äº†`setupRenderEffect()`å†…éƒ¨çš„é€»è¾‘ï¼Œå¯ä»¥è®© ref æ›´æ–°çš„æ—¶å€™ï¼Œé‡æ–°æ‰§è¡Œ patch å‡½æ•°ã€‚æˆ‘ä»¬åªéœ€è¦åœ¨è°ƒç”¨`patchProps()`çš„åœ°æ–¹ä¸Šæ–°å¢å®ç°`patchChildren`å‡½æ•°

patchChildren å†…éƒ¨é€»è¾‘æ˜¯æ€æ ·çš„å‘¢ï¼Ÿ

å½“å­èŠ‚ç‚¹çš„ shapeFlag æ˜¯æ•°ç»„çš„æ—¶å€™ï¼Œéå†è¿™ä¸ªæ•°ç»„ï¼Œå¹¶ä¾æ¬¡ removeChild åšå¸è½½ï¼Œä¹‹åé€šè¿‡ textContent æŠŠæ–‡æœ¬æ›´æ–°ä¸Šå»ã€‚

```typescript
function patchChildren(n1: any, n2: any, container: any, parentComponent: any) {
  const prevShapeFlag = n1.shapeFlag
  const newShapeFlag = n2.shapeFlag
  const c1 = n1.children
  const c2 = n2.children
  if (newShapeFlag & ShapeFlags.TEXT_CHILDREN) {
    if (prevShapeFlag & ShapeFlags.ARRAY_CHILDREN) {
      // å¸è½½æ—§çš„å­èŠ‚ç‚¹
      unmountChildren(container)
      // è®¾ç½®å…ƒç´ æ–‡æœ¬
      setElementText(container, c2)
    }
  }
}
function unmountChildren(child: any) {
  for (let i = 0; i < child.length; i++) {
    remove(child[i])
  }
}
export function remove(child: HTMLElement) {
  // è¿™é‡Œä¸ºä»€ä¹ˆä¸ç›´æ¥ç”¨child.remove()å‘¢ï¼Ÿå¯ä»¥ç”¨ï¼Œä¸è¿‡è¿™æ ·å†™å…¼å®¹æ€§æ›´å¥½è€Œå·²
  const parent = child.parentNode
  if (parent) {
    parent.removeChild(child)
  }
}
// è®¾ç½®å…ƒç´ æ–‡æœ¬
export function setElementText(el: HTMLElement, text: string) {
  el.textContent = text
}
```

### ç¬¬äºŒç§æƒ…å†µï¼šå­èŠ‚ç‚¹ä»å­—ç¬¦ä¸²å˜ä¸ºæ•°ç»„

[![XOYrKU.png](https://s1.ax1x.com/2022/06/18/XOYrKU.png)](https://imgtu.com/i/XOYrKU)

ä»¥ä¸‹ä¸ºç”¨äºè§£å†³è¿™ç§å…ƒç´  children æ›´æ–°çš„æµ‹è¯• demo

```typescript
export const App = {
  name: 'app',
  setup() {},
  render() {
    return h('div', {}, [
      h('p', {}, 'ä¸»é¡µ'),
      // æ—§çš„æ˜¯æ–‡æœ¬ æ–°çš„æ˜¯æ•°ç»„
      h(textToArray),
    ])
  },
}
export default {
  name: 'textToArray',
  setup() {
    const isChange = ref(false)
    window.isChange = isChange
    return {
      isChange,
    }
  },
  render() {
    return this.isChange
      ? h('div', {}, [h('p', {}, 'pæ ‡ç­¾'), h('span', {}, 'spanæ ‡ç­¾')])
      : h('div', {}, 'old text')
  },
}
```

é¢„æœŸéœ€æ±‚ï¼š

è·Ÿæƒ…å†µä¸€æ­£å¥½ç›¸åï¼Œå½“æˆ‘åœ¨ console ä¸­è¾“å…¥`isChange.value = true`ï¼Œç„¶ååœ¨æµè§ˆå™¨ä¸­æŸ¥çœ‹ç»“æœï¼Œä¼šå‘ç°å­èŠ‚ç‚¹ä»æ˜¾ç¤º'old text'æ›´æ–°ä¸º'A'å’Œ'B'ã€‚è¿™æ ·å°±èƒ½è¾¾åˆ°æ•°æ®é©±åŠ¨è§†å›¾çš„æ•ˆæœã€‚

å®ç°æ€è·¯ï¼š

å…ˆæŠŠå­èŠ‚ç‚¹é‡æ–°é€šè¿‡ textContext è®¾ç½®ä¸ºç©ºå­—ç¬¦ä¸²ï¼Œå†é€šè¿‡å·²ç»å®ç°çš„ mountChildren å‡½æ•°ï¼ŒæŠŠæ–°çš„å­èŠ‚ç‚¹æŒ‚è½½ä¸Šå»ã€‚ä¸è¿‡åœ¨æ­¤ä¹‹å‰è¿˜æ˜¯è¦é€šè¿‡ shapeFlag åˆ¤æ–­ä¸€ä¸‹ vnode çš„ç±»å‹ã€‚

```typescript
// n1æ˜¯æ—§èŠ‚ç‚¹  n2æ˜¯æ–°èŠ‚ç‚¹
function patchChildren(n1: any, n2: any, container: any, parentComponent: any) {
  const prevShapeFlag = n1.shapeFlag
  const newShapeFlag = n2.shapeFlag
  const c1 = n1.children
  const c2 = n2.children
  // åˆ¤æ–­æ–°èŠ‚ç‚¹çš„shapeFlagæ˜¯å¦æ˜¯æ–‡æœ¬
  if (newShapeFlag & ShapeFlags.TEXT_CHILDREN) {
    // åˆ¤æ–­æ—§èŠ‚ç‚¹çš„shapeFlagæ˜¯å¦æ˜¯æ•°ç»„
    if (prevShapeFlag & ShapeFlags.ARRAY_CHILDREN) {
      // array to text
      unmountChildren(container)
      setElementText(container, c2)
    }
  } else {
    // text to array
    if (prevShapeFlag & ShapeFlags.TEXT_CHILDREN) {
      setElementText(container, '')
      // æŒ‚è½½æ–°çš„å­èŠ‚ç‚¹
      mountChildren(c2, container, parentComponent)
    }
  }
}
```

### ç¬¬ä¸‰ç§æƒ…å†µï¼šå­èŠ‚ç‚¹ä»æ—§çš„æ–‡æœ¬æ›´æ–°ä¸ºæ–°çš„æ–‡æœ¬

è¿™ç§æƒ…å†µç›¸å¯¹ç®€å•ï¼Œåªéœ€è¦åˆ¤æ–­ n1.children å’Œ n2.children æ˜¯ä¸æ˜¯ç›¸ç­‰çš„ï¼Œå¦‚æœä¸æ˜¯åˆ™åˆ©ç”¨ textContext æ›´æ–°æ–‡æœ¬å³å¯ã€‚ç›¸ç­‰å°±æ²¡å¿…è¦å¾€ä¸‹äº†ï¼ŒèŠ‚çœæ€§èƒ½ã€‚

[![XONPOO.png](https://s1.ax1x.com/2022/06/18/XONPOO.png)](https://imgtu.com/i/XONPOO) åŒæ—¶é’ˆå¯¹ä¸Šé¢çš„ patchChildren æˆ‘ä»¬å¯ä»¥ä¼˜åŒ–ä»¥ä¸‹é€»è¾‘ï¼š

```typescript
// n1æ˜¯æ—§èŠ‚ç‚¹ n2æ˜¯æ–°èŠ‚ç‚¹
function patchChildren(n1: any, n2: any, container: any, parentComponent: any) {
  const prevShapeFlag = n1.shapeFlag
  const newShapeFlag = n2.shapeFlag
  const c1 = n1.children
  const c2 = n2.children
  if (newShapeFlag & ShapeFlags.TEXT_CHILDREN) {
    if (prevShapeFlag & ShapeFlags.ARRAY_CHILDREN) {
      unmountChildren(container)
    }
    // åˆ¤æ–­æ˜¯å¦ç›¸ç­‰ï¼Œå•ç‹¬æŠŠ`setElementText`æ‹¿å‡ºæ¥ï¼Œå…¼å®¹äº†ç¬¬ä¸€ç§å’Œç¬¬ä¸‰ç§æƒ…å†µ
    if (c1 !== c2) {
      setElementText(container, c2)
    }
  } else {
    // text to array
    if (prevShapeFlag & ShapeFlags.TEXT_CHILDREN) {
      setElementText(container, '')
      mountChildren(c2, container, parentComponent)
    }
  }
}
```

ç¬¬å››ç§æƒ…å†µæ—§èŠ‚ç‚¹æ˜¯æ•°ç»„ï¼Œæ–°èŠ‚ç‚¹æ˜¯æ•°ç»„ï¼Œpatch çš„æ—¶å€™ç›¸å¯¹å¤æ‚æ¶‰åŠåˆ° vue çš„ diff ç®—æ³•ã€‚

## åŒç«¯å¯¹æ¯” diff ç®—æ³•

### å·¦ä¾§å¯¹æ¯”

å…ˆæ¥ä¸€å¼ å›¾ç»™å¤§å®¶çœ‹çœ‹ï¼Œå’±ä»¬å…ˆåˆ«çœ‹å³ä¾§çš„æµç¨‹å›¾ï¼ˆé‚£æ˜¯å…³äºå¾€å³ä¾§æ–°å¢èŠ‚ç‚¹çš„æµç¨‹ï¼‰

`å›¾1` [![jFbS3R.md.png](https://s1.ax1x.com/2022/06/25/jFbS3R.md.png)](https://imgtu.com/i/jFbS3R)

è§£æï¼š

c1ï¼šæ—§çš„å­èŠ‚ç‚¹çš„æ•°ç»„ï¼Œæ¯”å¦‚ï¼šæœ‰ Aã€B ä¸¤ä¸ªå…ƒç´ 

c2ï¼šæ–°çš„å­èŠ‚ç‚¹çš„æ•°ç»„ï¼Œæ¯”å¦‚ï¼šæœ‰ Aã€Bã€Cã€D å››ä¸ªå…ƒç´ 

iï¼šå¤´éƒ¨æŒ‡é’ˆï¼Œåˆå§‹ä¸º 0ï¼Œå°†ä¼šå‘å³ç§»åŠ¨

e1ï¼šæ—§èŠ‚ç‚¹æ•°ç»„çš„æŒ‡é’ˆï¼ŒæŒ‡é’ˆæŒ‡å‘æ•°ç»„æœ«å°¾ï¼Œåˆå§‹åŒ–å€¼ä¸º`c1.length - 1`

e2ï¼šæ–°èŠ‚ç‚¹æ•°ç»„çš„æŒ‡é’ˆï¼ŒæŒ‡é’ˆæŒ‡å‘æ•°ç»„æœ«å°¾ï¼Œåˆå§‹åŒ–å€¼ä¸º`c2.length - 1`

è¦æƒ³çŸ¥é“æœ‰å“ªäº›èŠ‚ç‚¹æ˜¯éœ€è¦è¢«æ–°å¢çš„ï¼Œé‚£ä¸å¾—éå†ä¸¤ä¸ªæ•°ç»„è¿›è¡Œæ¯”è¾ƒå˜›ï¼Œç›¸åŒå°±è¯æ˜ä¸éœ€è¦æ–°å¢ï¼Œä¸ç›¸åŒå°±è¯æ˜æ—§èŠ‚ç‚¹æ•°ç»„æ²¡æœ‰ï¼Œæ–°èŠ‚ç‚¹æ•°ç»„æœ‰çš„å…ƒç´ ï¼Œè¿™è¦æ–°å¢å…ƒç´ äº†ã€‚è¿™å°±å¼•å‡ºä¸€ä¸ªç´¢å¼•å€¼`i`ï¼Œé€šè¿‡ç´¢å¼•å€¼å¯ä»¥å¾—å‡ºè¦æ–°å¢å“ªäº›èŠ‚ç‚¹ä»¥åŠæ–°å¢èŠ‚ç‚¹çš„èŒƒå›´ã€‚æ¯”å¦‚ä¸Šå›¾ä¸­ï¼Œ`e1 < i <= e2`è¿™ä¸ªèŒƒå›´å°±æ˜¯éœ€è¦æ–°å¢èŠ‚ç‚¹çš„èŒƒå›´ã€‚i åœ¨ä»€ä¹ˆæ¡ä»¶ä¸‹ä¼šç§»åŠ¨å‘¢ï¼Ÿå½“ç„¶æ˜¯`c1[i]`å’Œ`c2[i]`æœ‰å€¼çš„æ—¶å€™å•Šï¼Œæ‰€ä»¥å½“`i<=e1 && i<=e2`ï¼Œè¦åˆ¤æ–­`c1[i]`å’Œ`c2[i]`æ˜¯å¦æ˜¯ç›¸åŒçš„ vnodeï¼Œå¦‚æœç›¸åŒå°±`i++`ï¼Œä¸‹ä¸€è½®å¾ªç¯çš„æ—¶å€™æ ¹æ®è¿™ä¸ªå·²è‡ªå¢çš„ i å–å¾— vnodeã€‚æœ‰è¿›è¡Œä¸‹ä¸€è½®çš„`æ¯”è¾ƒ`ã€‚

è€Œè¿™ä¸ªæ¯”è¾ƒæ–¹æ³•`isSameVNodeType()`çš„å®ç°å°±æ˜¯æ ¹æ® vnode çš„ type å±æ€§å’Œ key å±æ€§è¿›è¡Œæ¯”è¾ƒã€‚

```typescript
// n1æ˜¯æ—§çš„vnode n2æ˜¯æ–°çš„vnode è¿”å›boolean
function isSameVNodeType(n1: any, n2: any) {
  return n1.type === n2.type && n1.key === n2.key
}
```

æ‰€ä»¥ä¸ºä»€ä¹ˆ vue3 é‡Œé¢æ¸²æŸ“åˆ—è¡¨çš„æ—¶å€™ v-for åé¢è¦é¡ºä¾¿å®šä¹‰ keyï¼Œå°±æ˜¯ä¸ºäº†èƒ½ç²¾å‡†ç¡®å®šä¸¤ä¸ª vnode èŠ‚ç‚¹æ˜¯ä¸æ˜¯ç›¸åŒçš„ vnodeï¼Œä»è€Œæå‡æ¸²æŸ“æ—¶çš„æ€§èƒ½ã€‚

å¦‚æœå‘ç°ä¸¤ä¸ª vnode èŠ‚ç‚¹æ˜¯ç›¸åŒçš„èŠ‚ç‚¹ï¼Œé‚£ä¹ˆè°ƒç”¨ patch æ–¹æ³•ï¼Œå¦åˆ™ç›´æ¥è·³å‡ºå¾ªç¯ï¼Œæ‹¿åˆ°è¿™ä¸ª`i`å€¼ï¼Œè¿™ä¸ª i å€¼å°±æ˜¯è¦æ–°å¢èŠ‚ç‚¹çš„å¼€å§‹ç´¢å¼•å€¼ã€‚

```typescript
while (i <= e1 && i <= e2) {
  const n1 = c1[i] // æ—§çš„vnodeèŠ‚ç‚¹
  const n2 = c2[i] // æ–°çš„vnodeèŠ‚ç‚¹
  if (isSameVNodeType(n1, n2)) {
    patch(n1, n2, container, parentComponent, anchor)
  } else {
    break
  }
  i++
}
```

### å³ä¾§å¯¹æ¯”

`å›¾2` [![jkF0LF.md.png](https://s1.ax1x.com/2022/06/25/jkF0LF.md.png)](https://imgtu.com/i/jkF0LF)

å’Œå·¦ä¾§å¯¹æ¯”çš„æ–¹å‘ç›¸åï¼Œæ³¨æ„çš„æ˜¯ï¼šå³ä¾§å¯¹æ¯”ä¸å†ä»¥ i ä¸ºç´¢å¼•è·å– vnode èŠ‚ç‚¹ï¼Œè€Œæ˜¯ç”¨ e1 å’Œ e2 ä½œä¸ºç´¢å¼•è·å– vnodeï¼Œå¹¶ä¸”ä¸å†å¯¹ i è‡ªå¢ï¼Œåè€Œåˆ©ç”¨ e1 å’Œ e2 è‡ªå‡æ¥è·å–ä¸åŒçš„ vnode èŠ‚ç‚¹ã€‚ä½†æ˜¯åˆ¤æ–­æ¡ä»¶è¿˜æ˜¯ä¸€æ ·çš„`i <= e1 && i <= e2`ï¼Œi å§‹ç»ˆä¸º 0ã€‚

```typescript
while (i <= e1 && i <= e2) {
  const n1 = c1[e1]
  const n2 = c2[e2]
  if (isSameVNodeType(n1, n2)) {
    patch(n1, n2, container, parentComponent, anchor)
  } else {
    break
  }
  e1--
  e2--
}
```

å·¦ä¾§å¯¹æ¯”ç»“åˆå³ä¾§å¯¹æ¯”å°±èƒ½å¤„ç†ä»¥ä¸‹æƒ…å†µäº†ã€‚ [![jkEMM6.md.png](https://s1.ax1x.com/2022/06/25/jkEMM6.md.png)](https://imgtu.com/i/jkEMM6)

### æ–°å¢èŠ‚ç‚¹

æ–°å¢èŠ‚ç‚¹æˆ‘ä»¬ä½¿ç”¨[`Node.insertBefore()`](https://developer.mozilla.org/zh-CN/docs/Web/API/Node/insertBefore)ï¼Œç¬¬ä¸€ä¸ªå…¥å‚ç”¨äºæ’å…¥çš„èŠ‚ç‚¹ï¼Œç¬¬äºŒä¸ªå…¥å‚ç”¨äºæŒ‡å®šæ’åœ¨å“ªä¸ªèŠ‚ç‚¹ä¹‹å‰ï¼Œå¦‚æœå…¥å‚ä¸º nullï¼Œå°†ä¼šæ’å…¥çš„èŠ‚ç‚¹æ’å…¥åˆ°æœ«å°¾ã€‚

æˆ‘ä»¬å¯ä»¥åˆ©ç”¨ç¬¬äºŒä¸ªå…¥å‚ä¸º null æ¥å®ç°å³ä¾§æ·»åŠ èŠ‚ç‚¹ã€‚è‡³äºå¾€å·¦ä¾§æ·»åŠ èŠ‚ç‚¹æˆ‘ä»¬å¯ä»¥åœ¨ç¬¬äºŒä¸ªå‚æ•°å¡«ä¸Šå¯¹åº”çš„å¼•ç”¨èŠ‚ç‚¹å°±å¥½ã€‚

`å›¾1`ä¸­å¾ªç¯ä¸‹æ¥ iã€e1ã€e2 çš„å€¼åˆ†åˆ«æ˜¯ï¼š

```
i: 2
e1: 1
e2: 3
```

`å›¾2`ä¸­å¾ªç¯ä¸‹æ¥ iã€e1ã€e2 çš„å€¼åˆ†åˆ«æ˜¯ï¼š

```
i: 0
e1: -1
e2: 1
```

å¯ä»¥çœ‹å‡ºï¼ši å§‹ç»ˆå¤§äº e1ï¼Œå§‹ç»ˆå°äºç­‰äº e2

```typescript
if (i > e1) {
  if (i <= e2) {
    const nextPos = e2 + 1
    // c2[nextPos].el å°†ä¼šæ‹¿åˆ° Nodeå®ä¾‹ ï¼Œc2[nextPos]æ˜¯vnodeå¯¹è±¡
    const anchor = nextPos < c2.length ? c2[nextPos].el : null

    while (i <= e2) {
      // æ–°å¢
      patch(null, c2[i], container, parentComponent, anchor)
      i++
    }
  }
}

// æ ¸å¿ƒçš„æ–°å¢èŠ‚ç‚¹å‡½æ•°
export function insert(child: any, container: any, anchor: any = null) {
  container.insertBefore(child, anchor)
}
```

anchor æ˜¯ä½œä¸ºä¸€ä¸ªé”šç‚¹çš„å­˜åœ¨ï¼Œå½“å³ä¾§æ·»åŠ èŠ‚ç‚¹çš„æ—¶å€™ï¼Œå®ƒå°†ä¼šæ˜¯ nullï¼Œä¼šä¼ å…¥ insertBefore çš„ç¬¬äºŒä¸ªå‚æ•°ã€‚å½“éœ€è¦å·¦è¾¹æ·»åŠ èŠ‚ç‚¹çš„æ—¶å€™ï¼Œä»–å°†ä½œä¸ºè¢«æ’å…¥èŠ‚ç‚¹çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ã€‚è¿™é‡Œå¯èƒ½å¾ˆéš¾ç†è§£ï¼Œæˆ‘æ‰“ä¸ªæ¯”æ–¹ï¼š

`å›¾2`ä¸­éœ€è¦æˆ‘ä»¬æ’å…¥ C å’Œ D åˆ° A ä¹‹å‰ï¼Œé‚£ä¹ˆè¿™ä¸ª anchor é”šç‚¹å°±æ˜¯ Aã€‚å‰é¢ä¸¤ä¸ª while å¾ªç¯ï¼ˆåˆ†åˆ«æ˜¯å·¦ä¾§å¯¹æ¯”å’Œå³ä¾§å¯¹æ¯”ï¼‰èµ°å®Œä¹‹åï¼Œi è¿˜æ˜¯ 0ï¼Œe1 æ˜¯-1ï¼Œe2 æ˜¯ 1ã€‚æœ€å`nextPos = 2`ï¼Œ`nextPos < c2.length`è¿™ä¸ªåˆ¤æ–­è‡ªç„¶å°±èµ° true äº†ï¼Œè€Œ`c2[nextPos].el`å°±æ˜¯ Aã€‚

åœ¨ä¸‹ä¸€æ®µä»£ç  patch çš„æ—¶å€™ï¼Œå†…éƒ¨è°ƒç”¨ insertBefore å°±èƒ½æŠŠ Dã€C æ’å…¥åˆ° A ä¹‹å‰ï¼Œä»”ç»†ä½ ä¼šå‘ç°å…¶å®æ˜¯å…ˆæ’å…¥ D å†æ’å…¥ C çš„ ğŸ¤£ã€‚

ğŸ˜Ÿwhyï¼Ÿä¸ºä»€ä¹ˆæ˜¯å…ˆæ’å…¥ D å†æ’å…¥ C å‘¢ï¼Ÿ

å› ä¸º i ä¸º 0ï¼Œ`c2[i]`å–å¾—æ˜¯ c2 çš„ç¬¬ä¸€ä¸ªå…ƒç´ ï¼ˆDï¼‰è¿›è¡Œ patchï¼Œpatch å®Œä¹‹å i è‡ªå¢åŠ ä¸€ï¼Œè¿™æ—¶å€™æ‰å¼€å§‹å–ç¬¬äºŒä¸ªå…ƒç´ ï¼ˆCï¼‰è¿›è¡Œ patchã€‚

```typescript
while (i <= e2) {
  // æ–°å¢
  patch(null, c2[i], container, parentComponent, anchor)
  i++
}
```

### åˆ é™¤èŠ‚ç‚¹

[![jk1wVI.md.png](https://s1.ax1x.com/2022/06/25/jk1wVI.md.png)](https://imgtu.com/i/jk1wVI) å·¦ä¾§åˆ é™¤èŠ‚ç‚¹æ—¶ï¼šiã€e1ã€e2 çš„å€¼åˆ†åˆ«æ˜¯ï¼š

```
i: 2
e1: 3
e2: 1
```

å³ä¾§åˆ é™¤èŠ‚ç‚¹æ—¶ï¼šiã€e1ã€e2 çš„å€¼åˆ†åˆ«æ˜¯ï¼š

```
i: 0
e1: 1
e2: -1
```

å¯ä»¥çŸ¥é“è§„å¾‹ï¼šc1 çš„æ•°ç»„é•¿åº¦å¤§äº c2 çš„æ•°ç»„é•¿åº¦çš„æ—¶å€™ï¼Œéœ€è¦åˆ é™¤èŠ‚ç‚¹ã€‚åˆ é™¤çš„èŒƒå›´å°†ä¼šæ˜¯ï¼š`i > e2`çš„æ—¶å€™

```typescript
if (i > e2) {
  while (i <= e1) {
    remove(c1[i].el)
    i++
  }
}

// åˆ é™¤èŠ‚ç‚¹çš„æ ¸å¿ƒå‡½æ•°
// è¿™é‡Œå¯ä»¥æ¢æˆ child.remove()
export function remove(child: HTMLElement) {
  const parent = child.parentNode
  if (parent) {
    parent.removeChild(child)
  }
}
```

å³ä¾§åˆ é™¤èŠ‚ç‚¹ï¼Œåˆ é™¤çš„é¡ºåºæ˜¯ï¼šCã€D

å·¦ä¾§åˆ é™¤èŠ‚ç‚¹ï¼Œåˆ é™¤çš„é¡ºåºæ˜¯ï¼šAã€B

### è¿›å…¥çœŸæ­£çš„diffåœºæ™¯
diffæœ‰å‡ ä¸ªåœºæ™¯ï¼š
1. åˆ é™¤åœºæ™¯ï¼šæ—§èŠ‚ç‚¹çš„å­èŠ‚ç‚¹ä¸­é—´éƒ¨åˆ†ä¸­æŸä¸€ä¸ªèŠ‚ç‚¹åœ¨æ–°èŠ‚ç‚¹çš„å­èŠ‚ç‚¹ä¸­ä¸å­˜åœ¨ã€‚æ—§èŠ‚ç‚¹éœ€è¦åˆ é™¤è¯¥å­èŠ‚ç‚¹ã€‚
2. æ–°å¢åœºæ™¯ï¼šæ–°èŠ‚ç‚¹çš„å­èŠ‚ç‚¹ä¸­é—´éƒ¨åˆ†ä¸­æŸä¸€ä¸ªèŠ‚ç‚¹åœ¨æ—§èŠ‚ç‚¹çš„å­èŠ‚ç‚¹ä¸­ä¸å­˜åœ¨ã€‚æ—§èŠ‚ç‚¹éœ€è¦æ–°å¢è¯¥å­èŠ‚ç‚¹ã€‚
3. æ›´æ–°åœºæ™¯ï¼šæ—§èŠ‚ç‚¹çš„å­èŠ‚ç‚¹æŸä¸€ä¸ªèŠ‚ç‚¹åœ¨æ–°èŠ‚ç‚¹çš„å­èŠ‚ç‚¹ä¸­çŠ¶æ€å‘ç”Ÿæ”¹å˜äº†ã€‚æ—§èŠ‚ç‚¹éœ€è¦æ›´æ–°è¯¥å­èŠ‚ç‚¹ã€‚
4. ç§»åŠ¨åœºæ™¯ï¼šæ—§èŠ‚ç‚¹çš„å­èŠ‚ç‚¹æŸä¸€ä¸ªèŠ‚ç‚¹åœ¨æ–°èŠ‚ç‚¹çš„å­èŠ‚ç‚¹ä¸­ä½ç½®å‘ç”Ÿæ”¹å˜äº†ã€‚æ—§èŠ‚ç‚¹éœ€è¦ç§»åŠ¨è¯¥å­èŠ‚ç‚¹åˆ°ç›®æ ‡ä½ç½®ã€‚

å…ˆè€ƒè™‘åˆ é™¤å’Œæ›´æ–°çš„é€»è¾‘ï¼ˆäº¤æ¢ä½ç½®å’Œæ–°å¢èŠ‚ç‚¹é€»è¾‘å…ˆä¸è€ƒè™‘ï¼‰

è¿™é‡Œç»™ä¸€ä¸ªä¾‹å­ï¼š

[![jEZVvn.md.png](https://s1.ax1x.com/2022/06/26/jEZVvn.md.png)](https://imgtu.com/i/jEZVvn)

æˆ‘ä»¬æŠŠä¹‹å‰çš„å·¦ç«¯å¯¹æ¯”å’Œå³ç«¯å¯¹æ¯”ç»“åˆèµ·æ¥ï¼Œè®¡ç®—å‡º iã€e1ã€e2 çš„å€¼å°±èƒ½çŸ¥é“ä¸­é—´éƒ¨åˆ†çš„èŒƒå›´åœ¨å“ªäº†ã€‚

ä¸Šå›¾æ‰€ç¤ºï¼šä¸­é—´éƒ¨åˆ†çš„èŒƒå›´ï¼ši ~ e1ã€i ~ e2

ç›®å…‰èšç„¦åˆ° c1 å’Œ c2 çš„ä¸­é—´éƒ¨åˆ†ï¼Œéƒ½æœ‰ Cï¼Œä½†æ˜¯ C çš„ property å¹¶ä¸ç›¸åŒï¼Œä¸»è¦è¿˜æ˜¯ id ä¸ä¸€æ ·ï¼Œéœ€è¦ patchã€‚å†çœ‹ Dï¼ŒD åœ¨ c2 æ•°ç»„é‡Œé¢æ˜¯æ²¡æœ‰çš„ï¼Œæ‰€ä»¥ D éœ€è¦è¢«åˆ é™¤ã€‚

é‚£æ€ä¹ˆçŸ¥é“ c1 çš„å…ƒç´ åœ¨ c2 æœ‰æ²¡æœ‰å‘¢ï¼Ÿé‚£å°±éœ€è¦åŒé‡éå†äº†ï¼Œå…ˆéå† c1 çš„ä¸­é—´éƒ¨åˆ†ï¼Œæ‹¿åˆ° c1 çš„ç´¢å¼•å€¼å†éå† c2 çš„ä¸­é—´éƒ¨åˆ†ï¼Œæ‹¿ç€è¿™ä¸ª c1 çš„å…ƒç´ ä¾æ¬¡è·Ÿ c2 çš„å…ƒç´ è¿›è¡Œæ¯”è¾ƒï¼Œç¬¬ä¸€è½®æ¯”è¾ƒå®Œä¹‹åæ¥ç€æ‹¿ c1 çš„ä¸‹ä¸€ä¸ªå…ƒç´ è·Ÿ c2 çš„å…ƒç´ è¿›è¡Œæ¯”è¾ƒã€‚ä¸è¿‡è¿™æ ·åšçš„è¯æ—¶é—´å¤æ‚åº¦æ˜¯ O(n^2)ã€‚è¦æƒ³å¿«é€Ÿæ‰¾åˆ° c1 çš„å…ƒç´ å¯¹åº”å† c2 ä¸Šæœ‰æ²¡æœ‰ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨æ˜ å°„æŸ¥æ‰¾çš„æ–¹å¼ï¼ˆMapï¼‰ã€‚

å…ˆæŠŠ c2 çš„ä¸­é—´éƒ¨åˆ†çš„æ¯ä¸€ä¸ªå…ƒç´ çš„ç´¢å¼•å€¼éƒ½å­˜å…¥ä¸€ä¸ª Map ä¸­ã€‚å½“éå† c1 çš„æ—¶å€™ï¼Œé¦–å…ˆå» Map æŸ¥æ‰¾çœ‹çœ‹æœ‰æ²¡æœ‰å¯¹åº”çš„å…ƒç´ ã€‚å¦‚æœæœ‰å€¼ï¼Œç›´æ¥èµ° patchï¼Œå¦‚æœæ²¡æœ‰å€¼ï¼Œæ‰ç”¨ä¸Šé¢æ‰€è¯´çš„åŒé‡éå†çš„æ–¹å¼æŸ¥æ‰¾ï¼Œè¿˜æ˜¯æ²¡æœ‰æŸ¥æ‰¾åˆ°åœ¨ c2 å¯¹åº”çš„å…ƒç´ å‘¢ï¼Ÿè¯´æ˜è¯¥å…ƒç´ æ˜¯éœ€è¦è¢«åˆ é™¤çš„ã€‚å½“ç„¶å¦‚æœæŸ¥æ‰¾åˆ°äº†è¿˜æ˜¯èµ° patchã€‚è¿™æ ·æ—¶é—´å¤æ‚åº¦å°±ä» O(n^2)å˜æˆ O(1)äº†ã€‚è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆåˆ—è¡¨æ¸²æŸ“çš„æ—¶å€™æˆ‘ä»¬å¿…é¡»ç»™å…ƒç´ æ·»åŠ ä¸€ä¸ªå”¯ä¸€å€¼ key æå‡æ¸²æŸ“æ€§èƒ½

```typescript
// å¤„ç†ä¸­é—´éƒ¨åˆ†
// a b (c d) e f
// a b (e c) e f
let s1 = i
let s2 = i
// ä¸ºäº†èƒ½ä½¿ç”¨æ˜ å°„æŸ¥æ‰¾æ–¹å¼éœ€è¦çš„mapå®¹å™¨ï¼Œæé«˜patchçš„æ•ˆç‡
const keyToNewIndexMap = new Map()
// éå†c2ä¸­é—´éƒ¨åˆ†
for (let i = s2; i <= e2; i++) {
  const nextChild = c2[i]
  keyToNewIndexMap.set(nextChild.key, i)
}
// éå†c1ä¸­é—´éƒ¨åˆ†ï¼Œæ‰¾å‡ºc1åœ¨c2å¯¹åº”çš„å…ƒç´ ï¼Œå¦‚æœæ‰¾ä¸åˆ°ï¼Œå°±åˆ é™¤ï¼Œæ‰¾åˆ°äº†å°±æ›´æ–°èµ°patch
// éå†æ—§èŠ‚ç‚¹
for (let i = s1; i <= e1; i++) {
  const prevChild = c1[i]
  let nextIndex

  if (prevChild.key != null) {
    nextIndex = keyToNewIndexMap.get(prevChild.key)
  } else {
    for (let j = s2; j <= e2; j++) {
      if (isSameVNodeType(prevChild, c2[j])) {
        nextIndex = j
        break
      }
    }
  }
  if (nextIndex === undefined) {
    hostRemove(prevChild.el)
  } else {
    patch(prevChild, c2[nextIndex], container, parentComponent, null)
  }
}
```

Map å®é™…ä¸Šç”¨ vnode.key ä½œä¸ºé”®å»å­˜å‚¨ c2 å…ƒç´ çš„ç´¢å¼•å€¼ï¼Œè¿™ä¸ª vnode.key å°±æ˜¯ä¸Šé¢ä»£ç ä¸­çš„`nextChild.key`å’Œ`prevChild.key`ï¼Œè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆåˆ—è¡¨æ¸²æŸ“çš„æ—¶å€™æˆ‘ä»¬å¿…é¡»ç»™å…ƒç´ æ·»åŠ ä¸€ä¸ªå”¯ä¸€å€¼ key æå‡æ¸²æŸ“æ€§èƒ½ã€‚

### åˆ é™¤é€»è¾‘çš„ä¼˜åŒ–ç‚¹ï¼š

ä¸Šé¢çš„ä»£ç å°±æ˜¯åˆ é™¤èŠ‚ç‚¹å’Œæ›´æ–°èŠ‚ç‚¹çš„é€»è¾‘äº†ï¼Œå…¶ä¸­ä¹Ÿæœ‰ä¸€ä¸ªå¯ä»¥ä¼˜åŒ–çš„ç‚¹ï¼Œé‚£å°±æ˜¯å½“çŸ¥é“ c2 ä¸­çš„å…ƒç´ éƒ½å·²ç»è¢«æ¯”è¾ƒè¿‡äº†ä»¥åï¼Œc1 ä¸­å‰©ä½™çš„å…ƒç´ å°±æ²¡å¿…è¦å¤„ç†äº†ï¼Œç›´æ¥åˆ é™¤ï¼Œæé«˜äº†æ€§èƒ½ã€‚ [![jEVbND.md.png](https://s1.ax1x.com/2022/06/26/jEVbND.md.png)](https://imgtu.com/i/jEVbND)

å¦‚å›¾ï¼Œçº¢è‰²éƒ¨åˆ†ä¸ºæ–°å¢ä»£ç ã€‚

æˆ‘ä»¬éœ€è¦å®šä¹‰ä¸¤ä¸ªå˜é‡ï¼š

```
toBePatchedï¼šè¡¨ç¤ºéœ€è¦patchçš„å…ƒç´ çš„æ•°é‡
patchedï¼šè¡¨ç¤ºå·²ç»patchçš„å…ƒç´ çš„æ•°é‡
```


å·²ç»æ‰§è¡Œäº†patchå¤„ç†çš„æ—¶å€™ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠpatchedè‡ªå¢åŠ ä¸€ï¼Œå½“`patched >= toBePatched`æ—¶ï¼Œä¹Ÿå°±æ˜¯è¯´è¯¥ patch çš„éƒ½å·²ç» patch å®Œäº†ï¼Œé‚£å‰©ä¸‹ c1 çš„å…ƒç´ å¹²å˜›ç®¡ä»–å‘¢ï¼Œéƒ½è®¤å®šä¸º c2 ä¸­æ²¡æœ‰çš„å…ƒç´ ï¼Œä»£è¡¨è¦åˆ é™¤çš„å…ƒç´ ï¼Œç›´æ¥ remove æ‰å°±å¥½äº†ã€‚ä¹‹åçš„æµç¨‹ä¸å¿…å¾€ä¸‹èµ°äº†ç›´æ¥è¿›å…¥ä¸‹ä¸€è½®å¾ªç¯ã€‚



```typescript
let s1 = i
let s2 = i
// æ–°å¢
let toBePatched = e2 - s2 + 1
let patched = 0
const keyToNewIndexMap = new Map()
// éå†c2ä¸­é—´éƒ¨åˆ†
for (let i = s2; i <= e2; i++) {
  const nextChild = c2[i]
  keyToNewIndexMap.set(nextChild.key, i)
}
for (let i = s1; i <= e1; i++) {
  const prevChild = c1[i]
  let newIndex
  // å¦‚æœè¯¥patchçš„éƒ½å·²ç»patchå®Œäº†ï¼Œä¹‹åçš„å…ƒç´ ç›´æ¥removeæ‰
  if (patched >= toBePatched) {
    hostRemove(prevChild.el)
    continue
  }
  if (prevChild.key != null) {
    newIndex = keyToNewIndexMap.get(prevChild.key)
  } else {
    for (let j = s2; j <= e2; j++) {
      if (isSameVNodeType(prevChild, c2[j])) {
        newIndex = j
        break
      }
    }
  }
  if (newIndex === undefined) {
    hostRemove(prevChild.el)
  } else {
    patch(prevChild, c2[newIndex], container, parentComponent, null)
    // è¢«patchedçš„æ•°é‡ +1
    patched++
  }
}
```
### ç§»åŠ¨èŠ‚ç‚¹é€»è¾‘

[![jMy4oD.md.png](https://s1.ax1x.com/2022/07/01/jMy4oD.md.png)](https://imgtu.com/i/jMy4oD)

ä¸Šå›¾æ˜¯diffç®—æ³•ä¸­éœ€è¦å¤„ç†çš„èŠ‚ç‚¹çš„ä½ç½®å˜æ›´åœºæ™¯ï¼Œé€šå¸¸æˆ‘ä»¬è¯´çš„diffçš„èŠ‚ç‚¹ç§»åŠ¨é€»è¾‘ã€‚

å›¾ä¸­Eè¢«ç§»åŠ¨åˆ°äº†Cã€Dçš„å‰é¢ï¼Œè€ŒCã€Dä¹Ÿè·Ÿç€å‘ç”Ÿä½ç½®çš„å˜æ¢ï¼Œå¦‚æœæˆ‘ä»¬æ€è€ƒç§»åŠ¨é€»è¾‘è¯¥æ€ä¹ˆå®ç°çš„è¯ï¼Œæˆ‘ä»¬ä¼šå¾ˆè‡ªç„¶çš„æƒ³åˆ°ï¼Œéå†c2ï¼Œè®©c2çš„æ¯ä¸€ä¸ªå…ƒç´ å’Œc1çš„å…ƒç´ è¿›è¡Œæ¯”è¾ƒï¼Œçœ‹çœ‹ä½ç½®æ˜¯å¦å‘ç”Ÿå˜åŒ–ï¼Œå‘ç”Ÿå˜åŒ–å°±ç§»åŠ¨åˆ°æ–°ä½ç½®ã€‚ä½†æ˜¯ï¼è¿™ç§ç§»åŠ¨é€»è¾‘çœŸçš„å¤ªæ¶ˆè€—æ€§èƒ½äº†ï¼Œæ‰¾è¿™æ ·çš„é€»è¾‘ï¼Œå°±éœ€è¦ç§»åŠ¨ä¸‰éï¼Œæ‰§è¡Œä¸‰æ¬¡`insertBefore`ã€‚

æˆ‘ä»¬ä¸å¦¨æ¢ä¸€ç§é€»è¾‘ï¼Œä»”ç»†è§‚å¯Ÿï¼ŒCã€Då®ƒä»¬ä¹‹é—´çš„å…³ç³»å¹¶æ²¡æœ‰å‘ç”Ÿæ”¹å˜ï¼ŒCã€Dæ’åˆ—é¡ºåºä¸å˜ï¼Œåªæ˜¯Eè¢«ç§»åŠ¨åˆ°äº†Cã€Dçš„å‰é¢ï¼Œé‚£æˆ‘ä»¬åªéœ€è¦å¯¹Eæ‰§è¡Œä¸€æ¬¡`insertBefore`å°±å¥½äº†å•Šã€‚

> é‚£æ€ä¹ˆç¡®å®šæˆ‘ä»¬è¦ç§»åŠ¨çš„æ˜¯Eå‘¢ï¼Ÿè€Œä¸æ˜¯Cæˆ–è€…Då‘¢ï¼Ÿæ¢è¨€ä¹‹ï¼Œå“ªäº›æ˜¯éœ€è¦è¢«ç§»åŠ¨çš„ï¼Œå“ªäº›æ˜¯ä¸éœ€è¦ç§»åŠ¨çš„ï¼Ÿ

é¦–å…ˆæˆ‘ä»¬å¯ä»¥ç»™c1çš„ä¸­é—´éƒ¨åˆ†çš„èŠ‚ç‚¹æ·»åŠ ä¸€ä¸ªç´¢å¼•ï¼ˆå…³äºæ€ä¹ˆç¡®å®šä¸­é—´éƒ¨åˆ†å°±æ˜¯é€šè¿‡iï¼Œe1ï¼Œe2è¿™äº›æŒ‡é’ˆæ¥ç¡®å®šiçš„å˜åŒ–èŒƒå›´ï¼‰

```
ç´¢å¼• 2 3 4
    C D E


    
```


```typescript
```
### æ–°å¢èŠ‚ç‚¹é€»è¾‘


### ä½¿ç”¨movedæ ‡è¯†ç¬¦ä¼˜åŒ–æ€§èƒ½ 
