# ğŸš€ isReactive & isReadonly ä¸”åˆ©ç”¨Jestæµ‹è¯•å®ç°æ•°æ®å“åº”å¼ï¼ˆä¸€ï¼‰

> å±±ä¸åœ¨é«˜ï¼Œæœ‰ä»™åˆ™åã€‚æ°´ä¸åœ¨æ·±ï¼Œæœ‰é¾™åˆ™çµã€‚ â€”â€” åˆ˜ç¦¹é”¡ã€Šé™‹å®¤é“­ã€‹


## å‰è¨€
ä¸Šç¯‡å¯¹reactive & effectçš„è¡¥å……æš‚å‘Šä¸€æ®µè½ï¼Œè¿˜æ²¡çœ‹è¿‡ä¸Šä¸€ç¯‡çš„çœ‹è¿™é‡ŒğŸ‰
> [ğŸš€ reactive & effect ä¸”åˆ©ç”¨Jestæµ‹è¯•å®ç°æ•°æ®å“åº”å¼ï¼ˆä¸€ï¼‰](https://juejin.cn/post/7089244580394041375)
> 
> [ğŸš€ reactive & effect ä¸”åˆ©ç”¨Jestæµ‹è¯•å®ç°æ•°æ®å“åº”å¼ï¼ˆäºŒï¼‰](https://juejin.cn/post/7090165509735317534)

æ•´ç¯‡æ–‡ç« çš„é€šè¿‡`TDD`æµ‹è¯•é©±åŠ¨å¼€å‘ï¼Œå¸¦ä½ ä¸€æ­¥ä¸€æ­¥å®ç°vue3æºç ï¼Œæ–‡ç« çš„æœ€åè¿˜æœ‰å®Œæ•´ä»£ç å“¦ã€‚

æœ¬ç¯‡æ–‡ç« å†…å®¹åŒ…æ‹¬ï¼š
1. è®²è§£Readonlyçš„å®ç°ä»¥åŠå¯¹å·²æœ‰ä»£ç çš„é‡æ„
2. è®²è§£isReactiveçš„å®ç°æ€è·¯
3. è®²è§£isReadonlyçš„å®ç°æ€è·¯
4. æºæ•°æ®å¯¹è±¡åµŒå¥—ç»“æ„çš„ä»£ç†å¯¹è±¡

## å®ç° Readonly

ä¸Šç¯‡æ–‡ç« æˆ‘ä»¬å·²ç»å®ç°äº†`reactive`ï¼Œå…¶å®`readonly`æ˜¯`reactive`çš„ä¸€ç§ç‰¹æ®Šæƒ…å†µï¼Œåªä¸è¿‡æ˜¯åªè¯»çš„ã€‚å®ƒä¹Ÿæ˜¯è¿”å›ä¸€ä¸ª`proxy`å¯¹è±¡ï¼Œå¹¶æ²¡æœ‰setæ“ä½œï¼Œæ‰€ä»¥readonlyå¹¶æ²¡æœ‰ä¾èµ–è§¦å‘ï¼Œæ—¢ç„¶æ²¡æœ‰ä¾èµ–è§¦å‘ï¼Œé‚£ä¹ˆå®ƒä¹Ÿä¸éœ€è¦getæ“ä½œçš„ä¾èµ–æ”¶é›†ã€‚

å…ˆçœ‹çœ‹æˆ‘ä»¬çš„`readonly`æµ‹è¯•ç”¨ä¾‹ï¼š
```typescript
describe('readonly', () => {
  it('readonly not set', () => {
    let original = {
      foo: {
        fuck: {
          name: "i don't care",
        },
      },
      arr: [{color: '#fff'}]
    }
    let warper = readonly(original)
    expect(warper).not.toBe(original)
    expect(warper.foo.fuck.name).toBe("i don't care")
  })
  it('warning when it be call set operation', () => {
    let original = {
      username: 'ghx',
    }
    let readonlyObj = readonly(original)
    const warn = jest.spyOn(console, 'warn')
    // ç»™readonlyåšsetæ“ä½œï¼Œå°†ä¼šå¾—åˆ°ä¸€ä¸ªwarning
    readonlyObj.username = 'danaizi'
    expect(warn).toHaveBeenCalled()
  })
})
```

å¦‚æœç¡¬è¦ç»™`reactive`çš„ä»£ç†å¯¹è±¡èµ‹å€¼ï¼Œé‚£ä¹ˆå®ƒå°†å¾—åˆ°ä¸€ä¸ªè­¦å‘Š(warn)
```typescript
export function readonly<T>(target: T) {
  return new Proxy(target, {
    get(target, key) {
      let res = Reflect.get(target, key)
      // æ— éœ€ä¾èµ–æ”¶é›†ï¼Œåˆ é™¤äº†track()å‡½æ•°
      return res
    },
    set(target, key, value) {
      // æ— éœ€è§¦å‘ä¾èµ–
      console.warn(`${target} do not set ${String(key)} value ${value}, because it is readonly`)
      return true
    },
  })
}
```
### å¯¹å·²æœ‰ä»£ç çš„é‡æ„
ä¹‹å‰æˆ‘ä»¬å·²ç»å®ç°äº† `reactive` å’Œ `readonly`ï¼Œè¿™æ—¶å€™æˆ‘ä»¬åº”è¯¥åè§‚ä¸€ä¸‹ä»£ç ï¼Œè§‚å¯Ÿä»£ç æœ‰æ²¡æœ‰é‡å¤çš„ä»£ç æ®µæ˜¯éœ€è¦æˆ‘ä»¬å»ä¼˜åŒ–çš„ã€‚ ç›®å‰çš„ä¸è¶³ï¼š`reactive` å’Œ `readonly` éƒ½æœ‰ç›¸ä¼¼çš„å®ç°ï¼Œç›¸åŒçš„ä»£ç æ®µè¾ƒå¤šï¼Œå¯ä»¥æŠ½ç¦»å‡ºæ¥
ç®€è¿°ï¼š
1. `reactive` å’Œ `readonly`çš„ä¼ å…¥ç›¸åŒçš„å…¥å‚`target`
2. `reactive` å’Œ `readonly`éƒ½è¿”å›proxyå¯¹è±¡
3. `reactive` å’Œ `readonly`çš„proxyå¯¹è±¡éƒ½æœ‰getå’Œsetæ–¹æ³•ï¼Œä½†æ˜¯å†…éƒ¨çš„ä»£ç å®ç°æœ‰ç‚¹ä¸åŒ

ä¸ºäº†ç»Ÿä¸€å¤„ç†è¿™äº›ç›¸åŒçš„ä»£ç é€»è¾‘ï¼Œæˆ‘ä»¬ä¸å¦¨æ–°å»ºæ–‡ä»¶`baseHandlers.ts`ä½œä¸º`Proxy`çš„ç¬¬äºŒå…¥å‚handlerçš„å®šä¹‰æ–‡ä»¶ï¼Œåˆå› ä¸ºè¿”å›çš„éƒ½æ˜¯`new Proxy()`å¯¹è±¡ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥å®šä¹‰ä¸€ä¸ª`createReactiveObject`å‡½æ•°ï¼Œç”¨äºç»Ÿä¸€åˆ›å»ºproxyå¯¹è±¡ï¼Œå¢å¼ºä»£ç çš„å¯è¯»æ€§ã€‚
```typescript
// In baseHandlers.ts
export function createReactiveObject<T extends object>(target: T, handlers: ProxyHandler<T>) {
  return new Proxy(target, handlers)
}
```
```typescript
// In reactive.ts

export function reactive<T extends object>(target: T) {
  return createReactiveObject<T>(target, mutableHandlers)
}
// å…¶å®å°±æ˜¯ä¸€ä¸ªæ²¡æœ‰setæ“ä½œçš„reactive
export function readonly<T extends object>(target: T) {
  return createReactiveObject<T>(target, readonlyHandlers)
}
```
handlersé€šè¿‡ä½œä¸ºå¯¹è±¡ç»Ÿä¸€ä¼ å…¥`createReactiveObject`ï¼Œè¿™æ ·å°±å¯ä»¥ç»Ÿä¸€å¤„ç†`reactive`å’Œ`readonly`çš„ä¸åŒé€»è¾‘ã€‚
```typescript
export const mutableHandlers: ProxyHandler<object> = {
  get: function(target: T, key: string | symbol) {
    let res = Reflect.get(target, key)
    // ä¾èµ–æ”¶é›†
    track(target, key as string)
    return res
  },
  set: function(target: T, key: string | symbol, value: any) {
    let success: boolean
    success = Reflect.set(target, key, value)
    // è§¦å‘ä¾èµ–
    trigger(target, key as string)
    return success
  },
}
export const readonlyHandlers: ProxyHandler<object> = {
  get: function(target: T, key: string | symbol) {
    let res = Reflect.get(target, key)
    return res
  },
  set(target, key, value) {
    console.warn(`${target} do not set ${String(key)} value ${value}, because it is readonly`)
    return true
  },
}
```
ä»”ç»†è§‚å¯Ÿä¸Šé¢çš„ä»£ç ï¼Œæˆ‘ä»¬éƒ½æœ‰ç›¸åŒçš„setå’Œgetï¼Œå†…éƒ¨åŒæ ·å®ç°äº†å–å€¼æ“ä½œï¼Œä½†æœ‰æ‰€ä¸åŒçš„æ˜¯readonlyçš„setæ“ä½œä¼šæŠ›å‡ºwarnï¼Œè¿™ä¸€ç‚¹æˆ‘ä»¬å¯ä»¥ä¸éœ€è¦å¤„ç†ã€‚ä¸ºäº†åŒºåˆ†`reactive`å’Œ`readonly`setå’Œgetçš„ä¸åŒé€»è¾‘ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªæ ‡è¯†`isReadonly`

æŠ½ç¦»ç›¸åŒçš„setå’Œgetä»£ç ï¼Œæˆ‘ä»¬å¤–éƒ¨éœ€è¦å®šä¹‰setå’Œgetå‡½æ•°ï¼Œä½†æ˜¯æˆ‘ä»¬éœ€è¦ä¼ å…¥ä¸€ä¸ªæ ‡è¯†`isReadonly`åŒºåˆ†è¯¥å‡½æ•°åˆ°åº•æ˜¯`reactive`çš„ä»£ç é€»è¾‘è¿˜æ˜¯`readonly`çš„ä»£ç é€»è¾‘ï¼ŒåŒæ—¶ä¸èƒ½ä¸º`set`å’Œ`get`æ–°å¢å…¶ä»–çš„å…¥å‚ä»¥é˜²ç ´åä»£ç çš„å¯è¯»æ€§ã€‚
æˆ‘ä»¬å¯ä»¥å®šä¹‰ä¸€ä¸ªé«˜é˜¶å‡½æ•°ï¼Œè¯¥å‡½æ•°è¿”å›setå’Œsetå‡½æ•°ï¼Œå…¥å‚æ˜¯`isReadonly`ã€‚
```typescript
// In baseHandlers.ts
// é«˜é˜¶å‡½æ•°ï¼ŒisReadonlyé»˜è®¤ä¸ºfalse
export function createGetter<T extends object>(isReadonly = false) {
  return function get(target: T, key: string | symbol) {
    
    let res = Reflect.get(target, key)
    
    if (!isReadonly) {
      // åˆ¤æ–­æ˜¯å¦readonly
      // ä¾èµ–æ”¶é›†
      track(target, key as string)
    }
    return res
  }
}
export function createSetter<T extends object>() {
  return function set(target: T, key: string | symbol, value: any) {
    let success: boolean
    success = Reflect.set(target, key, value)
    // è§¦å‘ä¾èµ–
    trigger(target, key as string)
    return success
  }
}
```
ä¹‹åå®šä¹‰ä¸åŒçš„handlerså¯¹è±¡ï¼Œç”¨äºä½œä¸ºå…¥å‚ä¼ å…¥`createReactiveObject`
```typescript
// reactiveçš„handlers
export const mutableHandlers: ProxyHandler<object> = {
  get: createGetter(),
  set: createSetter(),
}
// readonlyçš„handlers
export const readonlyHandlers: ProxyHandler<object> = {
  get: createGetter(true),
  set(target, key, value) {
    console.warn(`${target} do not set ${String(key)} value ${value}, because it is readonly`)
    return true
  },
}
```
æ­¤å¤„æ¥è—äº†ä¸€ä¸ªä¼˜åŒ–ç‚¹

## å®ç° isReadonly

ğŸ§ å¤§å®¶æ€è€ƒä¸€ä¸‹æˆ‘ä»¬ä»¥å½“å‰çš„ä»£ç æ¥çœ‹ï¼Œç”¨ä»€ä¹ˆæ¥åˆ¤æ–­ä¸€ä¸ªä»£ç†å¯¹è±¡æ˜¯å¦`readonly`ï¼Ÿ

ç­”æ¡ˆå°±æ˜¯`createGetter`çš„å…¥å‚ `isReadonly`ï¼Œè§‚å¯Ÿä¹‹å‰å¯¹readonlyçš„å®ç°å¯ä»¥çŸ¥é“ï¼Œè®©æºæ•°æ®é€šè¿‡ProxyåŒ…è£…ä¹‹åï¼Œå°±å·²ç»åœ¨handlerçš„getæ“ä½œä¸­å¾—çŸ¥è¯¥ä»£ç†å¯¹è±¡æ˜¯å¦ä¸º`readonly`ä»£ç†å¯¹è±¡äº†ã€‚



æ—¢ç„¶åœ¨getæ“ä½œä¸­æ‰èƒ½å¾—åˆ°`isReadonly`ï¼Œæˆ‘ä»¬ä¸å¦¨è§¦å‘ä¸€ä¸‹getæ“ä½œå§ã€‚

è§¦å‘getæ“ä½œæœ‰ä¸€ä¸ªå‰æï¼Œé‚£å°±æ˜¯é€šè¿‡è®¿é—®ä»£ç†å¯¹è±¡çš„å±æ€§å°±èƒ½è§¦å‘getæ“ä½œã€‚ä½ å¯èƒ½ä¼šè¯´æˆ‘ä»¬éšä¾¿è®¿é—®è¿™ä¸ªä»£ç†çš„å¯¹è±¡çš„å·²çŸ¥å±æ€§å°±å¯ä»¥è§¦å‘getæ“ä½œï¼Œç„¶åreturnæ˜¯å¦ä¸ºreadonlyçš„ç»“æœä¸å°±è¡Œäº†å—ï¼Ÿä½†æ˜¯å¦‚æœç”¨æˆ·çœŸçš„åªæƒ³è®¿é—®è¿™ä¸ªä»£ç†å¯¹è±¡çš„å±æ€§å¹¶ä¸æƒ³çŸ¥é“ä½ åˆ°åº•æ˜¯`readonly`è¿˜æ˜¯`reactive`ï¼Œè¿™ä¸å°±å‡ºç°bugäº†å—

ä¸ºæ­¤æˆ‘ä»¬éœ€è¦æé€ ä¸€ä¸ªä¸€ä¸ªä»£ç†å¯¹è±¡ä¸å­˜åœ¨çš„å±æ€§ï¼Œå°±å«`__v_isReadonly`

å®šä¹‰ä¸€ä¸ªå‡½æ•°`isReadonly`ï¼Œç”¨äºåˆ¤æ–­ä¸€ä¸ªä»£ç†å¯¹è±¡æ˜¯å¦ä¸º`readonly`ä»£ç†å¯¹è±¡ï¼Œè¯¥å‡½æ•°é€šè¿‡è§¦å‘ä»£ç†å¯¹è±¡çš„getæ“ä½œï¼Œè¿”å›ä¸€ä¸ªå¸ƒå°”å€¼ã€‚



```typescript
// ç»™valueåšç±»å‹æ‰¹æ³¨ï¼Œè®©valueæœ‰ä»¥ä¸‹å‡ ä¸ªå¯é€‰å±æ€§,ä¸ç„¶è¯¥æ­»çš„valueé£˜çº¢ --isReactiveå‡½æ•°å’ŒisReadonlyå‡½æ•°  è¯´çš„å°±æ˜¯ä½ ä»¬
export interface Target {
  __v_isReadonly?: boolean;
}
export function isReadonly(value: unknown){
  return (value as Target)['__v_isReadonly']
}
```
å¦å¤–ï¼Œæœ‰äº†`__v_isReadonly`å±æ€§ï¼Œæˆ‘ä»¬å°±çŸ¥é“ç”¨æˆ·æ˜¯æƒ³é€šè¿‡getæ“ä½œåˆ¤æ–­ä»£ç†å¯¹è±¡æ˜¯å¦æ˜¯`readonly`ï¼Œè¿˜æ˜¯æƒ³é€šè¿‡getæ“ä½œè®¿é—®æŒ‡å®šçš„å±æ€§å€¼ã€‚

æˆ‘ä»¬è¦åšçš„å°±æ˜¯æŠŠ`isReadonly`returnå‡ºå»
```typescript
export function createGetter<T extends object>(isReadonly = false) {
  return function get(target: T, key: string | symbol) {
    if(key === '__v_isReadonly'){
      return isReadonly
    }
    let res = Reflect.get(target, key)

    if (!isReadonly) {
      // åˆ¤æ–­æ˜¯å¦readonly
      // ä¾èµ–æ”¶é›†
      track(target, key as string)
    }
    return res
  }
}
```
ä»¥ä¸‹ä¸ºisReadonlyçš„æµ‹è¯•ç”¨ä¾‹
```typescript
it('readonly not set', () => {
    let original = {
      foo: {
        fuck: {
          name: 'what',
        },
      },
      arr: [{color: '#fff'}]
    }
    let warper = readonly(original)
    expect(warper).not.toBe(original)
    expect(isReadonly(warper)).toBe(true)
    expect(isReadonly(original)).toBe(false)  âŒ
    // æµ‹è¯•åµŒå¥—å¯¹è±¡çš„reactiveçŠ¶æ€
    expect(isReadonly(warper.foo.fuck)).toBe(true)
    // expect(isReadonly(warper.foo.fuck.name)).toBe(true) // å› ä¸ºnameæ˜¯ä¸€ä¸ªåŸºæœ¬ç±»å‹æ‰€ä»¥isObjectä¼šæ˜¯falseï¼Œæš‚æ—¶å¯¹nameç”Ÿæˆä¸äº†readonlyï¼Œæ¶‰åŠåˆ°å¾€åçš„çŸ¥è¯†ç‚¹ isRef
    expect(isReadonly(warper.arr)).toBe(true)
    expect(isReadonly(warper.arr[0])).toBe(true)
    expect(warper.foo.fuck.name).toBe('what')
  })
```
å¼€å§‹æ‰§è¡Œæµ‹è¯•å¾ˆé¡ºç•…ï¼ŒisReadonlyä¼ å…¥ä¸€ä¸ªä»£ç†å¯¹è±¡ï¼Œè¿”å›trueæ²¡é—®é¢˜ï¼Œå—¯ï¼Ÿæ€ä¹ˆæ‰§è¡Œä¼ å…¥æºæ•°æ®çš„æ—¶å€™ä¼šæµ‹è¯•ä¸é€šè¿‡å‘¢ï¼Ÿ

åŸå› æ˜¯æºæ•°æ®å¹¶æ²¡æœ‰è¢«ä»£ç†ï¼Œå¹¶ä¸èƒ½è§¦å‘getæ“ä½œï¼Œç»“æœå°±æ˜¯`isReadonly(original)`åªèƒ½è¿”å› undefinedï¼Œå› ä¸ºoriginalæ ¹æœ¬å°±æ²¡æœ‰`__v_isReadonly`å±æ€§ã€‚

é‚£æˆ‘ä»¬åªè¦è®©å®ƒè¿”å›falseå°±å¥½äº†ã€‚é€šè¿‡`!!`åŒå¹å·ï¼Œå°†å®ƒè½¬æˆå¸ƒå°”å€¼ã€‚undefined ä¼šè½¬æˆfalseã€‚

```typescript
export function isReadonly(value: unknown){
  return !!(value as Target)['__v_isReadonly']
}
```


## å®ç° isReactive

isReactiveå¾ˆç®€å•ï¼Œå› ä¸ºcreateGetterçš„å…¥å‚æ˜¯ä¸ªå¸ƒå°”å€¼`isReadonly`ï¼Œæ‰€ä»¥ä¸æ˜¯isReadonlyï¼Œå°±æ˜¯isReactiveã€‚

å®ç°æ€è·¯å’ŒisReadonlyä¸€æ ·ï¼Œåªæ˜¯æŠŠ`isReadonly`æ¢æˆ`isReactive`ï¼Œç„¶åé€šè¿‡getæ“ä½œï¼Œè¿”å›ä¸€ä¸ªå¸ƒå°”å€¼ã€‚

```typescript
export interface Target {
  __v_isReadonly?: boolean;
  __v_isReactive?: boolean;
}
export function isReactive(value: unknown) {
  
  return !!(value as Target)['__v_isReactive']
}
```
```typescript
export function createGetter<T extends object>(isReadonly = false) {
  return function get(target: T, key: string | symbol) {
    // isReactiveå’ŒisReadonly éƒ½æ˜¯æ ¹æ®ä¼ å…¥çš„å‚æ•° `isReadonly`æ¥å†³å®šæ˜¯å¦è¿”å›true | falseçš„
    if (key === '__v_isReactive') {
      return !isReadonly
    } else if (key === '__v_isReadonly') {
      return isReadonly
    }
    let res = Reflect.get(target, key)
    // ä¹‹å‰éƒ½æ˜¯åªå®ç°è¡¨é¢ä¸€å±‚çš„reactiveï¼Œæˆ‘ä»¬ç°åœ¨å®ç°åµŒå¥—å¯¹è±¡çš„reactive
    if(isObject(res)){
      return isReadonly ? readonly(res) : reactive(res)
    }
    if (!isReadonly) {
      // åˆ¤æ–­æ˜¯å¦readonly
      // ä¾èµ–æ”¶é›†
      track(target, key as string)
    }
    return res
  }
}
```

çœ‹ç€ä¸€ä¸ªä¸ªå­—ç¬¦ä¸²çš„çŠ¶æ€ï¼Œæ˜¯ä¸æ˜¯è§‰å¾—å¾ˆä¸çˆ½ã€‚æˆ‘ä»¬ç”¨typescriptçš„enumç®¡ç†çŠ¶æ€ï¼Œå¢å¼ºä»£ç å¯è¯»æ€§ã€‚
```typescript
export enum ReactiveFlags {
  IS_REACTIVE = '__v_isReactive',
  IS_READONLY = '__v_isReadonly'
}
export interface Target {
  [ReactiveFlags.IS_REACTIVE]?: boolean;
  [ReactiveFlags.IS_READONLY]?: boolean;
}
```
ä¹‹ååªè¦å°†enumçš„keyæ›¿æ¢ä¸Šé¢è£¸éœ²çš„å­—ç¬¦ä¸²å°±å¯ä»¥äº†ï¼Œè¿™é‡Œä¸éƒ½è¯´ã€‚

### é‡åˆ°åµŒå¥—çš„å¯¹è±¡

é‡åˆ°åµŒå¥—çš„å¯¹è±¡ä½œä¸ºæºæ•°æ®ç”Ÿæˆä»£ç†å¯¹è±¡æ—¶ï¼Œä»£ç†å¯¹è±¡çš„å­å¯¹è±¡ä½œä¸ºå‚æ•°è°ƒç”¨isReactiveæˆ–è€…è°ƒç”¨isReadonlyï¼Œä¼šè¿”å›falseï¼Œå› ä¸ºé‡Œé¢çš„å¯¹è±¡å¹¶æ²¡æœ‰è¢«ä»£ç†ã€‚

ä»¥ä¸‹æ˜¯è¯¥æƒ…å†µçš„æµ‹è¯•ç”¨ä¾‹
```typescript
it('nested reactive',()=>{
    let original = {
      foo: {
        name: 'ghx'
      },
      arr: [{age: 23}]
    }
    const nested = reactive(original)
    expect(isReactive(nested.foo)).toBe(true)    âŒ
    expect(isReactive(nested.arr)).toBe(true)    âŒ
    expect(isReactive(nested.arr[0])).toBe(true) âŒ
    expect(isReactive(nested.foo)).toBe(true)    âŒ
    // expect(isReactive(nested.foo.name)).toBe(true) âŒ // æ¶‰åŠåˆ°å¾€åçš„çŸ¥è¯†ç‚¹ isRef
    
  })
```
è¦æƒ³æµ‹è¯•ç”¨ä¾‹é€šè¿‡ï¼Œæˆ‘ä»¬å°±å¿…é¡»æŠŠåµŒå¥—çš„å¯¹è±¡ä¹Ÿè½¬æˆreactiveä»£ç†å¯¹è±¡ã€‚

å½“è§¦å‘getæ“ä½œçš„å¾—åˆ°çš„`res`ï¼Œæˆ‘ä»¬è¿½åŠ ä¸€ä¸ªåˆ¤æ–­ï¼Œå¦‚æœå‘ç° res ä¸æ˜¯reactiveæˆ–è€…readonlyï¼Œå¹¶ä¸”`res`æ˜¯å¯¹è±¡ï¼Œé‚£ä¹ˆé€’å½’è°ƒç”¨`reactive()`æˆ–è€…`readonly()`ã€‚

åˆ¤æ–­æ˜¯å¦æ˜¯å¯¹è±¡æˆ‘ä»¬å®šä¹‰ä¸€ä¸ª`isObject`åœ¨shared/index.tsä¸­ã€‚
```typescript
// åˆ¤æ–­valueæ˜¯å¦objectæˆ–è€…array
export const isObject = (value: unknown) => {
  return value !== null && typeof value === 'object'
}
```
å› ä¸ºè¦åœ¨getæ“ä½œæ—¶åˆ¤æ–­å¾—åˆ°çš„resï¼Œæˆ‘ä»¬åœ¨`createGetter()`ä¸Šé¢åšæ–‡ç« 
```typescript
export function createGetter<T extends object>(isReadonly = false) {
  return function get(target: T, key: string | symbol) {
    if (key === ReactiveFlags.IS_REACTIVE) {
      return !isReadonly
    } else if (key === ReactiveFlags.IS_READONLY) {
      return isReadonly
    }
    let res = Reflect.get(target, key)
    // ä¹‹å‰éƒ½æ˜¯åªå®ç°è¡¨é¢ä¸€å±‚çš„reactiveï¼Œæˆ‘ä»¬ç°åœ¨å®ç°åµŒå¥—å¯¹è±¡çš„reactive
    if(isObject(res)){
      return isReadonly ? readonly(res) : reactive(res)
    }
    if (!isReadonly) {
      // åˆ¤æ–­æ˜¯å¦readonly
      // ä¾èµ–æ”¶é›†
      track(target, key as string)
    }
    return res
  }
}
```

## ä¼˜åŒ–ç‚¹

åè§‚`mutableHandlers`å’Œ`readonlyHandlers`
```typescript
// reactiveçš„handlers
export const mutableHandlers: ProxyHandler<object> = {
  get: createGetter(),
  set: createSetter(),
}
// readonlyçš„handlers
export const readonlyHandlers: ProxyHandler<object> = {
  get: createGetter(true),
  set(target, key, value) {
    console.warn(`${target} do not set ${String(key)} value ${value}, because it is readonly`)
    return true
  },
}
```
ä»£ç†å¯¹è±¡æ¯æ¬¡è§¦å‘proxyçš„getæ“ä½œçš„æ—¶å€™éƒ½ä¼šè°ƒç”¨`createGetter()`ï¼Œsetæ“ä½œä¹Ÿæ˜¯ä¸€æ ·çš„ã€‚ä¸ºäº†ä¼˜åŒ–ä»£ç ï¼Œå‡å°‘å¯¹`createGetter()`çš„è°ƒç”¨æ¬¡æ•°ï¼Œæˆ‘ä»¬å•ç‹¬æŠ½ç¦»createGetter()å’ŒcreateSetter()ï¼Œç”¨ä¸€ä¸ªå¸¸é‡æ¥æ”¶ã€‚
```typescript
// æ­¤å¤„è°ƒç”¨ä¸€æ¬¡createSetterå’ŒcreateGetterï¼Œä¸ºäº†ä¸åœ¨æ¯æ¬¡ä½¿ç”¨mutableHandlersçš„æ—¶å€™é‡å¤è°ƒç”¨
const get = createGetter()
const set = createSetter()
const readonlyGet = createGetter(true)
```
æ‰€ä»¥`mutableHandlers`å’Œ`readonlyHandlers`åº”è¯¥è¢«æ”¹å†™æˆ
```typescript
export const mutableHandlers: ProxyHandler<object> = {
  get,
  set,
}
export const readonlyHandlers: ProxyHandler<object> = {
  get: readonlyGet,
  set(target, key, value) {
    console.warn(`${target} do not set ${String(key)} value ${value}, because it is readonly`)
    return true
  },
}
```
å¦‚æœè¿˜ä¸æ˜ç™½ä¸ºä»€ä¹ˆè¦æŠ½ç¦»å‡ºæ¥çš„åŒå­¦[çœ‹è¿™é‡Œ](https://www.typescriptlang.org/play?#code/PTAEk34wZxMcyNBkIwwuQIyEJrAxgJwKYEMAumBlTXfdACgEoAoVAewDsBnXUAWwFddsAjAG0wAS2egBN+6RqAC8oAN5VQi0AHNiALlAYc+AOLFSlADQKljdZqx5C+zOWoBfKjQbNQ2bNND1MAd1AAFdFoADwBPMlk3bA0AckQAJgBmGNB7QzZOHn4hUXFGCgBuZyYWd3jPbz9AkPDI91iE5NT0ji4+QWExW3yiuhK3RIrfAKCwiKiGpJS0jLbszrzC4tdsABYhqtHaidA4qebZrI7c7qW+lYBWDZGa8frdxumWzPacrokzl1KANmvqsbq0Qe+xmrSOb0WvS+bgA7H8tncgXsmqCXvMTh8ilQQBAYAhvmhLPgiCRbJQqO4AHTuTwxRKrC4xCnYeLUjwyOkMpllNm0+mMxTM1k0jn87ks3mirlCyW7MVOABm7HoqFwAEsGBZtJg9KS7HITIpzrR+JTeLRlGQYphgphUCobOgYkslKAsLh2Oh6KAyFx0KpcBphKF0gAHIKh2y4UIAaUwoQ0zHQavoynSIkwjAwatDuFo6A01Uj6GjABFM9nc-mKNIAHwGw2ut3ET3egBKmAV-FVlIDvuw-uIYYjUdj8eorscjioSpV6s1WisJIMNfkruNpvNluttvtZj1zqKrvdrZ9foDQfoIdA4doxejcYToCTKbToAAbtheOxMBplQBrehaB8eh0wrZMqwLG571CcsswgvN0BrKR6zXJsjRcE1MDNC0rRtO1n0dQ8nHQxQTy9UBcHQH9GynJxzhYW8wnhW5AUmFF0jQxQLzPAceODYc71HR9Eyo18wPgnNEMLEcS1g8CpOrOs5GaRt9w0ftB0DNwr0EmCROfMTU3ST9v1-UAAKAkCJMraToNHODbKUlCDVI5sPQoqiaMnKh7GoIA)

## æ€»ç»“
1. readonlyçš„å®ç°å’Œreactiveçš„å®ç°æœ‰ç‚¹ç›¸ä¼¼ï¼Œä½†æ˜¯æœ‰ç‚¹ä¸åŒã€‚æ²¡æœ‰setæ“ä½œï¼Œæ²¡æœ‰ä¾èµ–æ”¶é›†ï¼Œè§¦å‘ä¾èµ–ã€‚
2. isReactiveçš„å®ç°å’ŒisReadonlyçš„å®ç°åŸç†ä¸€æ ·ï¼Œéƒ½æ˜¯é€šè¿‡`createGetter()`çš„å…¥å‚`isReadonly`åˆ¤æ–­çš„ã€‚
3. é‡åˆ°åµŒå¥—å¯¹è±¡çš„æºæ•°æ®è¦ç”Ÿæˆä»£ç†å¯¹è±¡ï¼Œä»£ç†å¯¹è±¡çš„å­å¯¹è±¡ä¹Ÿè¦è¢«ä»£ç†ã€‚æˆ‘ä»¬é€šè¿‡åˆ¤æ–­æ˜¯å¦æ˜¯å¯¹è±¡ç„¶åé€’å½’è°ƒç”¨`reactive()`æˆ–è€…`readonly()`æ¥å®ç°ã€‚

## æœ€å@æ„Ÿè°¢é˜…è¯»

ä¸å¿µè¿‡å»ï¼Œä¸ç•å°†æ¥ã€‚

## å®Œæ•´ä»£ç 

```typescript
// In share/index.ts
// åˆ¤æ–­valueæ˜¯å¦objectæˆ–è€…array
export const isObject = (value: unknown) => {
  return value !== null && typeof value === 'object'
}

```
```typescript
// In reactive.ts

import { createReactiveObject, mutableHandlers, readonlyHandlers } from './baseHandlers'

export enum ReactiveFlags {
  IS_REACTIVE = '__v_isReactive',
  IS_READONLY = '__v_isReadonly'
}
// ç»™valueåšç±»å‹æ‰¹æ³¨ï¼Œè®©valueæœ‰ä»¥ä¸‹å‡ ä¸ªå¯é€‰å±æ€§,ä¸ç„¶è¯¥æ­»çš„valueé£˜çº¢ --isReactiveå‡½æ•°å’ŒisReadonlyå‡½æ•°  è¯´çš„å°±æ˜¯ä½ ä»¬
export interface Target {
  [ReactiveFlags.IS_REACTIVE]?: boolean;
  [ReactiveFlags.IS_READONLY]?: boolean;
}

export function reactive<T extends object>(target: T) {
  return createReactiveObject<T>(target, mutableHandlers)
}
// å…¶å®å°±æ˜¯ä¸€ä¸ªæ²¡æœ‰setæ“ä½œçš„reactive
export function readonly<T extends object>(target: T) {
  return createReactiveObject<T>(target, readonlyHandlers)
}

export function isReactive(value: unknown) {
  // targetæ²¡æœ‰__v_isReactiveè¿™ä¸ªå±æ€§ï¼Œä¸ºä»€ä¹ˆè¿˜è¦å†™target['__v_isReactive']å‘¢ï¼Ÿå› ä¸ºè¿™æ ·å°±ä¼šè§¦å‘proxyçš„getæ“ä½œï¼Œ
  // é€šè¿‡åˆ¤æ–­createGetterä¼ å…¥çš„å‚æ•°isReadonlyæ˜¯å¦ä¸ºtrueï¼Œå¦åˆ™isReactiveä¸ºtrue
  // ä¼˜åŒ–ç‚¹ï¼šç”¨enumç®¡ç†çŠ¶æ€ï¼Œå¢å¼ºä»£ç å¯è¯»æ€§
  return !!(value as Target)[ReactiveFlags.IS_REACTIVE]
}
export function isReadonly(value: unknown){
  // åŒä¸Š
  return !!(value as Target)[ReactiveFlags.IS_READONLY]
}

```
```typescript
// In baseHandlers.ts

import { track, trigger } from './effect'
import { reactive, ReactiveFlags, readonly } from './reactive'
import { isObject } from '../shared'
// æ­¤å¤„è°ƒç”¨ä¸€æ¬¡createSetterå’Œgetterï¼Œä¸ºäº†ä¸åœ¨æ¯æ¬¡ä½¿ç”¨mutableHandlersçš„æ—¶å€™é‡å¤è°ƒç”¨
const get = createGetter()
const set = createSetter()
const readonlyGet = createGetter(true)

// é«˜é˜¶å‡½æ•°ï¼Œ
export function createGetter<T extends object>(isReadonly = false) {
  return function get(target: T, key: string | symbol) {
    // isReactiveå’ŒisReadonly éƒ½æ˜¯æ ¹æ®ä¼ å…¥çš„å‚æ•° `isReadonly`æ¥å†³å®šæ˜¯å¦è¿”å›true | falseçš„
    if (key === ReactiveFlags.IS_REACTIVE) {
      return !isReadonly
    } else if (key === ReactiveFlags.IS_READONLY) {
      return isReadonly
    }
    let res = Reflect.get(target, key)
    // ä¹‹å‰éƒ½æ˜¯åªå®ç°è¡¨é¢ä¸€å±‚çš„reactiveï¼Œæˆ‘ä»¬ç°åœ¨å®ç°åµŒå¥—å¯¹è±¡çš„reactive
    if(isObject(res)){
      return isReadonly ? readonly(res) : reactive(res)
    }
    if (!isReadonly) {
      // åˆ¤æ–­æ˜¯å¦readonly
      // ä¾èµ–æ”¶é›†
      track(target, key as string)
    }
    return res
  }
}
export function createSetter<T extends object>() {
  return function set(target: T, key: string | symbol, value: any) {
    let success: boolean
    success = Reflect.set(target, key, value)
    // è§¦å‘ä¾èµ–
    trigger(target, key as string)
    return success
  }
}

export const mutableHandlers: ProxyHandler<object> = {
  get,
  set,
}
export const readonlyHandlers: ProxyHandler<object> = {
  get: readonlyGet,
  set(target, key, value) {
    console.warn(`${target} do not set ${String(key)} value ${value}, because it is readonly`)
    return true
  },
}
export function createReactiveObject<T extends object>(target: T, handlers: ProxyHandler<T>) {
  return new Proxy(target, handlers)
}

```
```typescript
// In readonly.spec.ts
import { readonly, isReadonly } from '../reactive'
describe('readonly', () => {
  it('readonly not set', () => {
    let original = {
      foo: {
        fuck: {
          name: 'what',
        },
      },
      arr: [{color: '#fff'}]
    }
    let warper = readonly(original)
    expect(warper).not.toBe(original)
    expect(isReadonly(warper)).toBe(true)
    expect(isReadonly(original)).toBe(false)
    // æµ‹è¯•åµŒå¥—å¯¹è±¡çš„reactiveçŠ¶æ€
    expect(isReadonly(warper.foo.fuck)).toBe(true)
    // expect(isReadonly(warper.foo.fuck.name)).toBe(true) // å› ä¸ºnameæ˜¯ä¸€ä¸ªåŸºæœ¬ç±»å‹æ‰€ä»¥isObjectä¼šæ˜¯falseï¼Œæš‚æ—¶å¯¹nameç”Ÿæˆä¸äº†readonlyï¼Œæ¶‰åŠåˆ°å¾€åçš„çŸ¥è¯†ç‚¹ isRef
    expect(isReadonly(warper.arr)).toBe(true)
    expect(isReadonly(warper.arr[0])).toBe(true)
    expect(warper.foo.fuck.name).toBe('what')
  })
  it('warning when it be call set operation', () => {
    let original = {
      username: 'ghx',
    }
    let readonlyObj = readonly(original)
    const warn = jest.spyOn(console, 'warn')
    readonlyObj.username = 'danaizi'
    expect(warn).toHaveBeenCalled()
  })
})

```
```typescript
// In reactice.spec.ts

import { reactive, isReactive } from '../reactive'

describe('reactive', () => {
  it('reactive test', () => {
    let original = { num: 1 }
    let count = reactive(original)
    expect(original).not.toBe(count)
    expect(count.num).toEqual(1)
    expect(isReactive(original)).toBe(false)
    expect(isReactive(count)).toBe(true)
  })
  it('nested reactive',()=>{
    let original = {
      foo: {
        name: 'ghx'
      },
      arr: [{age: 23}]
    }
    const nested = reactive(original)
    expect(isReactive(nested.foo)).toBe(true)
    expect(isReactive(nested.arr)).toBe(true)
    expect(isReactive(nested.arr[0])).toBe(true)
    expect(isReactive(nested.foo)).toBe(true)
    // expect(isReactive(nested.foo.name)).toBe(true) // æ¶‰åŠåˆ°å¾€åçš„çŸ¥è¯†ç‚¹ isRef
    
  })
})

```
