# ğŸš€ reactive & watchEffect ä¸”åˆ©ç”¨Jestæµ‹è¯•å®ç°æ•°æ®å“åº”å¼

## å‰è¨€
ğŸ‰å¾ˆé«˜å…´åœ¨æ­¤åˆ†äº«ç»™å¤§å®¶Vue3çš„æ•°æ®å“åº”åŸç†ï¼Œå°è€å¼Ÿæˆ‘è¡¨è¾¾èƒ½åŠ›æœ‰é™ï¼Œæ‰€ä»¥

ğŸ¤£å¦‚æœ‰é”™æ¼ï¼Œè¯·å¤šæŒ‡æ•™â¤

## å®ç°æ€è·¯
vue3 çš„æ•°æ®å“åº”å¼å®ç°æˆ‘ä»¬æƒ³ç†æ¸…æ¥šå®ƒçš„ç‰¹å¾ï¼Œæ‰å¥½å¾€ä¸‹å†™ã€‚

ä»¥ä¸‹æ˜¯åŸºæœ¬çš„`reactive`+`watchEffect`ç”¨æ³•
```typescript
let count = reactive({ num: 11 })
let result = 0
watchEffect(() => {
  result = count.num + 1
})
// resultå¾—åˆ°çš„æ˜¯12 çœ‹èµ·æ¥watchEffectç«‹å³æ‰§è¡Œäº†å‘¢~
expect(result).toBe(12)
// ç›¸å½“äºcount.num = count.num + 1  è¿™é‡Œæœ‰count.numçš„getæ“ä½œå’Œsetæ“ä½œ
count.num++
// resultå¾—åˆ°çš„æ˜¯13 çœ‹èµ·æ¥ä»–åˆæ‰§è¡Œäº†ä¸€éwatchEffectçš„å›è°ƒå‡½æ•°äº†å‘¢~ğŸ¤¯
expect(result).toBe(13)
```
### ä¸¤å¤§ç‚¹
* ä¾èµ–æ”¶é›†
* è§¦å‘ä¾èµ–
  
ä¸‹é¢è®²ä¸€ä¸‹å¤§ä½“æ€è·¯ï¼š

1. `reactive`ä¸ºæºæ•°æ®åˆ›å»º`proxy`å¯¹è±¡ï¼Œå…¶ä¸­`proxy`çš„`getter`ã€`setter`åˆ†åˆ«ç”¨äºæ•°æ®çš„ä¾èµ–æ”¶é›†ï¼Œæ•°æ®çš„ä¾èµ–è§¦å‘
2. `watchEffect`ç«‹å³æ‰§è¡Œä¸€æ¬¡å›è°ƒå‡½æ•°ï¼Œå½“å›è°ƒå‡½æ•°å†…çš„ä¾èµ–æ•°æ®å‘ç”Ÿå˜åŒ–çš„æ—¶å€™ä¼šå†æ¬¡è§¦å‘è¯¥å›è°ƒå‡½æ•°
3. æ”¶é›†ä¾èµ–æˆ‘ä»¬å¯ä»¥å®šä¹‰ä¸€ä¸ª`track`å‡½æ•°ï¼Œå½“reactiveçš„æ•°æ®å‘ç”Ÿgetæ“ä½œæ—¶ï¼Œ`track`ç”¨ä¸€ä¸ª`å”¯ä¸€æ ‡è¯†`ï¼ˆä¸‹é¢ä¼šè®²è¿™ä¸ª`å”¯ä¸€æ ‡è¯†`æ˜¯ä»€ä¹ˆï¼‰è®°å½•ä¾èµ–åˆ°ä¸€ä¸ª`å®¹å™¨`é‡Œé¢
4. è§¦å‘ä¾èµ–æˆ‘ä»¬å¯ä»¥å®šä¹‰ä¸€ä¸ª`trigger`å‡½æ•°ï¼Œå½“reactiveçš„æ•°æ®å‘ç”Ÿsetæ“ä½œæ—¶ï¼Œ`trigger`å°†å…³äºè¿™ä¸ªæ•°æ®çš„æ‰€æœ‰ä¾èµ–ä»`å®¹å™¨`é‡Œé¢æ‹¿å‡ºæ¥é€ä¸ªæ‰§è¡Œä¸€é

## ç®€å•å®ç°ï¼ˆè¯¦ç»†ä»£ç åœ¨æœ€åï¼‰
> 1. `reactive`

ç»™æºæ•°æ®åˆ›å»ºä¸€ä¸ª[proxy](https://es6.ruanyifeng.com/#docs/proxy)å¯¹è±¡ï¼Œå°±å¥½åƒç»™æºæ•°æ®å¥—ä¸Šäº†ä¸€å±‚ç›”ç”²ï¼Œæ•Œäººåªèƒ½æ”»å‡»è¿™å±‚ç›”ç”²ï¼Œæ— æ³•ä¹‹é—´æ”»å‡»æºæ•°æ®ï¼Œåœ¨è¿™åŸºç¡€ä¹‹ä¸Šæˆ‘ä»¬å°±å¯ä»¥æœ‰æœºä¼šå»åšæ•°æ®çš„æ‹¦æˆªã€‚


reactiveé€šè¿‡ä¼ å…¥ä¸€ä¸ªå¯¹è±¡ä½œä¸ºå‚æ•°ï¼Œè¿”å›ä¸€ä¸ªè¯¥å¯¹è±¡çš„proxyå¯¹è±¡ï¼Œå…¶ä¸­`Reflect.get(target, key)`è¿”å›targetçš„keyå¯¹åº”çš„å±æ€§å€¼resï¼Œ`Reflect.set(target, key, value)`è®¾ç½®targetçš„keyå¯¹åº”çš„å±æ€§å€¼ä¸ºvalue
```TypeScript
export function reactive(target: Record<string, any>) {
  return new Proxy(target, {
    get(target, key) {
      let res = Reflect.get(target, key)
      return res
    },
    set(target, key, value) {
      let success: boolean
      success = Reflect.set(target, key, value)
      return success
    }
  })
}
```
è¿™æ—¶å€™æˆ‘ä»¬å¯ä»¥ç¼–å†™ä¸€ä¸ªğŸ› æµ‹è¯•ç”¨ä¾‹ï¼Œè·‘ä¸€è·‘æµ‹è¯•æœ‰æ²¡æœ‰é—®é¢˜
```Typescript
describe('reactive', () => {
  it.skip('reactive test', () => {
    let original = { num: 1 } 
    let count = reactive(original)
    expect(original).not.toBe(count)   âœ…
    expect(count.num).toEqual(1)       âœ…
  })
})
```


ğŸ¤®ä»€ä¹ˆï¼Ÿä½ ä¸æ˜¯è¯´getterå’Œsetterè¦åˆ†åˆ«åšä¸¤ä»¶äº‹æƒ…å—ï¼ŸğŸ˜’
* getterè¿›è¡Œä¾èµ–æ”¶é›† ğŸ‘€
* setterè¿›è¡Œè§¦å‘ä¾èµ– ğŸ”Œ

åˆ«æ€¥ï¼è¿˜ä¸æ˜¯æ—¶å€™ï¼

> 2. `watchEffect`

 æ ¹æ®å®˜æ–¹ç»™å‡ºçš„ä»‹ç»ï¼š`watchEffect`ä¼šç«‹å³è§¦å‘å›è°ƒå‡½æ•°ï¼ŒåŒæ—¶å“åº”å¼è¿½è¸ªå…¶ä¾èµ–

watchEffectçš„åŸºæœ¬ç”¨æ³•ï¼š
 ```typeScript
let result = 0
// å‡è®¾count.num == 1
watchEffect(() => {
  result = count.num + 1
})
// é‚£ä¹ˆè¾“å‡ºçš„resultå°±æ˜¯2
console.log(result) // output: 2
 ```
å…¶ä¸­`count`æ˜¯å·²ç»é€šè¿‡äº†`reactive`å¤„ç†çš„proxyå®ä¾‹å¯¹è±¡

æ ¹æ®ä¸Šè¿°çš„ç”¨æ³•æˆ‘ä»¬å¯ä»¥ç®€å•çš„å†™å‡ºä¸€ä¸ª`watchEffect`å‡½æ•°

```typescript
class ReactiveEffect {
  private _fn: Function
  constructor(fn: Function) {
    this._fn = fn
  }
  run() {
    this._fn()
  }
}
export function watchEffect(fn: Function) {
  let _reactiveFunc = new ReactiveEffect(fn)
  _reactiveFunc.run()
}

```
å†å†™ä¸€ä¸ªæµ‹è¯•ç”¨ä¾‹éªŒè¯ä¸€ä¸‹
```Typescript
describe('watchEffect test', () => {
  it('watchEffect', () => {
    // åˆ›å»ºproxyä»£ç†
    let count = reactive({ num: 11 })
    let result = 0
    // ç«‹å³æ‰§è¡Œeffectå¹¶è·Ÿè¸ªä¾èµ–
    watchEffect(() => {
      result = count.num + 1
    })
    expect(result).toBe(12)   âœ…

    count.num++
    expect(result).toBe(13)   âŒ
  })
})

```
æ¬¸ï¼æˆ‘ä»¬å‘ç°äº†æµ‹è¯•æœ€åä¸€é¡¹æ²¡æœ‰é€šè¿‡ï¼Œå“¦åŸæ¥æˆ‘ä»¬è¿˜æ²¡å®ç°ä¾èµ–æ”¶é›†å’Œè§¦å‘ä¾èµ–å•Šã€‚ã€‚ã€‚


> 3. `track`åšä¾èµ–æ”¶é›†

æˆ‘æƒ³æƒ³ï¼Œæˆ‘ä»¬åº”è¯¥æ€ä¹ˆè¿›è¡Œä¾èµ–æ”¶é›†ï¼Ÿå¯¹ï¼Œä¸Šé¢æˆ‘ä»¬æåˆ°è¿‡æœ‰ä¸€ä¸ª`å”¯ä¸€æ ‡è¯†`å’Œä¸€ä¸ª`å®¹å™¨`ã€‚æˆ‘ä»¬è¯¥å»å“ªæ‰¾è¿™ä¸ªä¾èµ–å•Šï¼Ÿæ¬¸æ˜¯`å®¹å™¨`ï¼Œé‚£äº›ä¾èµ–æ˜¯æˆ‘ä»¬éœ€è¦è¢«è§¦å‘çš„å‘¢ï¼Ÿæ¬¸çœ‹`å”¯ä¸€æ ‡è¯†`

å”¯ä¸€æ ‡è¯†æ˜¯ä»€ä¹ˆï¼Ÿ

å‡è®¾æ•°æ®targetæ˜¯ä¸€ä¸ªå¯¹è±¡`{num: 11}`ï¼Œå¯¹è±¡çš„å±æ€§åå¯ä»¥ç»‘å®šå¾ˆå¤šä¾èµ–ï¼Œè¿™ä¸ªå±æ€§å`num`+`target`å°±å¯ä»¥æ‰¾åˆ°ä¸`num`ç›¸å…³çš„æ‰€æœ‰ä¾èµ–é›†åˆï¼Œæ‰€ä»¥è¿™é‡Œçš„`num`ç›¸å…³çš„æ‰€æœ‰ä¾èµ–é›†åˆçš„å”¯ä¸€æ ‡è¯†å°±æ˜¯`num`+`target`

å®¹å™¨æ˜¯ä»€ä¹ˆï¼Ÿ

å­˜å‚¨ä¸åŒæ•°æ®ä¸‹çš„æ‰€æœ‰å±æ€§å¯¹åº”çš„æ‰€æœ‰ä¾èµ–é›†åˆï¼Œæˆ‘ä»¬å¯ä»¥ç”¨Mapå­˜å‚¨ä¸åŒæ•°æ®ï¼Œå‘½åä¸º`targetMap`ï¼Œæ¯ä¸ªæ•°æ®ä½œä¸º`targetMap`çš„é”®åï¼Œå†å®šä¹‰ä¸€ä¸ªä»¥å±æ€§å`key`ä¸ºé”®åçš„`depsMap`ä½œä¸º`targetMap`çš„é”®å€¼ï¼Œ`depsMap`çš„é”®å€¼æ˜¯ä¸€ä¸ªSeté›†åˆï¼Œå‘½åä½œ`deps`ï¼Œæœ€ç»ˆ`deps`å°±æ˜¯å­˜æ”¾ç‰¹å®šçš„`key`çš„ä¾èµ–é›†åˆ

ç±»å‹å®šä¹‰ï¼š

æˆ‘ç›¸ä¿¡ä½ ä»¬çœ‹åˆ°`targetMap`çš„ç±»å‹å®šä¹‰çš„æ—¶å€™åº”è¯¥ä¼šç†è§£æˆ‘ä¸Šé¢è¯´çš„å­˜å‚¨ç»“æ„æ˜¯æ€ä¹ˆæ ·çš„å§

```typescript
type EffectKey = string
type IDep = ReactiveEffect
const targetMap = new Map<Record<EffectKey, any>, Map<EffectKey, Set<IDep>>>()
let activeEffect: ReactiveEffect
```
ä¸‹é¢æˆ‘ä»¬æ¥å†™ä¸€ä¸‹`track`å‡½æ•°çš„å®ç°ï¼Œè¦æ³¨æ„çš„æ˜¯æˆ‘ä»¬éœ€è¦å¤„ç†ä¸€ä¸‹ç¬¬ä¸€æ¬¡æ²¡æœ‰å­˜å‚¨Mapçš„æƒ…å†µ

```typescript
export function track(target: Record<EffectKey, any>, key: EffectKey) {
  // å¯»æ‰¾depä¾èµ–çš„æ‰§è¡Œé¡ºåº
  // target -> key -> dep
  let depsMap = targetMap.get(target)
  // è§£å†³åˆå§‹åŒ–æ²¡æœ‰depsMapçš„æƒ…å†µ
  if (!depsMap) {
    depsMap = new Map()
    targetMap.set(target, depsMap)
  }
  // depsæ˜¯ä¸€ä¸ªSetå¯¹è±¡ï¼Œå­˜æ”¾ç€è¿™ä¸ªkeyç›¸å¯¹åº”çš„æ‰€æœ‰ä¾èµ–
  let deps = depsMap.get(key)
  // å¦‚æœæ²¡æœ‰keyç›¸å¯¹åº”çš„Set åˆå§‹åŒ–Set
  if (!deps) {
    deps = new Set()
    depsMap.set(key, deps)
  }
  // å°†activeEffectå®ä¾‹å¯¹è±¡addç»™deps
  deps.add(activeEffect)
}
```
è§£é‡Šä¸€ä¸‹
```typescript
deps.add(activeEffect)
```
è¿™é‡Œçš„activeEffectå°±æ˜¯æˆ‘ä»¬çš„ä¾èµ–ï¼Œæ€ä¹ˆè·å–åˆ°çš„å‘¢ï¼Ÿ

å…¶å®å½“`watchEffect`æ‰§è¡Œçš„æ—¶å€™ï¼Œå†…éƒ¨ new äº†ä¸€ä¸ª`ReactiveEffect`ç±»ï¼Œè€Œ`ReactiveEffect`ç±»é‡Œé¢å¯ä»¥é€šè¿‡`this`è·å–åˆ°`activeEffect`ï¼Œå› ä¸º`activeEffect`æœ¬æ¥å°±æ˜¯`ReactiveEffect`ç±»çš„å®ä¾‹

æˆ‘ä»¬æ”¹å†™ä¸€ä¸‹`ReactiveEffect`ä»£ç 

```typescript
class ReactiveEffect {
  private _fn: Function
  constructor(fn: Function) {
    this._fn = fn
  }
  run() {
    // ä¸ºä»€ä¹ˆè¦åœ¨è¿™é‡ŒæŠŠthisèµ‹å€¼ç»™activeEffectå‘¢ï¼Ÿå› ä¸ºè¿™é‡Œæ˜¯fnæ‰§è¡Œä¹‹å‰ï¼Œå°±æ˜¯trackä¾èµ–æ”¶é›†æ‰§è¡Œä¹‹å‰ï¼Œåˆæ˜¯effectå¼€å§‹æ‰§è¡Œä¹‹åï¼Œ
    // thisèƒ½æ•æ‰åˆ°è¿™ä¸ªä¾èµ–ï¼Œå°†è¿™ä¸ªä¾èµ–èµ‹å€¼ç»™activeEffectæ˜¯åˆšåˆšå¥½çš„æ—¶æœº
    activeEffect = this
    this._fn()
  }
}
```
> 4. `trigger`åšè§¦å‘ä¾èµ–

è¿™ä¸ªtriggerçš„å®ç°é€»è¾‘å¾ˆç®€å•ï¼šæ‰¾å‡ºtargetçš„keyå¯¹åº”çš„æ‰€æœ‰ä¾èµ–ï¼Œå¹¶ä¾æ¬¡æ‰§è¡Œ

1. ç”¨targetä½œä¸ºé”®åæ‹¿åˆ°åœ¨targetMapé‡Œé¢é”®å€¼depsMap
2. ç”¨keyä½œä¸ºé”®åæ‹¿åˆ°depsMapçš„é”®å€¼deps
3. `ç„¶åéå†depsè¿™ä¸ªSetå®ä¾‹å¯¹è±¡ï¼Œdepsé‡Œé¢å­˜çš„éƒ½æ˜¯`ReactiveEffect`å®ä¾‹å¯¹è±¡depï¼Œæˆ‘ä»¬ä¾æ¬¡æ‰§è¡Œdep.run()å°±ç›¸å½“äºæ‰§è¡Œäº†watchEffectçš„å›è°ƒå‡½æ•°äº†ã€‚
   
```typescript
export function trigger(target: Record<EffectKey, any>, key: EffectKey) {
  const depsMap = targetMap.get(target)
  const deps = depsMap?.get(key)
  // æ³¨æ„depså¯èƒ½ä¸ºundefinedçš„æƒ…å†µ
  if (deps) {
    for (let dep of deps) {
      dep.run()
    }
  }
}
```
> 5. æ·»åŠ `track`å’Œ`trigger`å‡½æ•°åˆ°`proxy`çš„getterå’Œsetterä¸Š

```typescript
export function reactive(target: Record<string, any>) {
  return new Proxy(target, {
    get(target, key) {
      let res = Reflect.get(target, key)
      // ä¾èµ–æ”¶é›†
      track(target, key as string)
      return res
    },
    set(target, key, value) {
      let success: boolean
      success = Reflect.set(target, key, value)
      // è§¦å‘ä¾èµ–
      trigger(target, key as string)
      return success
    }
  })
}
```
æœ€åå†ç”¨jestè¿è¡Œä¸€ä¸‹å“åº”å¼æ•°æ®çš„æµ‹è¯•ç”¨ä¾‹

```Typescript
describe('watchEffect test', () => {
  it('watchEffect', () => {
    // åˆ›å»ºproxyä»£ç†
    let count = reactive({ num: 11 })
    let result = 0
    // ç«‹å³æ‰§è¡Œeffectå¹¶è·Ÿè¸ªä¾èµ–
    watchEffect(() => {
      // count.numè§¦å‘get å­˜å‚¨ä¾èµ–
      result = count.num + 1
    })
    expect(result).toBe(12)   âœ…
    // è¿™é‡Œä¼šå…ˆè§¦å‘proxyçš„getæ“ä½œå†è§¦å‘proxyçš„setæ“ä½œï¼Œè§¦å‘ä¾èµ–trigger æ›´æ–°result
    count.num++
    expect(result).toBe(13)   âœ…
  })
})
```
## æ€»ç»“
ä¸Šè¿°çš„æµ‹è¯•ç”¨ä¾‹countè§¦å‘äº†ä¸€æ¬¡setteræ“ä½œï¼Œä¸¤æ¬¡getteræ“ä½œã€‚

1. ç¬¬ä¸€æ¬¡getteræ“ä½œæ˜¯åœ¨watchEffectçš„å›è°ƒå‡½æ•°æ‰§è¡Œçš„æ—¶å€™å‘ç”Ÿï¼ŒwatchEffectç«‹å³æ‰§è¡Œï¼Œåœ¨æ‰§è¡Œä¹‹å‰æˆ‘ä»¬æ‹¿åˆ°äº†`activeEffect`ï¼Œä¹‹ååœ¨proxyçš„getterä¸­æ‰§è¡Œäº†trackå‡½æ•°ï¼Œä»¥`num`ä¸ºkeyçš„depsMapè¢«ç¬¬ä¸€æ¬¡åˆå§‹åŒ–ï¼Œå¹¶åˆå§‹åŒ–äº†`targetMap`ï¼ŒæŠŠ`activeEffect`æ·»åŠ åˆ°`deps`è¿™ä¸ªSetå¯¹è±¡ä¸­ï¼Œè¿™å°±å®Œæˆäº†ä¾èµ–æ”¶é›†ã€‚

2. å½“ä»£ç æ‰§è¡Œåˆ°`count.num++`çš„æ—¶å€™ï¼Œæˆ‘ä»¬å…ˆæ‰§è¡Œçš„æ˜¯proxyçš„getteræ“ä½œï¼Œæ‰§è¡Œ 1 çš„æµç¨‹ï¼Œä¹‹åæ‰§è¡Œçš„æ˜¯proxyçš„setteræ“ä½œ
   ```typescript
   Reflect.set(target, key, value)
   ```
   è¿™æ®µä»£ç æŠŠ`{num: 11}` åŠ ä¸€å˜æˆäº†`{num: 12}`ï¼Œå¹¶ä¸”åœ¨targetMapä¸­å¯»æ‰¾`{num: 12}`ä¸ºé”®åçš„é”®å€¼ï¼Œä¹‹åè¿›ä¸€æ­¥è·å–åˆ°äº†depsMapå’Œdepsã€‚é€šè¿‡å¾ªç¯æŠŠdepsé‡Œé¢çš„æ‰€æœ‰activeEffectæ‰§è¡Œ`run()`æ–¹æ³•ï¼Œè¿™å°±å®Œæˆäº†è§¦å‘ä¾èµ–ã€‚

## æœ€å@æ„Ÿè°¢é˜…è¯»ï¼

## å®Œæ•´ä»£ç 
```typescript
// in effect.ts

class ReactiveEffect {
  private _fn: Function
  constructor(fn: Function) {
    this._fn = fn
  }
  run() {
    // ä¸ºä»€ä¹ˆè¦åœ¨è¿™é‡ŒæŠŠthisèµ‹å€¼ç»™activeEffectå‘¢ï¼Ÿå› ä¸ºè¿™é‡Œæ˜¯fnæ‰§è¡Œä¹‹å‰ï¼Œå°±æ˜¯trackä¾èµ–æ”¶é›†æ‰§è¡Œä¹‹å‰ï¼Œåˆæ˜¯effectå¼€å§‹æ‰§è¡Œä¹‹åï¼Œ
    // thisèƒ½æ•æ‰åˆ°è¿™ä¸ªä¾èµ–ï¼Œå°†è¿™ä¸ªä¾èµ–èµ‹å€¼ç»™activeEffectæ˜¯åˆšåˆšå¥½çš„æ—¶æœº
    activeEffect = this
    this._fn()
  }
}
const targetMap = new Map<Record<EffectKey, any>, Map<EffectKey, Set<IDep>>>()
// å½“å‰æ­£åœ¨æ‰§è¡Œçš„effect
let activeEffect: ReactiveEffect
type EffectKey = string
type IDep = ReactiveEffect
// è¿™ä¸ªtrackçš„å®ç°é€»è¾‘å¾ˆç®€å•ï¼šæ·»åŠ ä¾èµ–
export function track(target: Record<EffectKey, any>, key: EffectKey) {
  // å¯»æ‰¾depä¾èµ–çš„æ‰§è¡Œé¡ºåº
  // target -> key -> dep
  let depsMap = targetMap.get(target)
  /**
   * è¿™é‡Œæœ‰ä¸ªç–‘é—®ï¼štargetä¸º{ num: 11 } çš„æ—¶å€™æˆ‘ä»¬èƒ½è·å–åˆ°depsMapï¼Œä¹‹åæˆ‘ä»¬count.num++ï¼Œä¸ºä»€ä¹ˆtargetä¸º{ num: 12 } çš„æ—¶å€™æˆ‘ä»¬è¿˜èƒ½è·å–å¾—åˆ°ç›¸åŒçš„depsMapå‘¢ï¼Ÿ
   * è¿™é‡Œæˆ‘çš„ç†è§£æ˜¯ targetMapçš„keyå­˜çš„åªæ˜¯targetçš„å¼•ç”¨ å­˜çš„å­—ç¬¦ä¸²å°±ä¸ä¸€æ ·äº†
   */
  // è§£å†³åˆå§‹åŒ–æ²¡æœ‰depsMapçš„æƒ…å†µ
  if (!depsMap) {
    depsMap = new Map()
    targetMap.set(target, depsMap)
  }
  // depsæ˜¯ä¸€ä¸ªSetå¯¹è±¡ï¼Œå­˜æ”¾ç€è¿™ä¸ªkeyç›¸å¯¹åº”çš„æ‰€æœ‰ä¾èµ–
  let deps = depsMap.get(key)
  // å¦‚æœæ²¡æœ‰keyç›¸å¯¹åº”çš„Set åˆå§‹åŒ–Set
  if (!deps) {
    deps = new Set()
    depsMap.set(key, deps)
  }
  // å°†activeEffectå®ä¾‹å¯¹è±¡addç»™deps
  deps.add(activeEffect)
}
// è¿™ä¸ªtriggerçš„å®ç°é€»è¾‘å¾ˆç®€å•ï¼šæ‰¾å‡ºtargetçš„keyå¯¹åº”çš„æ‰€æœ‰ä¾èµ–ï¼Œå¹¶ä¾æ¬¡æ‰§è¡Œ
export function trigger(target: Record<EffectKey, any>, key: EffectKey) {
  const depsMap = targetMap.get(target)
  const deps = depsMap?.get(key)
  if (deps) {
    for (let dep of deps) {
      dep.run()
    }
  }
}
// æ ¹æ®å®˜æ–¹ç»™å‡ºçš„ä»‹ç»ï¼šeffectä¼šç«‹å³è§¦å‘è¿™ä¸ªå‡½æ•°ï¼ŒåŒæ—¶å“åº”å¼è¿½è¸ªå…¶ä¾èµ–
export function effect(fn: Function, option = {}) {
  let _reactiveFunc = new ReactiveEffect(fn)
  _reactiveFunc.run()
}

```
```typescript
// in reactive.ts

import { track, trigger } from './effect'

export function reactive(target: Record<string, any>) {
  return new Proxy(target, {
    get(target, key) {
      let res = Reflect.get(target, key)
      // ä¾èµ–æ”¶é›†
      track(target, key as string)
      return res
    },
    set(target, key, value) {
      let success: boolean
      success = Reflect.set(target, key, value)
      // è§¦å‘ä¾èµ–
      trigger(target, key as string)
      return success
    }
  })
}

```
```typescript
// in effect.spec.ts

import { effect } from '../index'
import { reactive } from '../index'
describe('effect test', () => {
  it('effect', () => {
    // åˆ›å»ºproxyä»£ç†
    let count = reactive({ num: 11 })
    let result = 0
    // ç«‹å³æ‰§è¡Œeffectå¹¶è·Ÿè¸ªä¾èµ–
    effect(() => {
      // count.numè§¦å‘get å­˜å‚¨ä¾èµ–
      result = count.num + 1
    })
    expect(result).toBe(12)
    // è¿™é‡Œä¼šå…ˆè§¦å‘proxyçš„getæ“ä½œå†è§¦å‘proxyçš„setæ“ä½œï¼Œè§¦å‘ä¾èµ–trigger æ›´æ–°result
    count.num++
    expect(result).toBe(13)
  })
})

```
