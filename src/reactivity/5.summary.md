# ğŸš€ å®ç° computed å’Œ proxyRefs åŠŸèƒ½ ä¸”åˆ©ç”¨ Jest æµ‹è¯•
> å±±ä¸åœ¨é«˜ï¼Œæœ‰ä»™åˆ™åã€‚æ°´ä¸åœ¨æ·±ï¼Œæœ‰é¾™åˆ™çµã€‚ â€”â€” åˆ˜ç¦¹é”¡ã€Šé™‹å®¤é“­ã€‹

## å‰è¨€
ä¸Šç¯‡å¯¹`ref`å®ç°çš„æš‚å‘Šä¸€æ®µè½ï¼Œè¿˜æ²¡çœ‹è¿‡ä¸Šä¸€ç¯‡çš„çœ‹è¿™é‡ŒğŸ‰
> [ğŸš€å®ç° shallowReadonly å’Œ ref åŠŸèƒ½ ä¸”åˆ©ç”¨ Jest æµ‹è¯•](https://juejin.cn/post/7093166158991327239)

æ¥ä¸‹æ¥æˆ‘ä»¬æ¥å®ç°ä¸€ä¸ªç®€å•çš„è®¡ç®—å±æ€§`computed`ï¼Œå¹¶ä¸”åˆ©ç”¨ Jest æµ‹è¯•å®ƒçš„å˜åŒ–ã€‚

æœ¬ç¯‡æ–‡ç« å†…å®¹åŒ…æ‹¬ï¼š

1. è®²è§£ isRef çš„å®ç°æ€è·¯å’Œä»£ç å®ç°
2. è®²è§£ unref çš„å®ç°æ€è·¯å’Œä»£ç å®ç°
3. è®²è§£ proxyRefs çš„å®ç°æ€è·¯å’Œä»£ç å®ç°
4. è®²è§£ computed çš„å®ç°æ€è·¯å’Œä»£ç å®ç°


> ğŸ¤£ å¦‚æœ‰é”™æ¼ï¼Œè¯·å¤šæŒ‡æ•™ â¤

## å®ç° isRef

> æ£€æŸ¥å€¼æ˜¯å¦ä¸ºä¸€ä¸ª ref å¯¹è±¡ã€‚

ä»¥ä¸‹æ˜¯æµ‹è¯•ç”¨ä¾‹ï¼š
```typescript
test('isRef', () => {
  expect(isRef(ref(1))).toBe(true)

  expect(isRef(0)).toBe(false)
  expect(isRef(1)).toBe(false)
  // an object that looks like a ref isn't necessarily a ref
  expect(isRef({ value: 0 })).toBe(false)
})
```

æˆ‘ä»¬å¯ä»¥å®šä¹‰ä¸€ä¸ª`isRef`å‡½æ•°ï¼Œå…¥å‚ä¼ å…¥ä¸€ä¸ªå¯¹è±¡ï¼Œå†…éƒ¨é€šè¿‡æœ‰æ„çš„è®¿é—®ä¸€ä¸ªåªæœ‰ ref æ‰æœ‰çš„å…¬æœ‰å±æ€§ï¼Œæ¥åˆ¤æ–­è¿™ä¸ªå¯¹è±¡æ˜¯å¦æ˜¯refå¯¹è±¡ã€‚

```typescript
class RefImpl<T> {
  ...
  public __v_isRef = true // æ ‡è¯†æ˜¯refå¯¹è±¡
  constructor(value: any) {
    ...
  }
  ...
}
// æ£€æŸ¥å€¼æ˜¯å¦ä¸ºä¸€ä¸ª ref å¯¹è±¡ã€‚
export function isRef(ref: any) {
  return !!(ref && ref.__v_isRef)
}
```
`(ref && ref.__v_isRef)`æœ‰å¯èƒ½ä¸ºundefinedï¼Œæ‰€ä»¥æˆ‘ä»¬åŠ ä¸Š`!!`è®©`undefined`è½¬ä¸º`boolean`ç±»å‹ã€‚


## å®ç° unref

> å¦‚æœå‚æ•°æ˜¯ä¸€ä¸ª refï¼Œåˆ™è¿”å›å†…éƒ¨å€¼ï¼Œå¦åˆ™è¿”å›å‚æ•°æœ¬èº«ã€‚è¿™æ˜¯ val = isRef(val) ? val.value : val çš„è¯­æ³•ç³–å‡½æ•°ã€‚

ä»¥ä¸‹æ˜¯æµ‹è¯•ç”¨ä¾‹ï¼š
```typescript
test('isRef', () => {
  expect(isRef(ref(1))).toBe(true)

  expect(isRef(0)).toBe(false)
  expect(isRef(1)).toBe(false)
  // an object that looks like a ref isn't necessarily a ref
  expect(isRef({ value: 0 })).toBe(false)
})
```

åŸºæœ¬çš„å®ç°åŸç†å°±æ˜¯`val = isRef(val) ? val.value : val`

```typescript
export function unref(ref: any) {
  return isRef(ref) ? ref.value : ref
}
```

## å®ç° proxyRefs

è™½ç„¶ `proxyRefs`å¹¶æ²¡æœ‰åœ¨å®˜æ–¹æ–‡æ¡£ç»™å‡ºä»‹ç»å’Œapiç”¨æ³•ï¼Œä½†æ˜¯å®ƒçš„å®é™…ä½œç”¨æ˜¯åœ¨`<template></template>`æ¨¡æ¿é‡Œé¢è§£æ„å‡ºrefçš„valueï¼Œè¿™æ ·æˆ‘ä»¬åœ¨æ¨¡æ¿é‡Œé¢å°±ä¸éœ€è¦å†ä¹¦å†™.valueæ¥è·å–refçš„å€¼äº†ã€‚å®ƒåŒæ—¶å…¼å®¹reactiveå¯¹è±¡çš„ä¼ å…¥ã€‚

### æµ‹è¯•ç”¨ä¾‹

```typescript
test('proxyRefs', ()=>{
  const user = {
    age: ref(10),
    name: 'ghx'
  }
  const original = {
    k: 'v'
  }
  const r1 = reactive(original)
  // ä¼ å…¥reactiveå¯¹è±¡
  const p1 = proxyRefs(r1)
  // objectWithRefså¯¹è±¡ ï¼ˆå¸¦ref çš„objectï¼‰
  const proxyUser = proxyRefs(user)

  expect(p1).toBe(r1)

  expect(user.age.value).toBe(10)
  expect(proxyUser.age).toBe(10)
  expect(proxyUser.name).toBe('ghx')

  proxyUser.age = 20
  expect(proxyUser.age).toBe(20)
  expect(user.age.value).toBe(20)

  proxyUser.age = ref(10)
  proxyUser.name = 'superman'
  expect(proxyUser.age).toBe(10)
  expect(proxyUser.name).toBe('superman')
  expect(user.age.value).toBe(10)
})
```

### ç‰¹ç‚¹

* å¦‚æœå…¥å‚æ˜¯reactiveå¯¹è±¡ï¼Œé‚£ä¹ˆç›´æ¥è¿”å›reactiveã€‚

* å¦‚æœå…¥å‚æ˜¯å­å±æ€§å€¼å¸¦refå¯¹è±¡çš„æ™®é€šå¯¹è±¡ï¼Œé‚£ä¹ˆè¿”å›ä¸€ä¸ªproxyå¯¹è±¡ï¼Œå…¶ä¸­çš„å±æ€§å€¼æ˜¯refå¯¹è±¡çš„å±æ€§ï¼Œé€šè¿‡è°ƒç”¨`unref`å‡½æ•°è·å–å®é™…çš„å€¼ï¼ˆ.valueï¼‰ã€‚

setæ“ä½œæˆ‘ä»¬ä¹Ÿå¾—åŒºåˆ†ä¸¤ç§æƒ…å†µï¼š

èµ‹å€¼æ“ä½œçŠ¶æ€ä¸‹

1. å¦‚æœå±æ€§ä¸ºrefå¯¹è±¡ï¼Œå¹¶ä¸”å€¼ä¸ºæ™®é€šç±»å‹ï¼Œé‚£ä¹ˆéœ€è¦æŠŠå€¼èµ‹ç»™refå¯¹è±¡çš„.valueå±æ€§ã€‚
  ```typescript
  const user = {
    age: ref(10),
    name: 'ghx'
  }
  const proxyUser = proxyRefs(user)
  proxyUser.age = 20
  expect(proxyUser.age).toBe(20)
  expect(user.age.value).toBe(20)
  ```
2. å¦åˆ™å…¶ä»–æƒ…å†µä¸‹éƒ½åº”è¯¥æŠŠå€¼ç›´æ¥èµ‹å€¼ç»™å±æ€§ã€‚
  ```typescript
  proxyUser.age = ref(10)
  proxyUser.name = 'superman'
  expect(proxyUser.age).toBe(10)
  expect(proxyUser.name).toBe('superman')
  expect(user.age.value).toBe(10)
  ```
### åŸºæœ¬å®ç°
```typescript
export function proxyRefs<T extends object>(obj: T){
  return isReactive(obj)
    ? obj
    : new Proxy<any>(obj, {
    get(target, key){
      // unrefå·²ç»å¤„ç†äº†objæ˜¯å¦refçš„æƒ…å†µæ‰€ä»¥æˆ‘ä»¬ä¸éœ€è¦è‡ªå·±ifå¤„ç†ï¼Œå¦‚æœæ˜¯ï¼Œè¿”å›.valueï¼Œå¦‚æœä¸æ˜¯ï¼Œç›´æ¥è¿”å›å€¼
      return unref(Reflect.get(target, key)) 
    },
    set(target, key, value){
      // å› ä¸ºvalueä¸ºæ™®é€šå€¼ç±»å‹çš„æƒ…å†µç‰¹æ®Šï¼Œè¦æŠŠvalueèµ‹å€¼ç»™refçš„.value
      if (isRef(target[key]) && !isRef(value)) {
        target[key].value = value
        return true
      } else {
        return Reflect.set(target, key, value)
      }
    }
  })
}
```


## å®ç° computed

åœ¨`<template></template>`ä¸­æ”¾å…¥è¿‡å¤šçš„è®¡ç®—é€»è¾‘ä¼šè®©æ¨¡æ¿éš¾ä»¥ç»´æŠ¤

```html
<h1>My book: </h1>
<div>{{ghx.books.length > 10 ? 'å¤š' : 'å°‘'}}<div>
<div>{{ghx.books.length > 10 ? 'å¤š' : 'å°‘'}}<div>
<div>{{ghx.books.length > 10 ? 'å¤š' : 'å°‘'}}<div>
<div>{{ghx.books.length > 10 ? 'å¤š' : 'å°‘'}}<div>
<div>{{ghx.books.length > 10 ? 'å¤š' : 'å°‘'}}<div>
<div>{{ghx.books.length > 10 ? 'å¤š' : 'å°‘'}}<div>
```

è¿™æ—¶å€™çš„templateå°±ä¸å•å•æ˜¯ç®€å•çš„ï¼Œå®ƒåŒ…å«äº†ä¸€äº›é€»è¾‘ï¼Œè®©æ•´ä½“ä¸Šçš„templateçœ‹èµ·æ¥æ›´åŠ å¤æ‚ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨computedã€‚

### ç‰¹ç‚¹
1. å…·æœ‰å¯¹æ•°æ®çš„å“åº”ä¾èµ–å…³ç³»çš„ç¼“å­˜åŠŸèƒ½ã€‚computedçš„ä¾èµ–æ²¡æœ‰æ›´æ–°çš„æƒ…å†µä¸‹ï¼Œ**å†æ¬¡**å‘ç”Ÿrefå¯¹è±¡çš„getæ“ä½œå¹¶ä¸ä¼šå¯¼è‡´æ•°æ®çš„é‡æ–°è®¡ç®—ã€‚
2. æ‡’è®¡ç®—ã€‚computedçš„ä¾èµ–è¢«æ›´æ–°ï¼Œä¹Ÿä¸ä¼šç«‹å³é‡æ–°è®¡ç®—ç»“æœï¼Œè€Œæ˜¯å½“computedè¿”å›çš„refå¯¹è±¡å‘ç”Ÿgetæ“ä½œçš„æ—¶å€™æ‰ä¼šè®¡ç®—ç»“æœã€‚

### åŸºæœ¬ç”¨æ³•
```typescript
// ç¬¬ä¸€ç§ï¼š
const count = ref(1)
const plusOne = computed(() => count.value + 1)

console.log(plusOne.value) // 2

plusOne.value++ // é”™è¯¯

// ç¬¬äºŒç§ï¼š
const count = ref(1)
const plusOne = computed({
  get: () => count.value + 1,
  set: val => {
    count.value = val - 1
  }
})

plusOne.value = 1
console.log(count.value) // 0
```

computedå¯ä»¥æ¥æ”¶ä¸€ä¸ªå…·æœ‰getå’Œsetæ–¹æ³•çš„å¯¹è±¡ä½œä¸ºå‚æ•°ï¼Œä¹Ÿå¯ä»¥æ¥æ”¶ä¸€ä¸ªgetæ–¹æ³•ä½œä¸ºå‚æ•°ï¼Œéƒ½è¿”å›ä¸€ä¸ªrefå¯¹è±¡ã€‚

è¿™å°±è¦ç”¨åˆ°å‡½æ•°é‡è½½äº†ã€‚

* å½“computedåªæ¥å—ä¸€ä¸ªgetæ–¹æ³•çš„æ—¶å€™ï¼Œé‚£ä¹ˆè¯¥computedä¸ºåªè¯»ï¼Œå†™å…¥æ•°æ®å°†ä¼šå¾—åˆ°ä¸€ä¸ªé”™è¯¯
* å½“computedæ¥å—å…·æœ‰getå’Œsetæ–¹æ³•çš„å¯¹è±¡çš„æ—¶å€™ï¼Œé‚£ä¹ˆè¯¥computedä¸ºå¯è¯»å†™

æˆ‘ä»¬é€šå…³çš„å½¢å¼æ¥å®ç°computedï¼Œæ€»å…±æœ‰ä¸¤å…³ï¼Œç¬¬ä¸€å…³ç®€å•å®ç°computedç±»ï¼Œç¬¬äºŒå…³å®ç°computedçš„æ‡’è®¡ç®—å’Œç¼“å­˜åŠŸèƒ½

1. **ç¬¬ä¸€å…³çš„æµ‹è¯•ç”¨ä¾‹**
```typescript
it('should return updated value', () => {
  const value = reactive({ foo: 1 })
  const cValue = computed(() => value.foo)
  expect(cValue.value).toBe(1)
})
```
åˆ›å»ºä¸€ä¸ª`computed`å‡½æ•°ï¼Œé¡ºä¾¿å®šä¹‰getå’Œsetçš„ç±»å‹ï¼Œå¯¹ä¸åŒå‡½æ•°ç­¾åè¿›è¡Œé‡è½½

```typescript
type ComputedGetter<T> = (...args: any[])=> T
// v æ˜¯ è¦å¸¦èµ‹å€¼çš„å€¼
type ComputedSetter<T> = (v: T) => void
interface WritableComputedOptions<T> {
  get: ComputedGetter<T>;
  set: ComputedSetter<T>;
}
export function computed<T>(option: WritableComputedOptions<T>): any
export function computed<T>(getter: ComputedGetter<T>): ComputedRefImpl<T>
// å®ç°å‡½æ•°ç­¾å
export function computed<T>(getterOrOption: ComputedGetter<T> | WritableComputedOptions<T>){
  let getter: ComputedGetter<T>
  let setter: ComputedSetter<T>
  if (isFunction(getterOrOption)) {
    getter = getterOrOption
    setter = () => console.error('é”™è¯¯, å› ä¸ºæ˜¯getteråªè¯», ä¸èƒ½èµ‹å€¼')
  } else {
    getter = getterOrOption.get
    setter = getterOrOption.set
  }
  return new ComputedRefImpl(getter, setter)
}
```
æ¥ç€æˆ‘ä»¬æ¥å®ç°`ComputedRefImpl`ç±»ã€‚

æˆ‘ä»¬å¸Œæœ›çš„computedï¼Œä»–æ˜¯å¯ä»¥ä½¿ç”¨`.value`æ¥è®¿é—®å€¼çš„ï¼Œå¹¶èƒ½æ§åˆ¶valueçš„è¯»å†™æ“ä½œï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨å†…éƒ¨å®šä¹‰ä¸€ä¸ªç§æœ‰å±æ€§`_value`ï¼Œç„¶åé€šè¿‡å–å€¼å‡½æ•°`getter`å’Œå­˜å€¼å‡½æ•°`setter`æ§åˆ¶æˆ‘ä»¬çš„valueï¼Œå½“ç”¨æˆ·è§¦å‘getæ“ä½œçš„æ—¶å€™ï¼Œæˆ‘ä»¬ä¼šä¼ å…¥çš„getterå‡½æ•°ï¼ŒæŠŠè¿”å›å€¼ä¼ å›ç»™`_value`ï¼Œå½“ç”¨æˆ·è§¦å‘setæ“ä½œçš„æ—¶å€™ï¼Œ`set value(newValue)`çš„newValueä¼šä¼ ç»™ç”¨æˆ·ä¼ è¿›æ¥çš„setterå‡½æ•°ã€‚
```typescript
export class ComputedRefImpl<T> {
  private _value!: T
  public _getter: ComputedGetter<T>
  constructor(
    getter: ComputedGetter<T>,
    private setter: ComputedSetter<T>
  ) {
    this._getter = getter
  }
  get value() {
    // å¦‚ä½•ç»™dirtyé‡æ–°èµ‹å€¼ä¸ºtrue, è§¦å‘ä¾èµ–,è°ƒç”¨effectçš„scheduler()
    this._value = this.getter()
    return this._value
  }
  set value(newValue: T) {
    this.setter(newValue)
  }
}
```
åˆ°æ­¤ä¸Šé¢çš„æµ‹è¯•ç”¨ä¾‹å°±èƒ½è·‘é€šäº†ã€‚

2. **ç¬¬äºŒå…³çš„æµ‹è¯•ç”¨ä¾‹**

çœ‹èµ·æ¥æœ‰ç‚¹å¤æ‚ï¼Œæˆ‘ä»¬é€šè¿‡æ³¨é‡Šè®²è§£ä¸€ä¸‹æ¯ä¸€æ­¥å§ã€‚
```typescript
it('should compute lazily', () => {
  const value = reactive({ foo: 1 })   // åˆ›å»ºä¸€ä¸ªreactiveå¯¹è±¡
  const getter = jest.fn(() => value.foo) // é€šè¿‡jest.fn()åˆ›å»ºä¸€ä¸ªæ¨¡æ‹Ÿå‡½æ•°ï¼Œåç»­ä¼šæ£€æµ‹è¢«è°ƒç”¨è¯¥å‡½æ•°æ¬¡æ•°
  const cValue = computed(getter)   // åˆ›å»ºä¸€ä¸ªcomputedå¯¹è±¡ï¼Œå¹¶ä¼ å…¥getterå‡½æ•°

  // lazyåŠŸèƒ½
  expect(getter).not.toHaveBeenCalled() // å› ä¸ºè¿˜æ²¡è§¦å‘cValueçš„getæ“ä½œï¼Œæ‰€ä»¥getteræ˜¯ä¸ä¼šè¢«è°ƒç”¨çš„ã€‚

  expect(cValue.value).toBe(1)   // cValueçš„getæ“ä½œè¢«è§¦å‘ï¼Œgetteræ‰§è¡Œ
  expect(getter).toHaveBeenCalledTimes(1) // getterè¢«è°ƒç”¨ä¸€æ¬¡
  // ç¼“å­˜åŠŸèƒ½
  // should not compute again
  cValue.value                   // cValueçš„getæ“ä½œè¢«è§¦å‘ï¼Œåˆå› ä¸ºvalue.fooå¹¶æ²¡æœ‰å‘ç”Ÿæ”¹å˜
  expect(getter).toHaveBeenCalledTimes(1) // è¿™é‡Œçš„getterè¿˜æ˜¯è¢«è°ƒç”¨äº†ä¸€æ¬¡

  // should not compute until needed
  value.foo = 2                    // è¿™é‡Œçš„value.fooå‘ç”Ÿäº†æ”¹å˜ï¼Œä½†æ˜¯cValueçš„getæ“ä½œè¿˜æ²¡è¢«è§¦å‘
  expect(getter).toHaveBeenCalledTimes(1) // æ‰€ä»¥è¿™é‡Œgetterä»ç„¶åªä¼šè¢«è°ƒç”¨ä¸€æ¬¡

  // now it should compute
  expect(cValue.value).toBe(2)     // è¿™é‡Œçš„cValueçš„getæ“ä½œè¢«è§¦å‘ï¼Œgetteræ‰§è¡Œ
  expect(getter).toHaveBeenCalledTimes(2) // è¿™é‡Œgetterè¢«è°ƒç”¨äº†ä¸¤æ¬¡
  // should not compute again
  cValue.value                     // cValueçš„getæ“ä½œè¢«è§¦å‘ï¼Œåˆå› ä¸ºvalue.fooå¹¶æ²¡æœ‰å‘ç”Ÿæ”¹å˜
  expect(getter).toHaveBeenCalledTimes(2) // è¿™é‡Œçš„getterè¿˜æ˜¯è¢«è°ƒç”¨äº†ä¸¤æ¬¡
})
```

## æ€»ç»“

## æœ€å@æ„Ÿè°¢é˜…è¯»

## å®Œæ•´ä»£ç 
