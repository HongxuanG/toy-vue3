# ğŸš€å®ç° shallowReadonly å’Œ ref åŠŸèƒ½ ä¸”åˆ©ç”¨ Jest æµ‹è¯•

> å±±ä¸åœ¨é«˜ï¼Œæœ‰ä»™åˆ™åã€‚æ°´ä¸åœ¨æ·±ï¼Œæœ‰é¾™åˆ™çµã€‚ â€”â€” åˆ˜ç¦¹é”¡ã€Šé™‹å®¤é“­ã€‹

## å‰è¨€

ä¸Šç¯‡å¯¹ reactive & effect çš„è¡¥å……æš‚å‘Šä¸€æ®µè½ï¼Œè¿˜æ²¡çœ‹è¿‡ä¸Šä¸€ç¯‡çš„çœ‹è¿™é‡Œ ğŸ‰

> [ğŸš€reactive & effect ä¸”åˆ©ç”¨ Jest æµ‹è¯•å®ç°æ•°æ®å“åº”å¼ï¼ˆä¸€ï¼‰](https://juejin.cn/post/7089244580394041375)
>
> [ğŸš€reactive & effect ä¸”åˆ©ç”¨ Jest æµ‹è¯•å®ç°æ•°æ®å“åº”å¼ï¼ˆäºŒï¼‰](https://juejin.cn/post/7090165509735317534)

> [ğŸš€å®ç° isReactive & isReadonly ä¸”åˆ©ç”¨ Jest æµ‹è¯•å®ç°æ•°æ®å“åº”å¼ï¼ˆä¸€ï¼‰](https://juejin.cn/post/7091866529414774814)

æ•´ç¯‡æ–‡ç« çš„é€šè¿‡`TDD`æµ‹è¯•é©±åŠ¨å¼€å‘ï¼Œå¸¦ä½ ä¸€æ­¥ä¸€æ­¥å®ç° vue3 æºç ã€‚

æœ¬ç¯‡æ–‡ç« å†…å®¹åŒ…æ‹¬ï¼š

1. è®²è§£ shallowReadonly å’Œ shallowReactive çš„å®ç°
2. è®²è§£ isShallow çš„å®ç°æ€è·¯
3. è®²è§£ isProxy çš„å®ç°æ€è·¯
4. è®²è§£ toRaw çš„å®ç°æ€è·¯
5. è®²è§£ ref çš„å®ç°æ€è·¯

> ğŸ¤£ å¦‚æœ‰é”™æ¼ï¼Œè¯·å¤šæŒ‡æ•™ â¤

## å®ç° shallowReadonly

é¦–å…ˆè¦ææ¸…æ¥š shallowReadonly æ˜¯ä»€ä¹ˆä¸œè¥¿ï¼Œä»¥åŠå®ƒçš„ç”¨æ³•ï¼Œå’±ä»¬æ‰å¥½å¾€ä¸‹å®ç°å®ƒã€‚

[å®˜æ–¹è¯´æ˜](https://v3.cn.vuejs.org/api/basic-reactivity.html#shallowreadonly)

> åˆ›å»ºä¸€ä¸ª proxyï¼Œä½¿å…¶è‡ªèº«çš„ property ä¸ºåªè¯»ï¼Œä½†ä¸æ‰§è¡ŒåµŒå¥—å¯¹è±¡çš„æ·±åº¦åªè¯»è½¬æ¢ï¼ˆæš´éœ²åŸå§‹å€¼ï¼‰

æˆ‘ä»¬é€å¥è®²è§£ï¼š

1. **åˆ›å»ºä¸€ä¸ª proxy**

   è·Ÿ readonly ä¸€æ ·ï¼Œæˆ‘ä»¬ä¹Ÿéœ€è¦ new ä¸€ä¸ª Proxyï¼Œå¹¶é€šè¿‡ä¼ å…¥ handlerã€‚

2. **ä½¿å…¶è‡ªèº«çš„ property ä¸ºåªè¯»**

   è·Ÿ readonly ä¸€æ ·ï¼Œæˆ‘ä»¬éœ€è¦ä¼ å…¥ handler çš„ getter å’Œ setterï¼Œç”¨æˆ·å¯¹æ•°æ®è¿›è¡Œ set èµ‹å€¼æ“ä½œçš„æ—¶å€™ä¼šå¾—åˆ°ä¸€ä¸ªè­¦å‘Šã€‚

3. **ä¸æ‰§è¡ŒåµŒå¥—å¯¹è±¡çš„æ·±åº¦åªè¯»è½¬æ¢**

   ä¸ readonly ä¸ä¸€æ ·çš„åœ°æ–¹åœ¨äºï¼Œæˆ‘ä»¬ä¸ç”¨é€šè¿‡`isObject()`åˆ¤æ–­ get æ“ä½œä¹‹åå¾—åˆ°çš„`res`æ˜¯å¦æ˜¯å¯¹è±¡ç„¶åå†æ¬¡æ‰§è¡Œ readonly(res)ã€‚åªéœ€è¦åˆ¤æ–­æ•°æ®æ˜¯å¦ isShallowï¼Œå¦‚æœæ˜¯ï¼Œç›´æ¥`return res`å³å¯ã€‚

ä¸‹é¢æ˜¯æˆ‘ä»¬çš„æµ‹è¯•ç”¨ä¾‹ï¼š

```typescript
it('shallowReadonly basic test', () => {
  let original = {
    foo: {
      name: 'ghx',
    },
  }
  let obj = shallowReadonly(original)
  expect(isReadonly(obj)).toBe(true)
  // å› ä¸ºåªåšè¡¨å±‚çš„readonlyï¼Œæ·±å±‚çš„æ•°æ®è¿˜ä¸æ˜¯proxy
  expect(isReadonly(obj.foo)).toBe(false)
  expect(isReactive(obj.foo)).toBe(false)
})
```

1. **åˆ›å»ºä¸€ä¸ª proxy**éœ€è¦ä¼ å…¥ä¸ä¸€æ ·çš„ handlers

```typescript
export function shallowReadonly<T>(target: T) {
  return createReactiveObject(target, shallowReadonlyHandlers)
}
```

2. **ä½¿å…¶è‡ªèº«çš„ property ä¸ºåªè¯»**

è¿™é‡Œæˆ‘é€šè¿‡ extend æ‹“å±•äº†ä¸€ä¸‹`readonlyhandlers`ï¼Œä½†æ˜¯ get æ“ä½œéœ€è¦å•ç‹¬å¤„ç†ã€‚

```typescript
export const shallowReadonlyHandlers: ProxyHandler<object> = extend({}, readonlyHandlers, {
  get: shallowReadonlyGet,
})
```

3. **ä¸æ‰§è¡ŒåµŒå¥—å¯¹è±¡çš„æ·±åº¦åªè¯»è½¬æ¢**

   åˆ¤æ–­æ•°æ®æ˜¯å¦ isShallowï¼Œæ”¹å†™`createGetter`ï¼ŒåŠ å¤šä¸€ä¸ªå…¥å‚`isShallow`

```typescript
export function createGetter<T extends object>(isReadonly = false, isShallow = false) {
  return function get(target: T, key: string | symbol) {
    if (key === ReactiveFlags.IS_REACTIVE) {
      return !isReadonly
    } else if (key === ReactiveFlags.IS_READONLY) {
      return isReadonly
    }
    let res = Reflect.get(target, key)

    if (!isReadonly) {
      track(target, key as string)
    }
    // è¿™å¥æ˜¯å½“å‰åŠŸèƒ½çš„å…³é”®
    if (isShallow) {
      return res
    }
    if (isObject(res)) {
      return isReadonly ? readonly(res) : reactive(res)
    }
    return res
  }
}
```

ä¸ºä»€ä¹ˆä¸æŠŠ isShallow åˆ¤æ–­æ”¾åœ¨ isReadonly ä¹‹å‰ï¼Ÿ

è¿™å°±æ¶‰åŠåˆ°åé¢çš„ shallowReactive å®ç°äº†ï¼ŒshallowReactive é™¤äº†è¦è¿”å› get åˆ°çš„å€¼ä¹‹å¤–ï¼ŒåŒæ—¶è¿˜è¦è¿›è¡Œä¾èµ–æ”¶é›†ã€‚

ä¹‹ååˆ›å»ºä¸€ä¸ªå¸¸é‡ç”¨äºç¼“å­˜ createGetter è¿”å›çš„å‡½æ•°å³å¯ã€‚

```typescript
const shallowReadonlyGet = createGetter(true, true)
```

## å®ç° shallowReactive

[å®˜æ–¹è¯´æ˜](https://v3.cn.vuejs.org/api/basic-reactivity.html#shallowreactive)

> åˆ›å»ºä¸€ä¸ªå“åº”å¼ä»£ç†ï¼Œå®ƒè·Ÿè¸ªå…¶è‡ªèº« property çš„å“åº”æ€§ï¼Œä½†ä¸æ‰§è¡ŒåµŒå¥—å¯¹è±¡çš„æ·±å±‚å“åº”å¼è½¬æ¢ (æš´éœ²åŸå§‹å€¼)ã€‚

```typescript
// shallowReactiveçš„getæ“ä½œ
const shallowGet = createGetter(false, true)
// shallowReactiveçš„setæ“ä½œ
const shallowSet = createSetter(true)

export const shallowReactiveHandlers: ProxyHandler<object> = extend({}, mutableHandlers, {
  get: shallowGet,
  set: shallowSet,
})
export function shallowReactive<T extends object>(target: T) {
  return createReactiveObject<T>(target, shallowReactiveHandlers)
}
```
ä¸Šé¢æœ‰è®²isShallowï¼Œé‚£æˆ‘ä»¬ä¹Ÿå®ç°ä¸€ä¸ªåˆ¤æ–­æ˜¯å¦å¼€å¯shallowæ¨¡å¼çš„å‡½æ•°å§ã€‚
## å®ç°isShallow

```typescript
export enum ReactiveFlags {
  IS_REACTIVE = '__v_isReactive',
  IS_READONLY = '__v_isReadonly',
  IS_SHALLOW = '__v_isShallow',
  RAW = '__v_raw'
}
// æ£€æŸ¥å¯¹è±¡æ˜¯å¦ å¼€å¯ shallow mode
export function isShallow(value: unknown){
  return !!(value as Target)[ReactiveFlags.IS_SHALLOW]
}
```
ä¸Šé¢å°±æ˜¯æ•…æ„è§¦å‘proxyçš„getæ“ä½œï¼Œå› ä¸º`createGetter()`çš„å…¥å‚æœ‰ä¸ª`isShallow`ï¼Œè¿™å·²ç»ä¸ºæˆ‘ä»¬æ ‡è¯†å½“å‰proxyæ˜¯å¦æ˜¯shallowäº†ã€‚

æˆ‘ä»¬æ”¹å†™ä»¥ä¸‹createGetterï¼ŒåŠ å¤šä¸€å±‚åˆ¤æ–­ï¼Œå¦‚æœgetæ“ä½œçš„`key`å€¼æ˜¯`ReactiveFlags.IS_SHALLOW`ï¼Œé‚£ä¹ˆç›´æ¥è¿”å›å…¥å‚`isShallow`çš„çŠ¶æ€ã€‚

```typescript
export function createGetter<T extends object>(isReadonly = false, isShallow = false) {
  return function get(target: T, key: string | symbol) {
    // isReactiveå’ŒisReadonly éƒ½æ˜¯æ ¹æ®ä¼ å…¥çš„å‚æ•° `isReadonly`æ¥å†³å®šæ˜¯å¦è¿”å›true | falseçš„
    if (key === ReactiveFlags.IS_REACTIVE) {
      return !isReadonly
    } else if (key === ReactiveFlags.IS_READONLY) {
      return isReadonly
    } else if (key === ReactiveFlags.IS_SHALLOW) {
      //  ä¸»è¦ä»£ç ï¼š
      return isShallow
    } else if (key === ReactiveFlags.RAW) {
      return target
    }
    let res = Reflect.get(target, key)

    if (!isReadonly) {
      track(target, key as string)
    }
    if (isShallow) {
      return res
    }
    if (isObject(res)) {
      return isReadonly ? readonly(res) : reactive(res)
    }
    return res
  }
}
```
## å®ç° isProxy

[å®˜æ–¹è¯´æ˜](https://v3.cn.vuejs.org/api/basic-reactivity.html#isproxy)

> æ£€æŸ¥å¯¹è±¡æ˜¯å¦æ˜¯ç”± reactive æˆ– readonly åˆ›å»ºçš„ proxyã€‚

åˆ¤æ–­ reactive å’Œ readonly ç”Ÿæˆçš„ proxyï¼Œåœ¨ä¸Šä¸€ç« èŠ‚å·²ç»è®²äº†ï¼Œæ‰€ä»¥è¿™é‡Œå®ç°èµ·æ¥æ¯”è¾ƒå®¹æ˜“ã€‚

```typescript
export function isProxy(value: unknown) {
  return isReactive(value) || isReadonly(value)
}
```

## å®ç° toRaw åŠŸèƒ½

[å®˜æ–¹è¯´æ˜](https://v3.cn.vuejs.org/api/basic-reactivity.html#toraw)

> è¿”å› reactive æˆ– readonly ä»£ç†çš„åŸå§‹å¯¹è±¡ã€‚è¿™æ˜¯ä¸€ä¸ªâ€œé€ƒç”Ÿèˆ±â€ï¼Œå¯ç”¨äºä¸´æ—¶è¯»å–æ•°æ®è€Œæ— éœ€æ‰¿æ‹…ä»£ç†è®¿é—®/è·Ÿè¸ªçš„å¼€é”€ï¼Œä¹Ÿå¯ç”¨äºå†™å…¥æ•°æ®è€Œé¿å…è§¦å‘æ›´æ”¹

æ€»è€Œè¨€ä¹‹å°±æ˜¯å¯ä»¥é€šè¿‡`toRaw`è·å–åˆ°`reactive`æˆ–è€…`readonly`çš„åŸå§‹å€¼ã€‚

ä»¥ä¸‹æ˜¯æµ‹è¯•ç”¨ä¾‹
```typescript
it('toRaw', () => {
  const original = { foo: 1 }
  const observed = reactive(original)
  // è¾“å‡ºçš„ç»“æœå¿…é¡»è¦ç­‰äºåŸå§‹å€¼
  expect(toRaw(observed)).toBe(original)
  expect(toRaw(original)).toBe(original)
})
it('nested reactive toRaw', () => {
  const original = {
    foo: {
      name: 'ghx',
    },
  }
  const observed = reactive(original)
  const raw = toRaw(observed)
  expect(raw).toBe(original)
  expect(raw.foo).toBe(original.foo)
})
```

æ€ä¹ˆè·å–åŸå§‹æ•°æ®å‘¢ï¼Ÿ

å¯ä»¥åœ¨ get æ“ä½œç›´æ¥ return `get()`çš„ç¬¬ä¸€ä¸ªå‚æ•°`target`ã€‚

é‚£æˆ‘ä»¬æ€ä¹ˆæ‰èƒ½çŸ¥é“ä»€ä¹ˆæ—¶å€™åº”è¯¥ return `target`å‘¢ï¼Ÿæˆ‘ä»¬éœ€è¦ä¸€ä¸ªæ ‡è¯†ï¼Œè¿™ä¸ªæ ‡è¯†ä¹Ÿæ˜¯ä¹‹å‰è®²è¿‡ï¼Œåˆ¤æ–­ isReadonly å’Œ isReactive ä¹Ÿæ˜¯ç”¨çš„è¿™ä¸ªæ ‡è¯†ã€‚

åœ¨ ReactiveFlags å®šä¹‰ä¸€ä¸ªæšä¸¾æˆå‘˜`RAW`ï¼Œç”¨äºæ ‡è®°å½“å‰ get æ“ä½œæ˜¯å› ä¸º raw å¼•èµ·çš„

```typescript
export enum ReactiveFlags {
  IS_REACTIVE = '__v_isReactive',
  IS_READONLY = '__v_isReadonly',
  IS_SHALLOW = '__v_isShallow',
  RAW = '__v_raw',
}
```

ä¹‹åæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡æ•…æ„è§¦å‘`proxy`çš„ get æ“ä½œï¼Œè®© get æ“ä½œ return åŸå§‹å€¼äº†ã€‚

```typescript
// è¿”å› reactive æˆ– readonly ä»£ç†çš„åŸå§‹å¯¹è±¡
export function toRaw<T>(observed: T): T {
  // observedå­˜åœ¨ï¼Œè§¦å‘getæ“ä½œï¼Œåœ¨createGetterç›´æ¥return target
  const raw = observed && (observed as Target)[ReactiveFlags.RAW]
  return raw ? toRaw(raw) : observed
}
```

## å®ç° ref

[å®˜æ–¹è¯´æ˜](https://v3.cn.vuejs.org/api/refs-api.html#ref)

> 1. æ¥å—ä¸€ä¸ªå†…éƒ¨å€¼å¹¶è¿”å›ä¸€ä¸ªå“åº”å¼ä¸”å¯å˜çš„ ref å¯¹è±¡ã€‚ref å¯¹è±¡ä»…æœ‰ä¸€ä¸ª .value propertyï¼ŒæŒ‡å‘è¯¥å†…éƒ¨å€¼ã€‚

> 2. å¦‚æœå°†å¯¹è±¡åˆ†é…ä¸º ref å€¼ï¼Œåˆ™å®ƒå°†è¢« reactive å‡½æ•°å¤„ç†ä¸ºæ·±å±‚çš„å“åº”å¼å¯¹è±¡ã€‚

`å†…éƒ¨å€¼`ä¸€èˆ¬æŒ‡å€¼ç±»å‹ï¼ˆstringï¼Œnumberï¼Œbooleanã€‚ã€‚ã€‚ï¼‰

ä¸ºä»€ä¹ˆè¦æœ‰ ref å‘¢ï¼Œreactive ä¸è¡Œå—ï¼Ÿ

å› ä¸º`reactive`ç”¨çš„æ˜¯ proxyï¼Œè€Œ`proxy`åªèƒ½é’ˆå¯¹å¯¹è±¡å»ç›‘å¬æ•°æ®å˜åŒ–ï¼ŒåŸºæœ¬æ•°æ®ç±»å‹å¹¶ä¸èƒ½ç”¨ proxyã€‚

æ‰€ä»¥æˆ‘ä»¬æƒ³åˆ°äº†`class`é‡Œé¢çš„å–å€¼å‡½æ•° getter å’Œå­˜å€¼å‡½æ•° getterï¼Œä»–ä»¬éƒ½èƒ½åœ¨æ•°æ®å˜åŒ–çš„æ—¶å€™å¯¹æ•°æ®åŠ ä»¥æ“ä½œã€‚

æˆ‘ä»¬ä¾æ—§å¦‚æ­¤ç¼–å†™ä¸€ä¸ªæµ‹è¯•ç”¨ä¾‹æ¥é©±åŠ¨å¼€å‘

```typescript
it('should hold a value', () => {
  const a = ref(1)
  expect(a.value).toBe(1)
  a.value = 2
  expect(a.value).toBe(2)
})
```

å®šä¹‰ä¸€ä¸ª RefImpl ç±»ï¼Œå®ä¾‹åŒ–çš„å°±æ˜¯ ref å¯¹è±¡

```typescript
class RefImpl<T> {
  private _value: T
  constructor(value: any) {
    this._value = value
  }
  get value() {
    return this._value
  }
  set value(newValue: any) {
    this._value = newValue
  }
}
```

å¾ˆå¥½ï¼Œä¸Šé¢çš„æµ‹è¯•ç”¨ä¾‹æˆ‘ä»¬å·²ç»è·‘é€šäº†

ä½†æ˜¯å…‰è·‘é€šä¸Šé¢çš„ç®€å•ç”¨ä¾‹è¿˜ä¸è¡Œï¼Œæˆ‘ä»¬å¿…é¡»è®© ref å…·æœ‰å“åº”å¼è¡Œä¸º

```typescript
it('should be reactive', () => {
  const a = ref(1)
  let dummy
  let calls = 0
  effect(() => {
    calls++
    dummy = a.value
  })
  expect(calls).toBe(1)
  expect(dummy).toBe(1)
  a.value = 2
  expect(calls).toBe(2)
  expect(dummy).toBe(2)
  // same value should not trigger
  a.value = 2
  expect(calls).toBe(2)
})
```

åœ¨å®ç°`reactive`æ•°æ®å“åº”å¼çš„æ—¶å€™æˆ‘ä»¬å°±å·²ç»å®ç°äº†ä¾èµ–æ”¶é›†å’Œè§¦å‘ä¾èµ–åŠŸèƒ½ï¼Œä¸ºäº†å¯¹ä»£ç èƒ½æœ‰æ›´å¥½çš„å¯è¯»æ€§å’Œæ€§èƒ½ä¼˜åŒ–ï¼Œæˆ‘ä»¬ä¼šé€‰æ‹©å¤ç”¨`reactive`çš„ä¾èµ–æ”¶é›†å’Œè§¦å‘ä¾èµ–çš„ç›¸å…³ä»£ç é€»è¾‘ã€‚

ä½†æ˜¯è¿™äº›ä»£ç é€»è¾‘å·²ç»å†™æ­»åœ¨ trigger()å’Œ track()å‡½æ•°é‡Œé¢äº†ï¼Œä¸ºäº†ä»£ç èƒ½å¤ç”¨ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠè¿™äº›é€»è¾‘æŠ½ç¦»å‡ºæ¥ã€‚

å®šä¹‰ä¸€ä¸ª`trackEffect`å‡½æ•°ï¼Œå¯¹ä¾èµ–æ”¶é›†çš„é€»è¾‘è¿›è¡Œå°è£…

```typescript
export type Dep = Set<ReactiveEffect>
export function trackEffect(dep: Dep) {
  // é¿å…ä¸å¿…è¦çš„addæ“ä½œ
  if (dep.has(activeEffect)) return
  // å°†activeEffectå®ä¾‹å¯¹è±¡addç»™deps
  dep.add(activeEffect)
  // activeEffectçš„deps æ¥æ”¶ Set<ReactiveEffect>ç±»å‹çš„deps
  // ä¾›åˆ é™¤ä¾èµ–çš„æ—¶å€™ä½¿ç”¨(åœæ­¢ç›‘å¬ä¾èµ–)
  activeEffect.deps.push(dep)
}
```

å®šä¹‰ä¸€ä¸ª`triggerEffect`å‡½æ•°ï¼Œå¯¹è§¦å‘ä¾èµ–çš„é€»è¾‘è¿›è¡Œå°è£…

```typescript
export function triggerEffect(dep: Dep) {
  for (let effect of dep) {
    if (effect.scheduler) {
      effect.scheduler()
    } else {
      effect.run()
    }
  }
}
```

æˆ‘ä»¬å°±å¯ä»¥åœ¨ RefImpl ç±»çš„ get å’Œ set è¿›è¡Œä¾èµ–æ”¶é›†å’Œè§¦å‘ä¾èµ–ï¼Œä¸è¿‡åœ¨æ­¤ä¹‹å‰ï¼Œæˆ‘ä»¬è¿˜éœ€è¦å®šä¹‰ä¸€ä¸ª`dep`å…¬æœ‰æˆå‘˜å‡½æ•°ï¼Œç”¨äºå­˜å‚¨è¿™ä¸€ä¸ª`ref`å¯¹è±¡çš„ä¾èµ–

```typescript
class RefImpl<T> {
  private _value: T
  public dep?: Dep = undefined
  constructor(value: any) {
    this._value = value
    this.dep = new Set()
  }
  get value() {
    trackRefValue(this)
    return this._value
  }
  set value(newValue: any) {
    // è§¦å‘ä¾èµ–

    // æ³¨æ„è¿™é‡Œå…ˆèµ‹å€¼å†è§¦å‘ä¾èµ–
    this._value = newValue
    triggerEffect(this.dep as Dep)
  }
}
function trackRefValue(ref: RefImpl<any>) {
  // æœ‰æ—¶å€™æ ¹æœ¬å°±æ²¡æœ‰è°ƒç”¨effect()ï¼Œä¹Ÿå°±æ˜¯è¯´activeEffectæ˜¯undefinedçš„æƒ…å†µ
  //   isTracking çš„å®ç°åœ¨ä¹‹å‰çš„ç« èŠ‚è®²åˆ°
  if (isTracking()) {
    // ä¾èµ–æ”¶é›†
    trackEffect(ref.dep as Dep)
  }
}
```

å½“ ref å¯¹è±¡è¢«èµ‹äºˆç›¸åŒçš„å€¼çš„æ—¶å€™ï¼Œæˆ‘ä»¬è¦åšåˆ°ä¸è§¦å‘ä¾èµ–çš„è¡Œä¸ºã€‚

æ€ä¹ˆæ‰èƒ½åˆ¤æ–­æ˜¯ä¸æ˜¯ç›¸åŒçš„å€¼å‘¢ï¼Ÿ

æˆ‘ä»¬å¿…é¡»ç»™ RefImpl å­˜å…¥ä¸€ä¸ªåŸå§‹å€¼`_rawValue`ï¼Œå®ƒå­˜æ”¾ç€ ref çš„å…¥å‚ï¼ˆref åŸæœ¬ä¼ å…¥çš„å€¼ï¼‰ï¼Œæˆ‘ä»¬åªéœ€è¦æŠŠå½“å‰æ‰§è¡Œ set èµ‹å€¼æ“ä½œçš„`value`å’Œ`_rawValue`è¿›è¡Œæ¯”è¾ƒï¼Œå¦‚æœç›¸åŒï¼Œæˆ‘ä»¬å°±ä¸è§¦å‘ä¾èµ–ã€‚

æ¯”è¾ƒçš„æ–¹å¼æˆ‘ä»¬é€‰æ‹©ä½¿ç”¨[ES6 çš„ Object.is](https://es6.ruanyifeng.com/#docs/object-methods#Object-is)

```typescript
export function hasChanged(value: any, oldValue: any) {
  return !Object.is(value, oldValue)
}
```

æ¯”è¾ƒç»“æœä¸º trueï¼Œè¯´æ˜`value`å·²ç»æ”¹å˜äº†ï¼Œè¿™æ—¶æˆ‘ä»¬åº”è¯¥æ›´æ–°`_rawValue`çš„å€¼ï¼Œå¹¶è§¦å‘ä¾èµ–ã€‚

```typescript
class RefImpl<T> {
  private _value: T
  public dep?: Dep = undefined
  private _rawValue: T
  constructor(value: any) {
    this._value = value
    this._rawValue = value
    this.dep = new Set()
  }
  get value() {
    trackRefValue(this)
    return this._value
  }
  set value(newValue: any) {
    // è§¦å‘ä¾èµ–

    // å¯¹æ¯”æ—§çš„å€¼å’Œæ–°çš„å€¼ï¼Œå¦‚æœç›¸ç­‰å°±æ²¡å¿…è¦è§¦å‘ä¾èµ–å’Œèµ‹å€¼äº†ï¼Œè¿™ä¹Ÿæ˜¯æ€§èƒ½ä¼˜åŒ–çš„ç‚¹
    if (hasChanged(newValue, this._rawValue)) {
      // æ³¨æ„è¿™é‡Œå…ˆèµ‹å€¼å†è§¦å‘ä¾èµ–
      this._value = newValue
      this._rawValue = newValue
      triggerEffect(this.dep as Dep)
    }
  }
}
```

å¦‚æœå°†å¯¹è±¡åˆ†é…ä¸º ref å€¼ï¼Œåˆ™å®ƒå°†è¢« reactive å‡½æ•°å¤„ç†ä¸ºæ·±å±‚çš„å“åº”å¼å¯¹è±¡ã€‚

reactive å‡½æ•°çš„æ·±å±‚å“åº”å¼å¯¹è±¡åŠŸèƒ½ï¼Œåœ¨ä¹‹å‰çš„ç¯‡ç« é‡Œæˆ‘ä»¬å·²ç»å®ç°äº†ã€‚

æˆ‘ä»¬åªéœ€è¦åˆ¤æ–­`value`æ˜¯å¦æ˜¯å¯¹è±¡ï¼Œæ˜¯å¯¹è±¡å°±ç”¨`reactive`å¤„ç†ï¼Œä¸æ˜¯å¯¹è±¡å°±ç›´æ¥ç»™`_value`

```typescript
function convert(value: any) {
  return isObject(value) ? reactive(value) : value
}
class RefImpl<T> {
  private _value: T
  public dep?: Dep = undefined
  private _rawValue: T
  constructor(value: any) {
    this._value = convert(value)
    this._rawValue = value
    this.dep = new Set()
  }
  get value() {
    trackRefValue(this)
    return this._value
  }
  set value(newValue: any) {
    // è§¦å‘ä¾èµ–

    // å¯¹æ¯”æ—§çš„å€¼å’Œæ–°çš„å€¼ï¼Œå¦‚æœç›¸ç­‰å°±æ²¡å¿…è¦è§¦å‘ä¾èµ–å’Œèµ‹å€¼äº†ï¼Œè¿™ä¹Ÿæ˜¯æ€§èƒ½ä¼˜åŒ–çš„ç‚¹
    if (hasChanged(newValue, this._rawValue)) {
      // æ³¨æ„è¿™é‡Œå…ˆèµ‹å€¼å†è§¦å‘ä¾èµ–
      this._value = convert(newValue)
      this._rawValue = newValue
      triggerEffect(this.dep as Dep)
    }
  }
}
```

è‡³æ­¤ï¼Œæµ‹è¯•ç”¨ä¾‹å·²å…¨éƒ¨è·‘é€šã€‚

## æ€»ç»“

`shallowReactive`å’Œ`shallowReadonly`åªèƒ½å¯¹è¡¨å±‚çš„æ•°æ®æä¾›`reactive`å’Œ`readonly`æ“ä½œï¼Œå¯¹äºæ·±å±‚çš„æ•°æ®æˆ‘ä»¬å¹¶åªèƒ½æš´éœ²åŸå§‹å€¼ã€‚

isProxy å®ç°çš„å¦‚æ­¤ç®€å•æ˜¯å› ä¸ºæˆ‘ä»¬åœ¨ä¹‹å‰æœ‰åˆ»æ„çš„å°è£…å‡½æ•°ï¼Œå¸Œæœ›æˆ‘ä»¬åœ¨å†™ä»£ç çš„æ—¶å€™ä¹Ÿè¦æœ‰è¿™ç§æ„è¯†ï¼Œæœ‰æ•ˆçš„å°è£…å‡½æ•°ä¼šæ˜¯ä»£ç å†™çš„æ›´ç®€å•ã€‚

ref å’Œ reactive çš„åŒºåˆ«ï¼š

1. ref ä¸€èˆ¬æ¥å—çš„æ˜¯å€¼ç±»å‹ï¼Œreactive æ¥å—çš„æ˜¯å¼•ç”¨ç±»å‹ï¼Œè™½ç„¶ ref èƒ½æ¥å—å¯¹è±¡ç±»å‹ï¼Œä½†æ˜¯å…¶å†…éƒ¨è¿˜æ˜¯ä½¿ç”¨äº† reactive()ï¼Œæ‰€ä»¥æŸäº›æƒ…å†µä¸‹ç›´æ¥ä½¿ç”¨ reactive ä¼šæ›´å¥½ä¸€äº›ã€‚ï¼ˆä¸ºä»€ä¹ˆï¼Ÿä½ é—® proxy è¿™ä¸ªå¤§å“¥ç»™ä¸ç»™ä½ ä¼ å…¥å€¼ç±»å‹å•Šï¼ï¼‰
2. ref éœ€è¦é€šè¿‡.value æ‰èƒ½æ‹¿åˆ°å€¼ã€‚

è¿˜æœ‰å…¶ä»–åŒºåˆ«æ¬¢è¿è¡¥å……ï¼

## æœ€å@æ„Ÿè°¢é˜…è¯»
