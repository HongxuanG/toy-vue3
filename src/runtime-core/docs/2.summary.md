# ğŸš€vue3 render æ¸²æŸ“å‡½æ•°çš„åŠŸèƒ½å®ç°ä»¥åŠå·§å¦™çš„ vnode ç±»å‹åˆ†ç±»ï¼

## å‰è¨€

ä¸Šç¯‡è®²è§£äº†templateåˆ°æŒ‚è½½å…ƒç´ çš„è¿‡ç¨‹ï¼Œè¿™ç¯‡æˆ‘ä»¬æ¥å¯¹renderå®ç°ä¸€äº›ç»†èŠ‚ä¸Šçš„åŠŸèƒ½ï¼Œå…¶ä¸­æºç æœ‰ä¸€äº›å¼€å‘æ€è·¯è¿˜æ˜¯å¾ˆå€¼å¾—æˆ‘ä»¬å»å­¦ä¹ çš„

æœ¬ç¯‡æ–‡ç« ä¸»è¦å†…å®¹ï¼š

1. å®ç°ç»„ä»¶ä»£ç†å¯¹è±¡
2. å®ç° shapeFlags
3. å®ç°æ³¨å†Œäº‹ä»¶åŠŸèƒ½
4. å®ç°ç»„ä»¶ props åŠŸèƒ½
5. å®ç°ç»„ä»¶ emit åŠŸèƒ½
6. å®ç°ç»„ä»¶ slots åŠŸèƒ½
7. å®ç° Fragment å’Œ Text ç±»å‹èŠ‚ç‚¹

## render çš„ this æŒ‡å‘æ˜¯å¦‚ä½•å®ç°çš„ï¼Ÿ
æœ‰æ—¶å€™æˆ‘ä»¬çš„h()å‡½æ•°éœ€è¦è·å–setupè¿”å›çš„å¯¹è±¡é‡Œé¢çš„æŸä¸ªå±æ€§ï¼Œæ¯”å¦‚this.name

å…ˆçœ‹ä¸€ä¸ªä¾‹å­ï¼š
```typescript
export default {
  name: 'App',
  render() {
    // thisæŒ‡å‘é€šè¿‡proxy
    return h('div', {
      id: 'root',
      class: ['flex', 'container']
    }, this.name)
  },
  setup() {
    // è¿”å›å¯¹è±¡æˆ–è€…h()æ¸²æŸ“å‡½æ•°
    return {
      name: 'hi my app'
    }
  }
}
```


å¯æ˜¯è¿™ä¸ªthisçš„æŒ‡å‘åˆ†æ˜å°±æ˜¯æŒ‡å‘çš„`render()`å‡½æ•°ï¼Œå¦‚æœä¸å¯¹thisæŒ‡å‘åšå¤„ç†ï¼Œ`this.name`å°†ä¼šå¾—åˆ°undefined

å…¶å®thisçš„æŒ‡å‘å¹¶ä¸é‡è¦ï¼Œé‡è¦çš„æ˜¯ä½¿ç”¨thiså¯ä»¥è·å–setupçš„è¿”å›å€¼ã€`$el`ã€`$slogs`ä»¥åŠå¤–éƒ¨ä¼ é€’è¿›æ¥çš„propsçš„å±æ€§

æ€è€ƒä¸€ä¸‹ï¼Œå“ªé‡Œèƒ½è·å–åˆ°setupçš„è¿”å›å€¼å‘¢ï¼Ÿï¼ˆsetupStateï¼‰

å‰é¢æˆ‘ä»¬ä¸æ˜¯å®ç°è¿‡`setupStatefulComponent()`æ–¹æ³•å—ï¼Ÿè¿™ä¸ªå‡½æ•°æ‰§è¡Œäº†setup()ï¼Œå¹¶æŠŠsetupçš„è¿”å›å€¼setupResultæŒ‚è½½åœ¨äº†instance.setupStateä¸Šã€‚

é‚£æˆ‘ä»¬æ€ä¹ˆé€šè¿‡thisè®¿é—®åˆ°setupStateå‘¢ï¼Ÿ

æ”¹å˜thisçš„æŒ‡å‘æˆ‘ä»¬æœ‰callã€bindã€applyã€‚æˆ‘ä»¬è¦æ”¹å˜instance.renderçš„thisæŒ‡å‘ï¼Œå¹¶ä¸”è®©renderæ‰§è¡Œï¼Œè¿”å›å­æ ‘çš„vnodeï¼Œæˆ‘ä»¬é€‰ç”¨`call`

æˆ‘ä»¬å®šä½åˆ°instance.renderæ‰§è¡Œé€»è¾‘æ‰€åœ¨çš„setupRenderEffectä¸Šï¼š
```typeScript
function setupRenderEffect(instance: any, vnode: any, container: any) {
  const subTree = instance.render.call(instance.setupState)
  // å¯¹å­æ ‘è¿›è¡Œæ‹†ç®±æ“ä½œ é€’å½’è¿›å»
  patch(subTree, container)
  // ä»£ç åˆ°äº†è¿™é‡Œï¼Œç»„ä»¶å†…çš„æ‰€æœ‰elementå·²ç»æŒ‚åœ¨åˆ°documenté‡Œé¢äº†
  vnode.el = subTree.el
}
```
ç›´æ¥åœ¨callçš„ç¬¬ä¸€ä¸ªå‚æ•°å¡«ä¸Šinstance.setupStateå½“ç„¶æ²¡é—®é¢˜ï¼Œä½†æ˜¯æˆ‘ä»¬åç»­ä¼šæœ‰propsã€`$el`ã€`$slots`ï¼Œè¿™äº›å‚æ•°éƒ½ä¸åœ¨setupçš„è¿”å›å€¼å¯¹è±¡é‡Œé¢å“¦ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦new ä¸€ä¸ª proxyå¯¹è±¡ï¼Œåœ¨getæ“ä½œçš„æ—¶å€™åˆ¤æ–­keyå“ªä¸ªå¯¹è±¡çš„å±æ€§ï¼Œå¹¶è¿”å›ç›¸åº”çš„é”®å€¼ã€‚

```typescript
function setupStatefulComponent(instance: any) {
  const Component = instance.type
  // è§£å†³renderè¿”å›çš„h()å‡½æ•°é‡Œé¢thisçš„é—®é¢˜ï¼ŒæŒ‡å‘setupå‡½æ•°
  instance.proxy = new Proxy({ _: instance } as Data, publicInstanceProxyHandlers)
  const { setup } = Component
  // æœ‰æ—¶å€™ç”¨æˆ·å¹¶æ²¡æœ‰ä½¿ç”¨setup()
  if (setup) {

    const setupResult = setup()

    handleSetupResult(instance, setupResult)
  }
  finishComponentSetup(instance)
}
export const publicInstanceProxyHandlers: ProxyHandler<any> = {
  // é€šè¿‡targetå§instanceä¼ é€’ç»™getæ“ä½œ
  get({ _: instance }, key: string) {
    const { setupState } = instance
    // åœ¨setupçš„returnä¸­å¯»æ‰¾key
    if (hasOwn(setupState, key)) {
      return setupState[key]
    }
    // åç»­æˆ‘ä»¬è¿™é‡Œè¿˜å¯èƒ½ä¼šè¿”å›propsã€`$el`ã€`$slots`ç­‰ç­‰
  },
}
```
è¿™ä¸ªhasOwnçš„å®ç°å°±æ˜¯Object.property.hasOwnProperty.call()

å†æ¬¡æ›´æ”¹ä¸Šé¢çš„`setupRenderEffect()`
```typescript
function setupRenderEffect(instance: any, vnode: any, container: any) {
  // æŠŠinstance.setupState æ”¹æˆ instance.proxy
  const subTree = instance.render.call(instance.proxy)
  patch(subTree, container)
  vnode.el = subTree.el
}
```

## å·§å¦™çš„ vnode ç±»å‹åˆ†ç±»

ä¸Šä¸€ç¯‡é‡Œæˆ‘ä»¬æ˜¯é€šè¿‡vnode.typeåˆ¤æ–­æ˜¯å¦æ˜¯stringç±»å‹ï¼Œobjectç±»å‹æ¥ç¡®å½“è¿™ä¸ªvnodeåˆ°åº•æ˜¯å…ƒç´ çš„vnodeè¿˜æ˜¯ç»„ä»¶çš„vnodeã€‚ 
```typescript
function patch(vnode: any, container: any) {
  if(typeof vnode.type === 'string'){
    processElement(vnode, container)
  }else if(isObject(vnode.type)){
    processComponent(vnode, container)
  }
}
```
è¿™æ ·å†™çš„è¯ï¼Œä»£ç ä¸å¤Ÿä¼˜é›…ï¼ŒåæœŸvnodeä»£è¡¨æ›´å¤šç±»å‹çš„æ—¶å€™ï¼Œæˆ‘ä»¬å°±éœ€è¦åœ¨è¿™ä¸ªå‡½æ•°é‡æ–°æ·»åŠ åˆ¤æ–­é€»è¾‘ã€‚ä¸ºæ­¤æˆ‘ä»¬éœ€è¦å®šä¹‰ä¸€ä¸ªæ ‡è¯†ä½`shapeFlag`ï¼Œæ¯ä¸ªvnodeéƒ½æœ‰ä¸€ä¸ªshapeFlagæ ‡è¯†ä½ï¼Œç”¨äºæ ‡è¯†å½“å‰çš„vnodeæ˜¯ä»€ä¹ˆç±»å‹ã€‚

é‚£åœ¨vueæºç é‡Œé¢vnodeæ˜¯æ€ä¹ˆè¢«æ ‡è¯†çš„å‘¢ï¼Ÿæˆ‘ä»¬å¯ä»¥åœ¨`shared/src/shapeFlag.ts`ä¸­æ‰¾åˆ°ç­”æ¡ˆã€‚å¦‚ä¸‹


```typescript
export const enum ShapeFlags {
  ELEMENT = 1,                         // 0000000001
  FUNCTIONAL_COMPONENT = 1 << 1,       // 0000000010
  STATEFUL_COMPONENT = 1 << 2,         // 0000000100
  TEXT_CHILDREN = 1 << 3,              // 0000001000
  ARRAY_CHILDREN = 1 << 4,             // 0000010000
  SLOTS_CHILDREN = 1 << 5,             // 0000100000
  TELEPORT = 1 << 6,                   // 0001000000
  SUSPENSE = 1 << 7,                   // 0010000000
  COMPONENT_SHOULD_KEEP_ALIVE = 1 << 8,// 0100000000
  COMPONENT_KEPT_ALIVE = 1 << 9,       // 1000000000
  COMPONENT = ShapeFlags.STATEFUL_COMPONENT | ShapeFlags.FUNCTIONAL_COMPONENT
}
```
vueæºç å¹¶ä¸æ˜¯ç”¨å¯¹è±¡å»å­˜å‚¨æ ‡è¯†ï¼Œæ˜ å°„ã€‚
```typescript
// ä¸ºä»€ä¹ˆä¸ç›´æ¥ç”¨å¯¹è±¡ç„¶åå±æ€§å€¼æ˜¯1ï¼Œ2ï¼Œ3ï¼Œ4ï¼Œ5.ã€‚ã€‚ã€‚ä¸»è¦è¿˜æ˜¯æ€§èƒ½é—®é¢˜ï¼Œvueæºç åœ¨å¯è¯»æ€§å’Œæ€§èƒ½è¿™æ¡åˆ†å²”è·¯å£ä¸Šï¼Œæœ€ç»ˆè¿˜æ˜¯é€‰æ‹©äº†æ€§èƒ½ã€‚
export const ShapeFlags = {
  ElEMENT: 1,
  STATEFUL_COMPONENT: 2,
  TEXT_CHILDREN: 3,
  ARRAY_CHILDREN: 4,
}
```
è€Œæ˜¯é€šè¿‡äºŒè¿›åˆ¶ä½è¿ç®—çš„æ–¹å¼æ ‡è¯†ã€‚ä¾‹å¦‚ï¼š

> 1 çš„äºŒè¿›åˆ¶ æ˜¯ `0000000001`

å·¦ç§»1ä½

> `0000000010`

å·¦ç§»2ä½

> `0000000100`

æŒ‰ç…§vueæºç çš„æ–¹æ³•ï¼Œ

|vnodeç±»å‹|æ ‡è¯†ä½|
|:--------|:-----|
|elementç±»å‹|0000000001|
|ç»„ä»¶ç±»å‹|0000000010|
|å­çº§çš„æ–‡æœ¬ç±»å‹|0000000100|

é‚£å¦‚æœä¸€ä¸ªvnodeçš„ç±»å‹æ˜¯ç»„ä»¶ï¼Œå¹¶ä¸”å­çº§çš„èŠ‚ç‚¹æ˜¯æ–‡æœ¬ç±»å‹ï¼Œåº”è¯¥æ€ä¹ˆè¡¨ç¤ºï¼Ÿ

æˆ‘ä»¬æ˜¯ä¸æ˜¯åº”è¯¥åœ¨äºŒè¿›åˆ¶ä½çš„å³è¾¹æ•°èµ·ç¬¬ä¸‰ä½æŠŠ`0`æ”¹æˆ`1`å•Š

> 0000000110

æ€ä¹ˆå¾—åˆ°è¿™ä¸ªå€¼å‘¢ï¼Ÿè¿™é‡Œéœ€è¦ç”¨åˆ°é€»è¾‘æˆ–è¿ç®—çš„çŸ¥è¯†ï¼ˆè¿ç®—ç¬¦ä¸¤è¾¹ä¸º0ï¼Œç»“æœæ‰ä¸º0ï¼‰ï¼Œä¾‹å¦‚ï¼š

$0 | 0 = 0$

$0 | 1 = 1$

é‚£ä¹ˆç»„ä»¶ç±»å‹é€»è¾‘æˆ–è¿ç®—å­çº§æ–‡æœ¬ç±»å‹å°±æ˜¯ï¼š

$0000000010 | 0000000100 = 0000000110$

å¦‚ä½•åˆ¤æ–­è¿™ä¸ªvnodeæ˜¯ç»„ä»¶ç±»å‹å‘¢ï¼Ÿ

ç®€å•çš„æ¯”è¾ƒè¿ç®—ç¬¦è‚¯å®šæ˜¯ä¸è¡Œçš„ï¼Œ`0000000110` !== `0000000010`ï¼Œè¿™é‡Œæˆ‘ä»¬è¦ç”¨åˆ°é€»è¾‘ä¸è¿ç®—ç¬¦ï¼ˆè¿ç®—ç¬¦ä¸¤è¾¹éƒ½ä¸º1ï¼Œç»“æœæ‰ä¸º1ï¼‰ï¼Œä¾‹å¦‚ï¼š

$1 \& 1 = 1$

$1 \& 0 = 0$

é‚£ä¹ˆåˆ¤æ–­vnodeæ˜¯ä¸æ˜¯ç»„ä»¶ç±»å‹å°†ä¼šè¿™ä¹ˆè¡¨ç¤ºï¼š

$0000000110 \& 0000000010 = 0000000010$ 

ç»“æœé0ï¼Œè¯´æ˜è¯¥vnodeæ˜¯ç»„ä»¶ç±»å‹ï¼Œå¦åˆ™ä¸æ˜¯ç»„ä»¶ç±»å‹ã€‚å¦‚ä¸‹ï¼š

$0000000101 \& 0000000010 = 0000000000$ 

`0000000101`æ˜¯å…ƒç´ ç±»å‹å­çº§æ–‡æœ¬ç±»å‹ï¼Œæˆ‘ä»¬é€šè¿‡`0000000010`åˆ¤æ–­å®ƒæ˜¯å¦ä¸€ä¸ªç»„ä»¶ç±»å‹ï¼Œç»“æœä¸º0ï¼Œè¯´æ˜ä¸æ˜¯ç»„ä»¶ç±»å‹ã€‚

ä¸Šé¢æˆ‘ä»¬è®²äº†å¦‚ä½•åˆ¤æ–­vnodeçš„ç±»å‹å’Œç»™vnodeæ·»åŠ å¤šç§æ ‡è¯†ï¼Œé‚£ä¹ˆæˆ‘ä»¬æ¥å®é™…ç”¨èµ·æ¥å§ã€‚å…ˆåœ¨åˆ›å»ºvnodeçš„æ—¶å€™ç»™vnodeæ·»åŠ `shapeFlag`

```typescript
export function createVNode(type: any, props?: any, children?: any) {
  const vnode = {
    type,
    props,
    children,
    shapeFlag: getShapeFlag(type), // getShapeFlagæ˜¯æ·»åŠ æ ‡è¯†
    el: null,
  }
  // æ ¹æ®childrençš„ç±»å‹ï¼Œç»™vnodeæ·»åŠ é¢å¤–çš„æ ‡è¯†
  normalizeChildren(vnode, children)
  return vnode
}
```
```typescript
// æ ¹æ®vnode.typeæ ‡å¿—vnodeç±»å‹
function getShapeFlag(type: any) {
  return isString(type) 
    ? ShapeFlags.ELEMENT
    : isObject(type)
    ? ShapeFlags.STATEFUL_COMPONENT
    : 0
}
```
```typescript
// ç»™vnode.shapeFlagè¿½åŠ æ ‡è¯†
function normalizeChildren(vnode: any, children: any){
  // | å·¦å³ä¸¤è¾¹ä¸º0 åˆ™ä¸º0   å¯ä»¥ç”¨äºç»™äºŒè¿›åˆ¶æŒ‡å®šçš„ä½æ•°ä¿®æ”¹æˆ1  ä¾‹å¦‚ï¼š0100 | 0001 = 0101
  // åœ¨è¿™é‡Œç›¸å½“äºç»™vnodeè¿½åŠ é¢å¤–çš„æ ‡è¯†
  if(isString(children)){
    vnode.shapeFlag |= ShapeFlags.TEXT_CHILDREN
    // å­çº§æ˜¯æ•°ç»„
  } else if(isArray(children)){
    vnode.shapeFlag |= ShapeFlags.ARRAY_CHILDREN
  }
  // vnodeæ˜¯ç»„ä»¶
  if(vnode.shapeFlag & ShapeFlags.STATEFUL_COMPONENT){
    // å­çº§æ˜¯å¯¹è±¡
    if(isObject(children) ){
      vnode.shapeFlag |= ShapeFlags.SLOTS_CHILDREN
    }
  }
}
```
## render çš„äº‹ä»¶æ˜¯å¦‚ä½•è¢«æ³¨å†Œçš„ï¼Ÿ

æˆ‘ä»¬å…ˆæ¥çœ‹ä¸€ä¸‹ç»‘å®šäº‹ä»¶çš„ç”¨æ³•ï¼š
```typescript
// in app.js
export default {
  name: 'App',
  render() {
    return h('div', {
      id: 'root',
      class: ['flex', 'container-r'],
      onClick(){
        console.log('click event!')
      },
      onMouseDown(){
        console.log('mouse down!')
      }
    }, [
      h('p', {class: 'red'}, 'red'),
      h('p', {class: 'blue'}, 'blue')
    ])
  },
  setup() {
    return {
      name: 'hi my app'
    }
  }
}

```
å¯ä»¥çœ‹åˆ°h()å‡½æ•°é‡Œé¢ç»‘å®šäº‹ä»¶éƒ½æ˜¯åœ¨äº‹ä»¶åçš„ç¬¬ä¸€ä¸ªå­—æ¯å¤§å†™å¹¶ä¸”åœ¨å‰é¢æ·»åŠ ä¸Š`on`å‰ç¼€ã€‚

å½“vnodeåœ¨mountElementçš„æ—¶å€™ï¼Œå¾ªç¯vnodeçš„propsçš„æ—¶å€™ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡addEventListeneræ¥ç»™å…ƒç´ æ³¨å†Œäº‹ä»¶ï¼Œä¸è¿‡è¦è¾¨åˆ«propsåˆ°åº•æ˜¯ä¸æ˜¯ä¸€ä¸ªäº‹ä»¶åä»¥åŠï¼Œé”®å€¼æ˜¯å¦æ˜¯ä¸€ä¸ªå‡½æ•°å“¦ã€‚

```typescript
export const isOn = (key: string) => /^on[A-Z]/.test(key)
function mountElement(vnode: any, container: any) {
  // æ³¨æ„ï¼šè¿™ä¸ªvnodeå¹¶éæ˜¯ç»„ä»¶çš„vnodeï¼Œè€Œæ˜¯HTMLå…ƒç´ çš„vnode
  console.log('mountElement', vnode)
  const el = (vnode.el = document.createElement(vnode.type) as HTMLElement)
  let { children, props } = vnode
  // å­èŠ‚ç‚¹æ˜¯æ–‡æœ¬èŠ‚ç‚¹
  if (vnode.shapeFlag & ShapeFlags.TEXT_CHILDREN) {
    el.textContent = children
    // å­èŠ‚ç‚¹æ˜¯æ•°ç»„
  } else if (vnode.shapeFlag & ShapeFlags.ARRAY_CHILDREN) {
    mountChildren(vnode, el)
  }
  let val: any
  // å¯¹vnodeçš„propsè¿›è¡Œå¤„ç†ï¼ŒæŠŠè™šæ‹Ÿå±æ€§æ·»åŠ åˆ°el
  for (let key of Object.getOwnPropertyNames(props).values()) {
    val = props[key]
    if (Array.isArray(val)) {
      el.setAttribute(key, val.join(' '))
    } else if (isOn(key) && isFunction(val)) {
      // æ·»åŠ äº‹ä»¶
      el.addEventListener(key.slice(2).toLowerCase(), val)
    } else {
      el.setAttribute(key, val)
    }
  }
  container.append(el)
}
```
`isOn`çš„å®ç°æ˜¯ç”¨æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…propsçš„é”®åæ˜¯å¦ä»¥`on`å¼€å¤´ã€‚å¹¶ä¸”é”®å€¼æ˜¯ä¸€ä¸ªå‡½æ•°ç±»å‹ï¼Œé‚£ä¹ˆå°±éœ€è¦æ³¨å†Œäº‹ä»¶ã€‚`slice(2).toLowerCase()`æ˜¯ä¸ºäº†å»æ‰onå‰ç¼€ï¼Œä¿ç•™äº‹ä»¶åã€‚`val`ç›´æ¥ä½œä¸ºå‡½æ•°ä½“ä¼ å…¥addEventListenerçš„ç¬¬äºŒä¸ªå‚æ•°ã€‚

## render æ˜¯å¦‚ä½•æ¥æ”¶å¤–éƒ¨ä¼ å…¥çš„ propsï¼Ÿ

å…ˆçœ‹ä¾‹å­ï¼š
```typescript
export default {
  name: 'App',
  render() {
    return h('div', {}, [
      // å¼•å…¥Fooç»„ä»¶
      h(Foo, {
        count: 1
      }, '')
    ])
  },
  setup() {
    // è¿”å›å¯¹è±¡æˆ–è€…h()æ¸²æŸ“å‡½æ•°
    return {
      name: 'hi my app'
    }
  }
}

```
```typescript
export default {
  name: 'Foo',
  render() {
    // 2. èƒ½åœ¨renderä¸­é€šè¿‡thisè®¿é—®åˆ°props
    return h('div', {}, 'foo: ' + this.count)
  },
  setup(props) {
    // 1. ä¼ å…¥count
    console.log(props)
    // 3. shallow readonly
    props.count++
    console.log(props)
  }
}
```
å®ç°ç›®æ ‡ï¼š

1. propsä»app.jsä¸­ä¼ ç»™Fooç»„ä»¶ï¼Œç»„ä»¶èƒ½åœ¨setupçš„ç¬¬ä¸€ä¸ªå…¥å‚ä¸­è®¿é—®åˆ°props
2. Fooçš„renderå‡½æ•°èƒ½é€šè¿‡thisè®¿é—®åˆ°props
3. propså…·æœ‰shallowReadonlyæ€§è´¨ï¼ˆæµ…å±‚çš„readonlyï¼‰

æ—¢ç„¶å•Špropså†™åœ¨Fooç»„ä»¶ä¸Šï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥åœ¨setupComponentä¸Šï¼Œç»™instanceæŒ‚è½½ä¸€ä¸ªpropsçš„å±æ€§ã€‚å…ˆåœ¨createComponentInstanceä¸Šä¸ºinstanceæ·»åŠ propså±æ€§ã€‚
```typescript
export function createComponentInstance(vnode: any) {
  const type = vnode.type
  const instance = {
    vnode,
    type,
    render: null,
    setupState: {},
    props: {},
  }
  return instance
}
```
```typescript
export function setupComponent(instance: any) {
  // åˆå§‹åŒ–ç»„ä»¶å¤–éƒ¨ä¼ ç»™ç»„ä»¶çš„props
  initProps(instance, instance.vnode.props)
  setupStatefulComponent(instance)
}
```
è¿™é‡Œçš„åˆå§‹åŒ–propsï¼Œæ¯”è¾ƒç®€å•ï¼Œåªéœ€æŠŠinstanceçš„vnodeä¸‹çš„propsèµ‹å€¼ç»™instanceçš„propså³å¯ã€‚
```typescript
export function initProps(instance: any, rawProps: any) {
  instance.props = rawProps || {}
}
```
ä¸ºäº†å®ç°ç¬¬ä¸€ä¸ªç›®æ ‡ï¼Œæˆ‘ä»¬éœ€è¦å®šä½åˆ°è°ƒç”¨setupå‡½æ•°çš„ä½ç½®ï¼Œå¹¶æŠŠ`instance.props`ä½œä¸ºç¬¬ä¸€ä¸ªå‚æ•°ä¼ é€’ç»™`setup`ã€‚
```typescript
function setupStatefulComponent(instance: any) {
  const Component = instance.type
  // è§£å†³renderè¿”å›çš„h()å‡½æ•°é‡Œé¢thisçš„é—®é¢˜ï¼ŒæŒ‡å‘setupå‡½æ•°
  instance.proxy = new Proxy({ _: instance } as Data, publicInstanceProxyHandlers)
  const { setup } = Component
  if (setup) {
    const setupResult = setup(instance.props)

    handleSetupResult(instance, setupResult)
  }
  finishComponentSetup(instance)
}
```
å‰æ–‡è®²åˆ°ï¼Œrenderçš„thisæŒ‡å‘æŒ‡å‘äº†instance.proxyäº†ï¼Œä¸ºäº†èƒ½åœ¨thisä¸­è®¿é—®åˆ°propsï¼Œè¿˜è®°å¾—æˆ‘ä»¬åœ¨`publicInstanceProxyHandlers`ä¸­é¢„ç•™äº†ä½ç½®å—ï¼Œæˆ‘è¯´ä¸è¦ç›´æ¥åœ¨`new Proxy`ç¬¬äºŒä¸ªå‚æ•°ç›´æ¥å†™`instance.setupState`ï¼Œç°åœ¨å·²ç»ä½“ç°äº†æˆ‘çš„ç”¨æ„äº†å§ã€‚
```typescript
export const publicInstanceProxyHandlers: ProxyHandler<any> = {
  get({ _: instance }, key: string) {
    const { setupState, props } = instance
    // åœ¨setupçš„returnä¸­å¯»æ‰¾key
    if (hasOwn(setupState, key)) {
      return setupState[key]
      // åœ¨setupçš„å‚æ•°propsä¸­å¯»æ‰¾key
    } else if (hasOwn(props, key)) {
      return props[key]
    }
  },
}
```
ç¬¬ä¸‰ä¸ªç›®æ ‡ï¼Œpropså…·æœ‰shallowReadonlyæ€§è´¨ï¼Œæˆ‘ä»¬åªéœ€è¦æŠŠpropsç”¨shallowReadonlyåŒ…è£¹ä»¥ä¸‹å°±å¥½äº†ï¼Œç„¶åä¼ é€’ç»™setupå‡½æ•°
```typescript
if(setup){
  const setupResult = setup(shallowReadonly(instance.props))
}

```
## å­ç»„ä»¶å®šä¹‰è‡ªå®šä¹‰äº‹ä»¶ï¼Œçˆ¶ç»„ä»¶è§¦å‘è‡ªå®šä¹‰äº‹ä»¶

å…ˆçœ‹Fooå†…éƒ¨ï¼š
```typescript

export default {
  name: 'Foo',
  render() {
    
    return h('div', {}, [
      h('button', {
        onClick: this.onAdd
      }, 'è§¦å‘emit')
    ])
  },
  setup(props, {emit}) {
    
    function onAdd(){
      console.log('onAdd')
      emit('emitFooAddEvent', props.count)
    }
    
    return {
      onAdd
    }
  }
}

```
buttonä¸Šé¢æœ‰ä¸ªclickäº‹ä»¶ï¼Œäº‹ä»¶é‡Œé¢è§¦å‘emitï¼Œå¯¹å¤–æš´éœ²äº†ä¸€ä¸ªemitFooAddEventè‡ªå®šä¹‰äº‹ä»¶ï¼Œå¹¶ä¸”æœ‰å‚æ•°ä¼ é€’ã€‚å…¶å®è¿™é‡Œbuttonè¢«ç‚¹å‡»çš„æ—¶å€™ï¼Œ`onEmitFooAddEvent`å°±ä¼šè¢«æ‰§è¡Œã€‚

çˆ¶ç»„ä»¶å°†ä¼šæ¥æ”¶
```typescript
export default {
  name: 'App',
  render() {
    return h('div', {
    }, [
      // åœ¨Fooçš„propsä¸­å¯»æ‰¾æœ‰æ²¡æœ‰on + emitFooAddEventè¿™ä¸ªå‡½æ•°ï¼Œæœ‰å°±æ‰§è¡Œ
      h(Foo, {
        count: 1,
        onEmitFooAddEvent: this.takeEmitEvent
      }, '')
    ])
  },
  setup() {
    function takeEmitEvent(count){
      console.log('app take in count number:', count)
    }
    // è¿”å›å¯¹è±¡æˆ–è€…h()æ¸²æŸ“å‡½æ•°
    return {
      takeEmitEvent
    }
  }
}
```
Fooç»„ä»¶é€šè¿‡å°†`emitFooAddEvent`é¦–å­—æ¯å¤§å†™ç„¶ååŠ ä¸Š`on`ï¼Œå®šä¹‰åœ¨Fooçš„propsä¸­ï¼Œå‡½æ•°ä½“æ˜¯setupè¿”å›çš„takeEmitEventå‡½æ•°ï¼Œä»”ç»†çœ‹ä¸Šé¢è¿˜æ¥æ”¶ä¸€ä¸ªå‚æ•°`count`ã€‚

å®ç°æ€è·¯å¦‚ä¸‹ï¼š

å½“Fooç»„ä»¶å†…è°ƒç”¨emitçš„æ—¶å€™ï¼Œä»–ä¼šé€šè¿‡å½“å‰ç»„ä»¶çš„instance.propsæ‰¾åˆ°å¯¹åº”çš„è‡ªå®šä¹‰äº‹ä»¶åï¼Œç„¶åæ‰§è¡Œå¯¹åº”çš„å‡½æ•°ï¼Œè¿™é‡Œçš„å‡½æ•°æ˜¯`takeEmitEvent`ï¼Œæ‰€ä»¥è¿™é‡Œè¿˜ä¼šæ‰§è¡Œå‡½æ•°ä½“`this.takeEmitEvent`ã€‚

æˆ‘ä»¬å®šä¹‰emitå‡½æ•°

```typescript
import { camelCase, toHandlerKey } from "../shared"

export function emit(instance: any, event: string, ...args: unknown[]){
  const {props} = instance

  // æŠŠkabobCase => camelCase
  const camelCase = (str: string) => {
    return str.replace(/-(\w)/g, (_, $1: string) => {
      return $1.toUpperCase()
    })
  }
  // é¦–å­—æ¯å¤§å†™
  const capitalize = (str: string) => {
    return str.charAt(0).toUpperCase() + str.slice(1)
  }
  // äº‹ä»¶å‰ç¼€è¿½åŠ 'on'
  const toHandlerKey = (eventName: string) => {
    return eventName ? 'on' + capitalize(eventName) : ''
  }

  const eventName = toHandlerKey(camelCase(event))
  // åœ¨propsä¸­å¯»æ‰¾eventNameï¼Œå¹¶æ‰§è¡Œã€‚
  const handler = props[eventName]
  handler && handler(...args)
}
```
`camelCase`è§£å†³çš„æ˜¯è‡ªå®šä¹‰äº‹ä»¶åç§°æ˜¯çƒ¤è‚‰ä¸²å¼çš„æƒ…å†µï¼Œä¾‹å¦‚ï¼šemit-foo-add-eventã€‚

`capitalize`è§£å†³çš„æ˜¯è‡ªå®šä¹‰äº‹ä»¶åç§°æ˜¯å°å†™çš„æƒ…å†µï¼Œä¾‹å¦‚ï¼šemitFooAddEventã€‚

`toHandlerKey`åˆ™ä¸ºè‡ªå®šä¹‰äº‹ä»¶åç§°æ·»åŠ `on`å‰ç¼€ã€‚

ä¹‹ååœ¨`createComponentInstance`ä¸­instanceæ·»åŠ emitå±æ€§ï¼Œå¹¶åšåˆå§‹åŒ–å¤„ç†
```typescript
export function createComponentInstance(vnode: any) {
  const type = vnode.type
  const instance = {
    vnode,
    type,
    render: null,
    setupState: {},
    props: {},
    emit: () => {},
  }
  instance.emit = emit.bind(null, instance) as any
  return instance
}
```
å› ä¸ºæ ¹æ®å®˜ç½‘çš„ç”¨æ³•ï¼Œsetupç¬¬äºŒä¸ªå‚æ•°ctxéœ€è¦ä¸€ä¸ªemitå‡½æ•°ã€‚æ‰€ä»¥`setupStatefulComponent`æ”¹å†™ä¸ºï¼š
```typescript
function setupStatefulComponent(instance: any) {
  const Component = instance.type
  instance.proxy = new Proxy({ _: instance } as Data, publicInstanceProxyHandlers)
  const { setup } = Component
  if (setup) {

    const setupResult = setup(shallowReadonly(instance.props), {
      emit: instance.emit
    })

    handleSetupResult(instance, setupResult)
  }
  finishComponentSetup(instance)
}
```
è¿™æ ·ä¸‰ä¸ªç›®æ ‡å°±å®Œæˆäº†ï¼

## renderå‡½æ•°çš„slotsæ’æ§½ï¼ˆä½œç”¨åŸŸæ’æ§½ã€å…·åæ’æ§½ï¼‰

æˆ‘ä»¬çš„æœ€ç»ˆç›®æ ‡æ˜¯å®ç°ä»¥ä¸‹ç”¨æ³•ï¼š

ä½ å¯ä»¥é€šè¿‡åœ¨hå‡½æ•°çš„ç¬¬ä¸‰ä¸ªå‚æ•°å®šä¹‰ä¸€ä¸ªå¯¹è±¡ï¼Œdefaultå±æ€§ä½œä¸ºé»˜è®¤æ’æ§½ï¼Œå¹¶æ¥å—ä¸€ä¸ªè¿”å›å€¼ä¸ºhå‡½æ•°çš„hå‡½æ•°ã€‚
```typescript
// çˆ¶ç»„ä»¶
export default {
  name: 'App',
  render() {
    return h('div', {
      id: 'root',
      class: ['flex', 'container-r'],
    }, [
      h('p', {
        class: 'red'
      }, 'red'),
      h('p', {
        class: 'blue'
      }, this.name),
      h(Foo, {}, {
        default: () => h('p', {}, 'æˆ‘æ˜¯slot1')
      })
    ])
  },
  setup() {
    return {
      name: 'hi my app',
    }
  }
}

```
å­ç»„ä»¶é€šè¿‡renderSlotè§£æå‡ºå½“å‰çš„Fooç»„ä»¶å®ä¾‹çš„æ’æ§½åç§°ä¸ºdefaultçš„slotæ’æ§½ï¼ŒrenderSlotä¼šè¿”å›vnodeèŠ‚ç‚¹ã€‚
```typescript
// å­ç»„ä»¶
export default {
  name: 'Foo',
  render() {
    const foo = h('p', {}, 'åŸæœ¬å°±åœ¨Fooé‡Œé¢çš„å…ƒç´ ')
    return h('div', {}, [foo, renderSlot(this.$slots, 'default')])
  }
}
```

### ç®€å•å®ç°æ’æ§½

æˆ‘ä»¬å…ˆæ¥å®ç°ç®€å•çš„ï¼Œèƒ½æŠŠFooç»„ä»¶çš„æ’æ§½æ¸²æŸ“å‡ºæ¥ã€‚

é¢„æœŸæ•ˆæœæ˜¯ï¼š
```typescript
// çˆ¶ç»„ä»¶
export default {
  name: 'App',
  render() {
    return h('div', {
      id: 'root',
      class: ['flex', 'container-r'],
    }, [
      h('p', {
        class: 'red'
      }, 'red'),
      h('p', {
        class: 'blue'
      }, this.name),



      h(Foo, {}, h('p', {}, 'æˆ‘æ˜¯slot1'))
    ])
  },
  setup() {
    return {
      name: 'hi my app',
    }
  }
}
// å­ç»„ä»¶
export default {
  name: 'Foo',
  render() {
    const foo = h('p', {}, 'åŸæœ¬å°±åœ¨Fooé‡Œé¢çš„å…ƒç´ ')
    return h('div', {}, [foo, this.$slots])
  }
}
```
éœ€è¦æŠŠAppè¿™ä¸ªçˆ¶ç»„ä»¶çš„Fooç»„ä»¶çš„æ’æ§½hå‡½æ•°ï¼Œä¼ é€’ç»™Fooç»„ä»¶çš„$slotsä¸­ï¼Œå¹¶ä¸”è¿™ä¸ªslotsæ˜¯vnodeèŠ‚ç‚¹ã€‚ä¸ºä»€ä¹ˆè¦vnodeèŠ‚ç‚¹å‘¢ï¼Ÿå†å›å¿†ä¸€ä¸‹å•Šï¼Œä½ ä»¬è¿˜è®°å¾—`mountElement`çš„æ—¶å€™å—ï¼Ÿä»–ä¼šè¯†åˆ«childrenæ˜¯å¦æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œç„¶åé€šè¿‡`mountChildren`æŠŠæ•°ç»„çš„æ¯ä¸ªvnodeéƒ½éå†ä¸€éï¼Œå†æ¬¡patchã€‚å°±å› ä¸ºpatchè¦ä¼ å…¥vnodeï¼Œæ‰€ä»¥` $slots`å¿…é¡»æ˜¯ä¸€ä¸ªvnodeèŠ‚ç‚¹ã€‚

`this.$slots`è¿™ä¸ªthisæ˜¯Fooç»„ä»¶çš„instanceï¼Œæˆ‘ä»¬éœ€è¦åœ¨`createComponentInstance`ä¸ºinstanceæ·»åŠ æ–°å±æ€§`slots`å¹¶åˆå§‹åŒ–ä¸º{}ã€‚
```typescript
export function createComponentInstance(vnode: any) {
  const type = vnode.type
  const instance = {
    vnode,
    type,
    render: null,
    setupState: {},
    props: {},
    emit: () => {},
    slots: {},   // æ–°å¢
  }
  instance.emit = emit.bind(null, instance) as any
  return instance
}
```
é‚£è¿™ä¸ªslotsåœ¨å“ªæ‰èƒ½è·å¾—Fooçš„childrenå‘¢ï¼Ÿåº”è¯¥åœ¨`setupComponent`çš„æ—¶å€™ï¼Œæ·»åŠ ä¸€ä¸ªæ–¹æ³•`initSlots()`ï¼ŒåŒæ—¶éœ€è¦ç»™è¿™ä¸ªæ–¹æ³•ä¼ å…¥`instance`å’Œ`instance.vnode.children`

```typescript
export function setupComponent(instance: any) {
  initProps(instance, instance.vnode.props)
  // åˆå§‹åŒ–ç»„ä»¶çš„slots
  initSlots(instance, instance.vnode.children)
  setupStatefulComponent(instance)
}
```
è¿™ä¸ª`instance.vnode.children`å°±æ˜¯`h(Foo, {}, h('p', {}, 'æˆ‘æ˜¯slot1'))`çš„ç¬¬ä¸‰ä¸ªå‚æ•°`h('p', {}, 'æˆ‘æ˜¯slot1')`ã€‚

è€Œ initSlots çš„å†…éƒ¨å®ç°å¾ˆç®€å•ã€‚
```typescript
export function initSlots(instance: any, children: any) {
  instance.slots = children
}
```
ç°åœ¨æˆ‘ä»¬æŠŠchildrenæŒ‚è½½åœ¨instance.slotsä¸Šã€‚è¿˜æ²¡å®Œï¼Œæ¥ä¸‹æ¥å®ç°thiså¦‚ä½•è®¿é—®$slotsã€‚

å‰æ–‡æˆ‘ä»¬è®²åˆ°thiså¦‚ä½•è®¿é—®propsï¼Œè¿™æ¬¡çš„$slotsä¹Ÿæ˜¯åŒæ ·çš„ï¼Œæˆ‘ä»¬åœ¨`publicInstanceProxyHandlers`è¿™ä¸ªproxyå¯¹è±¡çš„å¤„ç†å‡½æ•°ä¸­è¿”å› instance.slotsã€‚
```typescript
export type PublicPropertiesMap = Record<string, (i: any) => any>
// å®ä¾‹property
const publicPropertiesMap: PublicPropertiesMap = {
  $el: (i: any) => i.vnode.el,
  $slots: (i: any) => i.slots
}
export const publicInstanceProxyHandlers: ProxyHandler<any> = {
  get({ _: instance }, key: string) {
    const { setupState, props } = instance
    // åœ¨setupçš„returnä¸­å¯»æ‰¾key
    if (hasOwn(setupState, key)) {
      return setupState[key]
      // åœ¨setupçš„å‚æ•°propsä¸­å¯»æ‰¾key
    } else if (hasOwn(props, key)) {
      return props[key]
    }
    // åœ¨publicPropertiesMapä¸­å¯»æ‰¾keyï¼Œå¹¶è°ƒç”¨ï¼Œè¿”å›ç»“æœ
    const publicGetter = publicPropertiesMap[key]
    if (publicGetter) {
      return publicGetter(instance)
    }
  },
}
```
ç°åœ¨æ’æ§½å°±å®ç°äº†ã€‚
[![Obr5LR.md.png](https://s1.ax1x.com/2022/05/19/Obr5LR.md.png)](https://imgtu.com/i/Obr5LR)

éœ€æ±‚å†æ¬¡å‡çº§ï¼
Fooç»„ä»¶çš„slotsä½ç½®å¦‚æœéœ€è¦ä¼ å…¥å¤šäº†ä¸ªvnodeå‘¢ï¼Ÿé‚£è¯¥æ€ä¹ˆåŠï¼Ÿæˆ‘ä»¬é€šè¿‡æ•°ç»„çš„æ–¹å¼æŠŠè¿™äº›vnodeæ”¾åˆ°slotsä¸­ã€‚

`h(Foo, {}, [h('p', {}, 'æˆ‘æ˜¯slot1'), h('p', {}, 'æˆ‘æ˜¯slot2')])`

ä½†æ˜¯hå‡½æ•°çš„ç¬¬ä¸‰ä¸ªå‚æ•°ä¸æ˜¯ä¸€ä¸ªvnodeèŠ‚ç‚¹äº†ï¼Œè€Œæ˜¯ä¸€ä¸ªæ•°ç»„
```typescript

```
### å…·åæ’æ§½åŠŸèƒ½



### ä½œç”¨åŸŸæ’æ§½åŠŸèƒ½



## æ‘†è„± div æŸç¼šçš„è§£å†³æ–¹æ¡ˆï¼šFragment å’Œ Text

## æœ€å@è‚è¡€é˜…è¯»ï¼Œæ “ Q

## å®Œæ•´ä»£ç 
