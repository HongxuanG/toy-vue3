# ğŸš€vue3 render æ¸²æŸ“å‡½æ•°çš„åŠŸèƒ½å®ç°ä»¥åŠå·§å¦™çš„ vnode ç±»å‹åˆ†ç±»ï¼

## å‰è¨€

ä¸Šç¯‡è®²è§£äº†templateåˆ°æŒ‚è½½å…ƒç´ çš„è¿‡ç¨‹ï¼Œè¿™ç¯‡æˆ‘ä»¬æ¥å¯¹renderå®ç°ä¸€äº›ç»†èŠ‚ä¸Šçš„åŠŸèƒ½ï¼Œå…¶ä¸­æºç æœ‰ä¸€äº›å¼€å‘æ€è·¯è¿˜æ˜¯å¾ˆå€¼å¾—æˆ‘ä»¬å»å­¦ä¹ çš„

æœ¬ç¯‡æ–‡ç« ä¸»è¦å†…å®¹ï¼š

1. å®ç°ç»„ä»¶ä»£ç†å¯¹è±¡
2. å®ç° shapeFlags
3. å®ç°æ³¨å†Œäº‹ä»¶åŠŸèƒ½
4. å®ç°ç»„ä»¶ props åŠŸèƒ½
5. å®ç°ç»„ä»¶ emit åŠŸèƒ½
6. å®ç°ç»„ä»¶ slots åŠŸèƒ½
7. å®ç° Fragment å’Œ Text ç±»å‹èŠ‚ç‚¹

## render çš„ this æŒ‡å‘æ˜¯å¦‚ä½•å®ç°çš„ï¼Ÿ

å…ˆçœ‹ä¸€ä¸ªä¾‹å­ï¼š
```typescript
export default {
  name: 'App',
  render() {
    // thisæŒ‡å‘é€šè¿‡proxy
    return h('div', {
      id: 'root',
      class: ['flex', 'container']
    }, this.name)
  },
  setup() {
    // è¿”å›å¯¹è±¡æˆ–è€…h()æ¸²æŸ“å‡½æ•°
    return {
      name: 'hi my app'
    }
  }
}
```
æœ‰æ—¶å€™æˆ‘ä»¬çš„h()å‡½æ•°éœ€è¦è·å–setupè¿”å›çš„å¯¹è±¡é‡Œé¢çš„æŸä¸ªå±æ€§ï¼Œthis.name

å¯æ˜¯è¿™ä¸ªthisçš„æŒ‡å‘åˆ†æ˜å°±æ˜¯æŒ‡å‘çš„`render()`å‡½æ•°ï¼Œå¦‚æœä¸å¯¹thisæŒ‡å‘åšå¤„ç†ï¼Œ`this.name`å°†ä¼šå¾—åˆ°undefined

å…¶å®thisçš„æŒ‡å‘å¹¶ä¸é‡è¦ï¼Œé‡è¦çš„æ˜¯ä½¿ç”¨thiså¯ä»¥è·å–setupçš„è¿”å›å€¼ã€`$el`ã€`$slogs`ä»¥åŠå¤–éƒ¨ä¼ é€’è¿›æ¥çš„propsçš„å±æ€§

æ€è€ƒä¸€ä¸‹ï¼Œå“ªé‡Œèƒ½è·å–åˆ°setupçš„è¿”å›å€¼å‘¢ï¼Ÿï¼ˆsetupStateï¼‰

å‰é¢æˆ‘ä»¬ä¸æ˜¯å®ç°è¿‡`setupStatefulComponent()`æ–¹æ³•å—ï¼Ÿè¿™ä¸ªå‡½æ•°æ‰§è¡Œäº†setup()ï¼Œå¹¶æŠŠsetupçš„è¿”å›å€¼setupResultæŒ‚è½½åœ¨äº†instance.setupStateä¸Šã€‚

é‚£æˆ‘ä»¬æ€ä¹ˆé€šè¿‡thisè®¿é—®åˆ°setupStateå‘¢ï¼Ÿ

æ”¹å˜thisçš„æŒ‡å‘æˆ‘ä»¬æœ‰callã€bindã€applyã€‚æˆ‘ä»¬è¦æ”¹å˜instance.renderçš„thisæŒ‡å‘ï¼Œå¹¶ä¸”è®©renderæ‰§è¡Œï¼Œè¿”å›å­æ ‘çš„vnodeï¼Œæˆ‘ä»¬é€‰ç”¨`call`

æˆ‘ä»¬å®šä½åˆ°instance.renderæ‰§è¡Œé€»è¾‘æ‰€åœ¨çš„setupRenderEffectä¸Šï¼š
```typeScript
function setupRenderEffect(instance: any, vnode: any, container: any) {
  const subTree = instance.render.call(instance.setupState)
  // å¯¹å­æ ‘è¿›è¡Œæ‹†ç®±æ“ä½œ é€’å½’è¿›å»
  patch(subTree, container)
  // ä»£ç åˆ°äº†è¿™é‡Œï¼Œç»„ä»¶å†…çš„æ‰€æœ‰elementå·²ç»æŒ‚åœ¨åˆ°documenté‡Œé¢äº†
  vnode.el = subTree.el
}
```
ç›´æ¥åœ¨callçš„ç¬¬ä¸€ä¸ªå‚æ•°å¡«ä¸Šinstance.setupStateå½“ç„¶æ²¡é—®é¢˜ï¼Œä½†æ˜¯æˆ‘ä»¬åç»­ä¼šæœ‰propsã€`$el`ã€`$slots`ï¼Œè¿™äº›å‚æ•°éƒ½ä¸åœ¨setupçš„è¿”å›å€¼å¯¹è±¡é‡Œé¢å“¦ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦new ä¸€ä¸ª proxyå¯¹è±¡ï¼Œåœ¨getæ“ä½œçš„æ—¶å€™åˆ¤æ–­keyå“ªä¸ªå¯¹è±¡çš„å±æ€§ï¼Œå¹¶è¿”å›ç›¸åº”çš„é”®å€¼ã€‚

```typescript
function setupStatefulComponent(instance: any) {
  const Component = instance.type
  // è§£å†³renderè¿”å›çš„h()å‡½æ•°é‡Œé¢thisçš„é—®é¢˜ï¼ŒæŒ‡å‘setupå‡½æ•°
  instance.proxy = new Proxy({ _: instance } as Data, publicInstanceProxyHandlers)
  const { setup } = Component
  // æœ‰æ—¶å€™ç”¨æˆ·å¹¶æ²¡æœ‰ä½¿ç”¨setup()
  if (setup) {

    const setupResult = setup()

    handleSetupResult(instance, setupResult)
  }
  finishComponentSetup(instance)
}
export const publicInstanceProxyHandlers: ProxyHandler<any> = {
  // é€šè¿‡targetå§instanceä¼ é€’ç»™getæ“ä½œ
  get({ _: instance }, key: string) {
    const { setupState } = instance
    // åœ¨setupçš„returnä¸­å¯»æ‰¾key
    if (hasOwn(setupState, key)) {
      return setupState[key]
    }
  },
}
```
è¿™ä¸ªhasOwnçš„å®ç°å°±æ˜¯Object.property.hasOwnProperty.call()
`$el`

## å·§å¦™çš„ vnode ç±»å‹åˆ†ç±»

## render çš„äº‹ä»¶æ˜¯å¦‚ä½•è¢«æ³¨å†Œçš„ï¼Ÿ

## render æ˜¯å¦‚ä½•æ¥æ”¶å¤–éƒ¨ä¼ å…¥çš„ propsï¼Ÿ

## å­ç»„ä»¶å®šä¹‰è‡ªå®šä¹‰äº‹ä»¶ï¼Œçˆ¶ç»„ä»¶è§¦å‘è‡ªå®šä¹‰äº‹ä»¶

## render çš„æ’æ§½ï¼ˆä½œç”¨åŸŸæ’æ§½ã€å…·åæ’æ§½ï¼‰

## æ‘†è„± div æŸç¼šçš„è§£å†³æ–¹æ¡ˆï¼šFragment å’Œ Text

## æœ€å@è‚è¡€é˜…è¯»ï¼Œæ “ Q

## å®Œæ•´ä»£ç 
