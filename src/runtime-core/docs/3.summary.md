# ğŸš€Vue3 getCurrentInstanceä»¥åŠprovide&injectçš„å®ç°


## getCurrentInstance çš„å®ç°

getCurrentInstance å¯ä»¥è·å–åˆ°å†…éƒ¨å‡½æ•°çš„å®ä¾‹

> æ³¨æ„ï¼šåªèƒ½åœ¨ setup æˆ–ç”Ÿå‘½å‘¨æœŸä¸­ä½¿ç”¨

åŸºäº[å®˜ç½‘æè¿°](https://v3.cn.vuejs.org/api/composition-api.html#getcurrentinstance)çš„ç‰¹æ€§ï¼Œæˆ‘ä»¬æ¥è¯•ä¸€ä¸‹å®ç°å®ƒã€‚

æ—¢ç„¶åªèƒ½åœ¨ setup å†…éƒ¨ä½¿ç”¨ï¼Œæˆ‘ä»¬è‡ªç„¶è”æƒ³åˆ°[ä¹‹å‰ç« èŠ‚](https://juejin.cn/post/7100561910239592456)çš„`setupStatefulComponent()`ï¼Œå®ƒå†…éƒ¨è°ƒç”¨äº†`instance.type.setup()`å‡½æ•°

```typescript
function setupStatefulComponent(instance: any) {
  const Component = instance.type
  instance.proxy = new Proxy({ _: instance } as Data, publicInstanceProxyHandlers)
  const { setup } = Component
  if (setup) {
    const setupResult = setup(shallowReadonly(instance.props), {
      emit: instance.emit,
    })

    handleSetupResult(instance, setupResult)
  }
  finishComponentSetup(instance)
}
```

ä¸ºäº†æå‡è¯¥å¯¹è±¡çš„å…¬ç”¨æ€§ï¼Œæˆ‘ä»¬åœ¨å…¨å±€å®šä¹‰ä¸€ä¸ª`currentInstance`å˜é‡

```typescript
export let currentInstance = null
// è·å–å½“å‰å®ä¾‹
export function getCurrentInstance() {
  return currentInstance
}
// è®¾ç½®å½“å‰å®ä¾‹
function setCurrentInstance(instance: any) {
  currentInstance = instance
}
```

`setCurrentInstance`çš„è°ƒç”¨æ—¶æœºå†³å®šäº†`currentInstance`å½“å‰æŒ‡å‘å“ªä¸€ä¸ªç»„ä»¶å®ä¾‹ã€‚

é‚£ä»€ä¹ˆæ—¶å€™è®¾ç½®`setCurrentInstance`ä¸ºå½“å‰ç»„ä»¶å®ä¾‹æœ€å¥½å‘¢ï¼Ÿ

å…¶å®æ˜¯ç¡®ä¿`instance.type.setup`æœ‰å€¼å¹¶ä¸”åœ¨`instance.type.setup`è°ƒç”¨ä¹‹å‰è¿™ä¸ªæ—¶æœºå°±æ˜¯æœ€ä½³æ—¶æœºã€‚

```typescript
function setupStatefulComponent(instance: any) {
  const Component = instance.type
  instance.proxy = new Proxy({ _: instance } as Data, publicInstanceProxyHandlers)
  const { setup } = Component
  if (setup) {
    // currentInstanceè®¾ç½®ä¸ºinstance
    setCurrentInstance(instance)
    const setupResult = setup(shallowReadonly(instance.props), {
      emit: instance.emit,
    })
    handleSetupResult(instance, setupResult)
    // è®©currentInstanceå˜ä¸ºnull
    setCurrentInstance(null)
  }
  finishComponentSetup(instance)
}
```

æœ€åæˆ‘ä»¬æŠŠ`currentInstance`å˜ä¸º nullï¼Œå…¶å®æ˜¯ä¸ºäº†ä½¿ currentInstance åœ¨ setup å†…éƒ¨æœ‰å€¼ï¼Œè¿™éµå¾ªäº†å®˜æ–¹ç»™å‡ºçš„ç‰¹æ€§ã€‚

è¿™å°±æ˜¯ getCurrentInstance çš„å®ç°ã€‚

## provide & inject å®ç°

çˆ¶ç»„ä»¶å’Œå­ç»„ä»¶ä¹‹é—´å…±äº«æ•°æ®æˆ‘ä»¬å¯ä»¥é€šè¿‡å¾ˆå¤šç§æ–¹å¼ï¼š

1. `vuex`
2. `props`å’Œ`emit`
3. å…¨å±€å¯¹è±¡`globalProperties`
4. parent & æ¨¡æ¿ ref

> æ³¨æ„ï¼ševentbus åœ¨ vue3 ä¸­å·²ä¸å†æ”¯æŒï¼Œéœ€è¦è‡ªå·±æ‰‹å†™å®ç°ã€‚åºŸé™¤äº†`$on`ã€`$children`ã€$listeners

é‚£å¦‚æœå­ç»„ä»¶å’Œç¥–å…ˆç»„ä»¶æ•°æ®å¦‚ä½•å…±äº«ï¼Ÿprops ä¸€å±‚ä¸€å±‚çš„ä¼ é€’ï¼Ÿemit ä¸€å±‚ä¸€å±‚çš„æš´éœ²æ–¹æ³•ç»™çˆ¶ç»„ä»¶ï¼Ÿè¿™æœªå…ä¹Ÿå¤ªä¸ä¼˜é›…äº†å§ï¼

`provide`å’Œ`inject`æ˜¯è¿™ç§åº”ç”¨åœºæ™¯çš„è§£å†³æ–¹æ¡ˆã€‚

å¦‚ä½•å®ç° provide å’Œ injectï¼Ÿ

> ä¸‹é¢æˆ‘ä»¬æŠŠä½¿ç”¨ provide çš„ç»„ä»¶ç§°ä¸º`æä¾›è€…`ï¼ŒæŠŠä½¿ç”¨ inject çš„ç»„ä»¶ç§°ä¸º`æ¥æ”¶è€…`ã€‚

æŠŠæä¾›è€…å®ä¾‹ä¸Šçš„ provide å±æ€§ä½œä¸ºä¸€ä¸ª`å®¹å™¨`ï¼Œè¿™ä¸ªå®¹å™¨å°±æ˜¯æä¾›ç»™æ¥æ”¶è€…çš„å…±äº«æ•°æ®ã€‚

æ¥æ”¶è€…å¦‚ä½•æ‹¿åˆ°æä¾›è€…çš„`å…±äº«æ•°æ®`å‘¢ï¼Ÿ

å¯ä»¥åœ¨æ¥æ”¶è€…å®ä¾‹ä¸Šæ·»åŠ ä¸€ä¸ª parent å­—æ®µï¼Œç”¨æ¥æŒ‡å®šè¯¥ç»„ä»¶å®ä¾‹çš„çˆ¶ç»„ä»¶å®ä¾‹æ˜¯è°ï¼Œä»è€Œæ‹¿åˆ°çˆ¶ç»„ä»¶å®ä¾‹çš„èº«ä¸Šçš„ provide è¿™ä¸ªå®¹å™¨ã€‚

åœ¨åˆ›å»ºç»„ä»¶å®ä¾‹çš„æ—¶å€™ä¸º instance æ–°å¢ä¸¤ä¸ªå±æ€§ï¼ˆprovidesã€parentï¼‰

```typescript
export function createComponentInstance(vnode: any, parentComponent: any) {
  const type = vnode.type
  const instance = {
    vnode,
    type,
    render: null,
    setupState: {},
    props: {},
    emit: () => {},
    slots: {},
    provides: {} as Record<string, any>, // æ–°å¢
    parent: parentComponent, // æ–°å¢  çˆ¶ç»„ä»¶çš„ç»„ä»¶å®ä¾‹
  }
  instance.emit = emit.bind(null, instance) as any
  return instance
}
```

æ ¹æ®å®˜æ–¹çš„æè¿°å’Œä¾‹å­ï¼Œprovide æ¥æ”¶ä¸¤ä¸ªå‚æ•°`name`å’Œ`value`ï¼Œname ç”¨äºæ ‡è¯†é‚£äº›æä¾›ç»™å­ç»„ä»¶çš„æ•°æ®ï¼Œvalue å°±æ˜¯æˆ‘ä»¬è¦å¯¹å¤–æä¾›çš„æ•°æ®ã€‚

è¿™é‡Œæˆ‘æŠŠ`instance.provides`åˆå§‹åŒ–ä¸ºä¸€ä¸ªå¯¹è±¡ï¼Œä¹‹æ‰€ä»¥é€‰æ‹©ç”¨å¯¹è±¡ä½œä¸ºå®¹å™¨æ˜¯å› ä¸º provide å…·æœ‰é”®å€¼å…³ç³»ã€‚

`provide`æŠŠè¦æä¾›çš„æ•°æ®å­˜å‚¨èµ·æ¥ï¼Œæ‰€ä»¥å¤§ä½“ä¸Š`provide`çš„å®ç°å¦‚ä¸‹ï¼š

```typescript
export function provide<T>(key: string | number, value: T) {
  // æä¾›è€…

  const currentInstance: any = getCurrentInstance()
  if (currentInstance) {
    let { provides } = currentInstance
    provides[key] = value
  }
}
```

`provide`å·²ç»å®ç°äº†ï¼Œé‚£ä¹ˆ`inject`ä»–å°±æ˜¯ä¸€ä¸ªä»å®¹å™¨ä¸­æ‹¿å–æ•°æ®çš„ä¸€ä¸ªè¿‡ç¨‹ï¼Œä¸è¿‡è¿™ä¸ªå®¹å™¨è¦åœ¨ parentï¼ˆçˆ¶ç»„ä»¶ï¼‰ä¸Šè·å–çˆ¶ç»„ä»¶çš„ providesã€‚

```typescript
export function inject<T>(key: string, defaultValue?: unknown) {
  // æ¥æ”¶è€…
  // åœ¨å“ªé‡Œæ‹¿valueå‘¢ï¼Ÿåœ¨instanceçš„parentä¸Šé¢è·å–åˆ°çˆ¶ç»„ä»¶çš„instanceç„¶åç‚¹å‡ºprovide
  const currentInstance: any = getCurrentInstance()
  if (currentInstance) {
    const parentProvides = currentInstance.parent.provides

    return parentProvides[key]
  }
}
```

æ­¤æ—¶æˆ‘åœ¨è¿™é‡Œå‡†å¤‡çš„ demo å°±å·²ç»å¯ä»¥ä½¿ç”¨ provide å’Œ inject å®Œæˆçˆ¶å­ç»„ä»¶çš„æ•°æ®ä¼ å‚äº†ã€‚

```typescript
// æä¾›è€…
const Provider = {
  name: 'Provider',
  setup() {
    provide('foo', 'fooVal')
    provide('bar', 'barVal')
  },
  render() {
    return h('div', {}, [h('p', {}, 'Provider'), h(Consumer)])
  },
}
// æ¥æ”¶è€…
const Consumer = {
  name: 'Consumer',
  setup() {
    const fooVal = inject('foo')
    const barVal = inject('bar')
    return {
      fooVal,
      barVal,
    }
  },
  render() {
    return h('div', {}, `Consumer-${this.fooVal}-${this.barVal}`)
  },
}
```

[![XdJRrF.md.png](https://s1.ax1x.com/2022/06/04/XdJRrF.md.png)](https://imgtu.com/i/XdJRrF)

å½“ç„¶ï¼Œä¸ä¸€å®šæ˜¯çˆ¶å­ç»„ä»¶è¿™ç§å…³ç³»è¿™ä¹ˆç®€å•ï¼Œå®ƒå¯ä»¥æ˜¯çˆ·çˆ·å’Œå­™å­ç»„ä»¶çš„å…³ç³»ã€å¤ªçˆ·çˆ·å’Œå¤ªå­™å­ç»„ä»¶çš„å…³ç³»......ï¼Œè¿™ç§æƒ…å†µç»™ä½ å¦‚ä½•å¤„ç†ï¼Ÿæ¯”å¦‚ä¸‹é¢çš„æƒ…å†µï¼š

æˆ‘åœ¨ Provider å’Œ Consumer ä¸­é—´åŠ äº†ä¸€å±‚ç»„ä»¶å«`ProviderTwo`ï¼Œç”¨æ¥æ¨¡æ‹Ÿè·¨ç»„ä»¶æ•°æ®å…±äº«è¿™æ ·çš„æƒ…æ™¯ã€‚æˆ‘ä»¬ä¾ç„¶æ²¿ç”¨ä¹‹å‰çš„é€»è¾‘ï¼Œå‘ç°`Consumer`çš„ foo å’Œ bar ä¸º undefinedã€‚

```typescript
const Provider = {
  name: 'Provider',
  setup() {
    provide('foo', 'fooVal')
    provide('bar', 'barVal')
  },
  render() {
    return h('div', {}, [h('p', {}, 'Provider'), h(ProviderTwo)])
  },
}
const ProviderTwo = {
  name: 'ProviderTwo',
  setup() {},
  render() {
    return h('div', {}, [h('p', {}, `ProviderTwo`), h(Consumer)])
  },
}
const Consumer = {
  name: 'Consumer',
  setup() {
    const fooVal = inject('foo')
    const barVal = inject('bar')
    return {
      fooVal,
      barVal,
    }
  },
  render() {
    return h('div', {}, `Consumer-${this.fooVal}-${this.barVal}`)
  },
}
```

[![XdNaDO.md.png](https://s1.ax1x.com/2022/06/04/XdNaDO.md.png)](https://imgtu.com/i/XdNaDO)

è¿™æ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼Ÿå…¶å® Consumer çš„çˆ¶ç»„ä»¶ ProviderTwo å¹¶æ²¡æœ‰ç»™ provide å±æ€§æä¾›æ•°æ®ï¼Œæ˜¯ä¸ªç©ºå¯¹è±¡ã€‚Consumer åœ¨ä½¿ç”¨ inject çš„æ—¶å€™æ‹¿äº† ProviderTwo çš„ç©ºå¯¹è±¡ï¼Œç»“æœå½“ç„¶ä¸º undefinedã€‚

```typescript
export function createComponentInstance(vnode: any, parentComponent: any) {
  const type = vnode.type
  const instance = {
    vnode,
    type,
    render: null,
    setupState: {},
    props: {},
    emit: () => {},
    slots: {},
    provides: {} as Record<string, any>,
    parent: parentComponent, // çˆ¶ç»„ä»¶çš„ç»„ä»¶å®ä¾‹
  }
  instance.emit = emit.bind(null, instance) as any
  return instance
}
```

æˆ‘èƒ½æƒ³åˆ°çš„å°±ï¼Œprovides ä¸å†æŒ‡å‘ç©ºå¯¹è±¡ï¼Œè€Œæ˜¯æŒ‡å‘ä¸Šä¸€çº§çˆ¶ç»„ä»¶çš„ providesï¼Œä¸€å±‚ä¸€å±‚çš„æŒ‡å‘çˆ¶ç»„ä»¶çš„ providesï¼Œç›´åˆ°æ²¡æœ‰çˆ¶ç»„ä»¶ä¸ºæ­¢ã€‚

æˆ‘ä»¬æ¥æ”¹å†™ä¸€ä¸‹`createComponentInstance()`ï¼š

```typescript
export function createComponentInstance(vnode: any, parentComponent: any) {
  const type = vnode.type
  const instance = {
    vnode,
    type,
    render: null,
    setupState: {},
    props: {},
    emit: () => {},
    slots: {},
    provides: parentComponent ? parentComponent.provides : ({} as Record<string, any>), // ç¡®ä¿ä¸­é—´å±‚çš„ç»„ä»¶æ²¡æœ‰æä¾›provideæ—¶ï¼Œå­ç»„ä»¶æ‹¿æœ€è¿‘çš„æœ‰provideçš„çˆ¶ç»„ä»¶çš„æ•°æ®
    parent: parentComponent, // çˆ¶ç»„ä»¶çš„ç»„ä»¶å®ä¾‹
  }
  instance.emit = emit.bind(null, instance) as any
  return instance
}
```

è¿™æ ·å°±è§£å†³äº†ã€‚
[![XdU1L8.md.png](https://s1.ax1x.com/2022/06/04/XdU1L8.md.png)](https://imgtu.com/i/XdU1L8)

éœ€æ±‚å†æ¬¡å‡çº§ï¼Œè¿™æ¬¡æˆ‘ä»¬æƒ³åœ¨ ProviderTwo ç»„ä»¶å†…ä½¿ç”¨ provide å’Œ injectï¼ŒæœŸæœ›æ˜¯ï¼šProviderTwo ç»„ä»¶èƒ½æ¥æ”¶ Provider çš„ provide æ•°æ®ï¼ŒConsumer èƒ½æ¥æ”¶ ProviderTwo çš„ provide æ•°æ®ã€‚

```typescript
export const Provider = {
  name: 'Provider',
  setup() {
    provide('foo', 'fooVal')
    provide('bar', 'barVal')
  },
  render() {
    return h('div', {}, [h('p', {}, 'Provider'), h(ProviderTwo)])
  },
}
const ProviderTwo = {
  name: 'ProviderTwo',
  setup() {
    provide('foo', 'fooTwo')
    provide('bar', 'barTwo')
    // æœŸæœ›å¾—åˆ°providerçš„foo---fooValï¼Œå®é™…ä¸Šå¾—åˆ°çš„æ˜¯fooTwo
    const foo = inject('foo')
    const bar = inject('bar')
    return {
      foo,
      bar,
    }
  },
  render() {
    return h('div', {}, [h('p', {}, `ProviderTwo-${this.foo}-${this.bar}`), h(Consumer)])
  },
}
const Consumer = {
  name: 'Consumer',
  setup() {
    const fooVal = inject('foo')
    const barVal = inject('bar')
    return {
      fooVal,
      barVal,
    }
  },
  render() {
    return h('div', {}, `Consumer-${this.fooVal}-${this.barVal}`)
  },
}
```

[![XdYhy8.md.png](https://s1.ax1x.com/2022/06/04/XdYhy8.md.png)](https://imgtu.com/i/XdYhy8)

æˆ‘ä»¬æœŸæœ› ProviderTwo çš„ foo å’Œ bar åº”è¯¥æ˜¯ Provider æ‰€æä¾›çš„ fooVal å’Œ barValï¼Œç°å®å´æ˜¯ fooTwo å’Œ barTwoã€‚è¿™æ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼Ÿ

åŸå› æ˜¯ï¼šåœ¨`createComponentInstance()`çš„æ—¶å€™ instance çš„ provides æ˜¯ç›´æ¥æŒ‡å‘çˆ¶ç»„ä»¶çš„ providesï¼Œè€Œ ProviderTwo ç»„ä»¶ä¸­ provides è¢«é‡æ–°èµ‹å€¼ä¸º fooTwo å’Œ barTwoï¼Œåˆå› ä¸º provides æ˜¯å¼•ç”¨ç±»å‹ï¼Œæ‰€ä»¥å®ƒäº‹å®ä¸Šé—´æ¥æ”¹å˜äº†çˆ¶ç»„ä»¶çš„ provides çš„å€¼ã€‚

ä¸¾ä¸ªæ —å­ ğŸŒ°ï¼š

```typescript
let father = {
  foo: 'fooVal',
}
let obj3 = {
  provides: father,
}

obj3.provides['foo'] = 'changed'

console.log(father.foo) // output: changed
```

é‚£ä¹ˆå¦‚ä½•è§£å†³è¿™ä¸ªé—®é¢˜å‘¢ï¼Ÿ

æˆ‘ä»¬å¯ä»¥ç”¨åŸå‹é“¾çš„æ€æƒ³ï¼Œä¸ºå½“å‰çš„ç»„ä»¶çš„ provides åˆ›å»ºä¸€ä¸ªåŸå‹é“¾ï¼ŒåŸå‹å¯¹è±¡æŒ‡å‘çˆ¶ç»„ä»¶çš„ providesã€‚è¿™æ ·å°±ä¸å¿…æ‹…å¿ƒå¯¹è±¡çš„å¼•ç”¨é—®é¢˜ï¼Œå½“å‰ç»„ä»¶çš„ provides æ²¡æœ‰è¯¥æ•°æ®çš„æ—¶å€™ï¼Œä»–ä¼šæ²¿ç€åŸå‹é“¾å‘ä¸Šå¯»æ‰¾è¯¥æ•°æ®ï¼ŒçŸ¥é“æ‰¾ä¸åˆ°ä¸ºæ­¢ã€‚å¦‚ä¸‹ï¼šæˆ‘ç”¨`Object.create`åˆ›å»ºä¸€ä¸ªåŸå‹å¯¹è±¡æ˜¯ father çš„å¯¹è±¡ã€‚

```typescript
let father = {
  foo: 'fooVal',
}
let obj3 = {
  provides: father,
}

obj3.provides = Object.create(father)

obj3.provides['foo'] = 'changed'

console.log(father.foo) // output: fooVal
console.log(obj3.provides['foo']) // output: changed
```

ç”¨è¿™ç§æ€æƒ³è§£å†³ provide çš„é—®é¢˜ï¼Œä»£ç å°†ä¼šæ˜¯å¦‚ä¸‹ï¼š

```typescript
export function provide<T>(key: string | number, value: T) {
  // æä¾›è€…
  // keyå’Œvalueå­˜åœ¨å“ªå‘¢ï¼ŸæŒ‚åœ¨instanceçš„provideså±æ€§ä¸Šå§ï¼

  const currentInstance: any = getCurrentInstance()
  if (currentInstance) {
    let { provides } = currentInstance
    const parentProvides = currentInstance.parent?.provides
    if (provides === parentProvides) {
      // æŠŠprovideåŸå‹æŒ‡å‘çˆ¶ç»„ä»¶çš„provide
      provides = currentInstance.provides = Object.create(parentProvides)
    }
    provides[key] = value
  }
}
```

â— é‡Œé¢çš„åˆ¤æ–­æ¡ä»¶`provides === parentProvides`æ˜¯ä¸ºäº†é¿å…é‡å¤ä½¿ç”¨ provide é€ æˆç»„ä»¶å®ä¾‹çš„ provides è¢«åˆå§‹åŒ–ã€‚

è¿™æ · provide å’Œ inject å°±å®ç°äº†ï¼
[![Xd4NtA.md.png](https://s1.ax1x.com/2022/06/05/Xd4NtA.md.png)](https://imgtu.com/i/Xd4NtA)

å¦‚æœä½ è¿˜æƒ³å®ç° inject çš„é»˜è®¤å€¼åŠŸèƒ½ï¼Œä»£ç å°†ä¼šæ˜¯å¦‚ä¸‹ï¼š

```typescript
export function inject<T>(key: string, defaultValue?: T) {
  // æ¥æ”¶è€…
  // åœ¨å“ªé‡Œæ‹¿valueå‘¢ï¼Ÿåœ¨instanceçš„parentä¸Šé¢è·å–åˆ°çˆ¶ç»„ä»¶çš„instanceç„¶åç‚¹å‡ºprovide
  const currentInstance: any = getCurrentInstance()
  if (currentInstance) {
    const parentProvides = currentInstance.parent.provides

    if (key in parentProvides) {
      return parentProvides[key]
    } else {
      // æ‰¾ä¸åˆ°æ³¨å…¥çš„
      // å¦‚æœé»˜è®¤å€¼æ˜¯å‡½æ•°ï¼Œæ‰§è¡Œå‡½æ•°
      if (isFunction(defaultValue)) {
        return defaultValue()
      }
      return defaultValue
    }
  }
}
```

å¯¹äº†ï¼Œè¿™ä¸ªé»˜è®¤å€¼åŠŸèƒ½æ”¯æŒä¼ å…¥ä¸€ä¸ªè¿”å›é»˜è®¤å€¼çš„å‡½æ•°ã€‚

ç”¨æ³•ï¼š

```typescript
let injectValue = inject('foo', () => 'this is default value')
```
