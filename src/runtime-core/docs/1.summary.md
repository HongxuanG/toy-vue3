# ğŸš€vue3 ä» template åˆ°çœŸå® DOM çš„æ¸²æŸ“ï¼ˆä¸€ï¼‰

## å‰è¨€

æœ¬æ–‡å°†ä¼šå®ç°ä¸€ä¸ªç®€å•çš„ vue è¿è¡Œæ—¶ runtimeï¼Œé€šè¿‡ rollup æ‰“åŒ… runtimeï¼Œå¹¶ç¡®ä¿èƒ½åœ¨ html ä¸­æ¸²æŸ“å‡ºå…ƒç´ ã€‚

æœ¬æ–‡çš„å‡½æ•°å‘½åå…¨éƒ¨é‡‡ç”¨ vue3 çš„å‡½æ•°åç§°ï¼Œé™ä½å¯¹ vue3 æºç çš„å­¦ä¹ æˆæœ¬ã€‚åœ¨å·©å›ºè‡ªå·±å¯¹ vue3 çš„ç†è§£çš„åŒæ—¶ï¼ŒæŠŠçŸ¥è¯†åˆ†äº«ç»™å¤§å®¶æ˜¯æˆ‘çš„ä¹è¶£æ‰€åœ¨ã€‚

> ğŸ¤£ å¦‚æœ‰é”™æ¼ï¼Œè¯·å¤šæŒ‡æ•™ â¤

## ç®€è¿°ä¸€ä¸‹å¤§è‡´çš„è¿‡ç¨‹

1. template ç¼–è¯‘æˆ render å‡½æ•°
2. æ ¹æ®ç¼–è¯‘åçš„ç»“æœç”Ÿæˆ vnode
3. patch å‡½æ•°å¯¹ vnode è¿›è¡Œ`æ‹†ç®±`æ“ä½œ
4. é€šè¿‡ createElement æŠŠ vnode è½¬æˆçœŸå®çš„ DOM
5. æŒ‚è½½ dom åˆ°æŒ‡å®šçš„ ç›®æ ‡ å®¹å™¨ä¸Š

## é¢„è§ˆæœ¬ demo çš„ä½¿ç”¨æ–¹æ³•
> æœ¬demoæš‚æ—¶åªå®ç°ç»„ä»¶å’ŒHTMLå…ƒç´ æŒ‚è½½DOMåŠŸèƒ½ã€‚å®ç°ç»„ä»¶èŠ‚ç‚¹æ›´æ–°åŠŸèƒ½åœ¨åç»­ç« èŠ‚ã€‚
> 
ä¸‡äº‹å¼€å¤´ï¼Œæœ‰ä¸€ä¸ªæœ€ç»ˆç»“æœå¾€å¾€èƒ½è®©æˆ‘ä»¬æœç€ä¸€ä¸ªæ–¹å‘å‰è¿›ã€‚

```html
<style>
  .red {
    width: 100px;
    color: red;
    background-color: aqua;
  }
  .blue {
    width: 100px;
    color: blue;
    background-color: aqua;
  }
  .flex {
    display: flex;
  }
  .container-r {
    flex-flow: row nowrap;
    justify-content: space-between;
    align-items: center;
  }
</style>
<body>
  <div id="app"></div>
  <script src="./main.js" type="module"></script>
</body>
```
```javascript
// In main.js

const rootContainer = document.querySelector('#app')

createApp(App).mount(rootContainer)
```
```javascript
// In app.js
// è¿™é‡Œå°±æ˜¯templateç»è¿‡ç¼–è¯‘åï¼Œå¾—åˆ°çš„æ ¹ç»„ä»¶ç»„åˆå¯¹è±¡ï¼ˆå¦‚æœç”¨æˆ·ä½¿ç”¨optionsAPIï¼Œæµ‹ç»˜å¾—åˆ°æ ¹ç»„ä»¶é€‰é¡¹å¯¹è±¡ï¼‰ï¼Œé‡Œé¢ä¼šåŒ…å«ä¸€ä¸ªrender()å‡½æ•°
export default {
  render() {
    return h('div', {
      id: 'root',
      class: ['flex', 'container-r']
    }, [
      h('p', {class: 'red'}, 'red'),
      h('p', {class: 'blue'}, 'blue')
    ])
  },
  setup() {
    // è¿”å›å¯¹è±¡æˆ–è€…h()æ¸²æŸ“å‡½æ•°
    return {
      name: 'hi my app'
    }
  }
}

```

## ç¼–è¯‘ template æˆ render å‡½æ•°
è¿™é‡Œå…³äºtemplateæ€ä¹ˆç¼–è¯‘æˆå…·æœ‰renderå‡½æ•°çš„ç‰¹æ®Šå¯¹è±¡ï¼Œå…·ä½“ä»£ç å®ç°æˆ‘ä»¬æš‚æ—¶å¿½ç•¥ã€‚å®ƒæ¶‰åŠASTçš„çŸ¥è¯†ã€‚

æµç¨‹å¤§è‡´åˆ†ä¸ºä¸‰å¤§ç‚¹ï¼š
1. parse

     * è§£ætemplateç”ŸæˆASTèŠ‚ç‚¹

2. transform

     * é’ˆå¯¹ASTè¿›è¡Œä¸€äº›è½¬æ¢
3. codegen

     * æ ¹æ®ä¸åŒçš„ASTèŠ‚ç‚¹è°ƒç”¨ä»£ç ç”Ÿæˆå‡½æ•°è¾“å‡ºä»£ç å­—ç¬¦ä¸²ï¼Œè¿›è€Œç”Ÿæˆrenderå‡½æ•°



## ç”Ÿæˆè™šæ‹ŸèŠ‚ç‚¹ vnode
ä¸ºä»€ä¹ˆè¦æœ‰vnodeè¿™ä¸ªä¸œè¥¿ï¼Ÿ

vnodeæ˜¯çœŸå®domçš„æŠ½è±¡å­˜åœ¨ï¼Œå½“æˆ‘ä»¬ä¸šåŠ¡è¶Šæ¥è¶Šå¤æ‚ï¼Œè¿™æ—¶å€™å¤§é‡æ“ä½œdomæ˜¾ç„¶ä¼šæ¶ˆè€—å¤§é‡çš„æ€§èƒ½ï¼Œè€Œæœ‰äº†vnode çš„å­˜åœ¨ï¼Œæˆ‘ä»¬å¯ä»¥é¢„å…ˆåœ¨vnodeè¿›è¡Œæ“ä½œï¼Œæ“ä½œå®Œæˆä¹‹åï¼Œåœ¨ç»Ÿä¸€æŠŠçœŸå®æƒ³è¦çš„domçš„æ ·å­æ¸²æŸ“å¤„ç†ï¼Œä¸å¿…åœ¨domæ¯æ¬¡æ“ä½œä¸€æ¬¡æ¸²æŸ“ä¸€æ¬¡ã€‚

é‚£ä»€ä¹ˆæ—¶å€™ç”Ÿæˆvnodeå‘¢ï¼Ÿ

åˆ›å»ºvueä¸Šä¸‹æ–‡çš„æ—¶å€™ï¼ŒcreateAppæ¥å—æ ¹ç»„ä»¶é€‰é¡¹å¯¹è±¡æˆ–è€…æ ¹ç»„ä»¶ç»„åˆå¯¹è±¡ï¼Œå¹¶è¿”å›ä¸€ç³»åˆ—çš„åº”ç”¨APIï¼ˆcomponentã€mountã€configã€useç­‰ç­‰ï¼‰ï¼Œå…¶ä¸­mountåŠŸèƒ½æŠŠä¼ å…¥çš„æ ¹ç»„ä»¶é€‰é¡¹å¯¹è±¡æˆ–è€…æ ¹ç»„ä»¶ç»„åˆå¯¹è±¡æŒ‚è½½åˆ°æŒ‡å®šçš„æ ¹èŠ‚ç‚¹ä¸­ã€‚åœ¨è¿™ä¸ªæŒ‚è½½ä¹‹å‰å¿…é¡»æŠŠæ ¹ç»„ä»¶å¯¹è±¡è½¬æ¢æˆvnodeï¼Œè¿™æ—¶å€™å°±è¦è°ƒç”¨`createVNode`

æˆ‘ä»¬å¯ä»¥ç®€å•å®ç°ä»¥ä¸‹createApp
```typescript
export function createApp(rootComponent: any) {

  // mountå‡½æ•°å¯æ¥å—domå®ä¾‹å¯¹è±¡æˆ–è€…domçš„IDå±æ€§(string)
  const mount = (rootContainer: any) => {
    const vnode = createVNode(rootComponent)
    // æ ¹ç»„ä»¶çš„vnode
    render(vnode, rootContainer)
  }
  return {
    mount,
  }
}
```

typeæ˜¯ç»„ä»¶å¯¹è±¡æˆ–è€…å…ƒç´ ï¼Œpropsæ˜¯ç»„ä»¶çš„å†…è”å±æ€§ï¼Œchildrenæ˜¯ç»„ä»¶çš„å­ç»„ä»¶æˆ–è€…å­å…ƒç´ ã€‚
```typescript

// ç”±äºåªæ˜¯å®ç°ç®€å•çš„æ¸²æŸ“vnodeåŠŸèƒ½ï¼Œæ‰€ä»¥ç›®å‰åªéœ€è¦è¿”å›vnodeå¯¹è±¡
export function createVNode(type: any, props?: any, children?: any) {
  const vnode = {
    type,
    props,
    children,
  }
  return vnode
}

```
æŒ‰ç…§å®˜æ–¹æ–‡æ¡£æ¥è¯´[`h()`å‡½æ•°](https://v3.cn.vuejs.org/api/global-api.html#h)çš„å®ç°ä¹Ÿæ˜¯`createVNode()`ï¼Œè¿”å›ä¸€ä¸ªè™šæ‹ŸèŠ‚ç‚¹ã€‚
```typescript
export function h(type: any, props?: any, children?: any) {
  return createVNode(type, props, children)
}
```

renderå†…éƒ¨ç”¨äºæ‰§è¡Œpatch()ï¼ˆä»€ä¹ˆæ˜¯patchï¼Œè§ä¸‹æ–¹*ç»è¿‡ patch æ‹†ç®±*ï¼‰
```typescript
export function render(vnode: any, container: any) {
  // åšpatchç®—æ³•
  patch(vnode, container)
}
```

## ç»è¿‡ patch æ‹†ç®±

patchä¼šåˆ¤æ–­å½“å‰ä¼ å…¥å‚æ•°çš„`vnode.type`å±æ€§æ˜¯ä»€ä¹ˆç±»å‹ã€‚

* å¦‚æœvnode.typeæ˜¯`string`ç±»å‹ï¼Œè¯´æ˜è¿™ä¸ªvnodeæ˜¯æ™®é€šå…ƒç´ æ ‡ç­¾ï¼Œpatchå†…éƒ¨ä¼šè°ƒç”¨processElementè¿›è¡Œå¯¹æ™®é€šå…ƒç´ çš„vnodeç»§ç»­å¤„ç†ï¼ŒprocessElementå†…éƒ¨åˆç”¨äº†mountElement()æŠŠvnode.typeç”¨createElementåˆ›å»ºå‡ºdomå…ƒç´ ã€‚

* å¦‚æœvnode.typeæ˜¯`object`ç±»å‹ï¼Œè¯´æ˜è¿™ä¸ªvnodeæ˜¯ä¸€ä¸ªç»„ä»¶ã€‚å†æ¬¡è°ƒç”¨vnode.type.render()å¯ä»¥å¾—åˆ°å­å…ƒç´ çš„vnodeï¼Œç”¨å­å…ƒç´ çš„vnodeå†æ¬¡è°ƒç”¨patch()è¿›è¡Œæ‹†ç®±æ“ä½œï¼Œç›´åˆ°vnode.typeæ˜¯æ™®é€šå…ƒç´ æ ‡ç­¾ä¸ºæ­¢ã€‚
```typescript
// ä¼ å…¥vnodeï¼Œé€’å½’å¯¹ä¸€ä¸ªç»„ä»¶æˆ–è€…æ™®é€šå…ƒç´ è¿›è¡Œæ‹†ç®±ï¼Œåœ¨å†…éƒ¨å¯¹vnodeçš„typeåˆ¤æ–­æ‰§è¡Œä¸åŒçš„å¤„ç†å‡½æ•°
function patch(vnode: any, container: any) {
  // æ£€æŸ¥æ˜¯ä»€ä¹ˆç±»å‹çš„vnode
  console.log('vnode', vnode.type)
  if(typeof vnode.type === 'string'){
    // æ˜¯ä¸€ä¸ªæ™®é€šå…ƒç´ ï¼Ÿå¤„ç†vnodeæ˜¯æ™®é€šæ ‡ç­¾çš„æƒ…å†µ
    processElement(vnode, container)
  }else if(isObject(vnode.type)){
    // æ˜¯ä¸€ä¸ªç»„ä»¶ï¼Ÿå¤„ç†vnodeæ˜¯ç»„ä»¶çš„æƒ…å†µ
    processComponent(vnode, container)
  }
}
```
## processComponent å¤„ç†ç»„ä»¶

å¤„ç†ç»„ä»¶çš„äº‹æƒ…å¤§è‡´åˆ†ä¸ºä¸‰ä»¶äº‹ï¼š
1. åˆ›å»ºç»„ä»¶å®ä¾‹`instance`ã€‚
2. æŠŠsetupçš„è¿”å›å€¼`setupState`æŒ‚è½½åœ¨ç»„ä»¶å®ä¾‹`instance`ä¸Šã€‚
3. æŠŠrenderå‡½æ•°æŒ‚è½½åœ¨ç»„ä»¶å®ä¾‹`instance`ä¸Šï¼Œä»¥ä¾¿å¯¹renderè¿”å›çš„vnodeåšpatch()æ‹†ç®±å¤„ç†ã€‚

è¿™äº›äº‹æƒ…éƒ½åœ¨mountComponenté‡Œé¢å®Œæˆ

```typescript

function processComponent(vnode: any, container: any) {
  mountComponent(vnode, container)
}
function mountComponent(vnode: any, container: any) {
  const instance = createComponentInstance(vnode)
  // å®‰è£…ç»„ä»¶
  setupComponent(instance)

  //
  setupRenderEffect(instance, container)
}
// åˆ›å»ºç»„ä»¶å®ä¾‹
export function createComponentInstance(vnode: any) {
  const type = vnode.type
  const instance = {
    vnode,
    type,
  }
  return instance
}
function setupRenderEffect(instance: any, container: any) {
  console.log(instance)
  // è¿™ä¸ªrender()å·²ç»åœ¨finishComponentSetupå¤„ç†è¿‡äº†ï¼Œå°±æ˜¯ instance.type.render() ç‰¹æ®Šå¯¹è±¡çš„render()
  const subTree = instance.render()
  // å¯¹å­æ ‘è¿›è¡Œæ‹†ç®±æ“ä½œ
  patch(subTree, container)
}
//
export function setupComponent(instance: any) {
  // initProps()
  // initSlots()
  setupStatefulComponent(instance)
}
// åˆå§‹åŒ–ç»„ä»¶çš„çŠ¶æ€
function setupStatefulComponent(instance: any) {
  const Component = instance.type
  const { setup } = Component
  // æœ‰æ—¶å€™ç”¨æˆ·å¹¶æ²¡æœ‰ä½¿ç”¨setup()
  if (setup) {
    // å¤„ç†setupçš„è¿”å›å€¼ï¼Œå¦‚æœè¿”å›çš„æ˜¯å¯¹è±¡ï¼Œé‚£ä¹ˆæŠŠå¯¹è±¡é‡Œé¢çš„å€¼æ³¨å…¥åˆ°templateä¸Šä¸‹æ–‡ä¸­
    // å¦‚æœæ˜¯ä¸€ä¸ªå‡½æ•°h()ï¼Œé‚£ä¹ˆç›´æ¥render

    const setupResult = setup()

    handleSetupResult(instance, setupResult)
  }
  finishComponentSetup(instance)
}
// å¤„ç†ç»„ä»¶çš„setupçš„è¿”å›å€¼
function handleSetupResult(instance: any, setupResult: any) {
  if (isFunction(setupResult)) {
  // TODO handle function
  } else if (isObject(setupResult)) {
    // æŠŠsetupè¿”å›çš„å¯¹è±¡æŒ‚è½½åˆ°setupStateä¸Š
    instance.setupState = setupResult
  }
}
// ç»“æŸç»„ä»¶çš„å®‰è£…
function finishComponentSetup(instance: any) {
  const Component = instance.type // é‡åˆ°h('div',{}, this.name)  è¿™é‡ŒComponentå°†ä¸º'div'

  if (instance) {
    instance.render = Component.render
  }
}
```

## processElement å¤„ç†å…ƒç´ 

å¤„ç†å…ƒç´ çš„äº‹æƒ…å¤§è‡´åˆ†ä¸ºä¸‰ä»¶äº‹ï¼š
1. æ ¹æ®vnode.typeåˆ›å»ºHTMLå…ƒç´ ã€‚
2. æ ¹æ®vnode.childrençš„ç±»å‹åˆ¤æ–­æ˜¯stringè¿˜æ˜¯arrayï¼Œå¦‚æœæ˜¯stringï¼Œé‚£ä¹ˆè¯´æ˜childrenæ˜¯æ–‡æœ¬èŠ‚ç‚¹ï¼Œå¦‚æœæ˜¯arrayï¼Œæˆ‘ä»¬å¹¶ä¸çŸ¥é“æ¯ä¸ªå…ƒç´ åˆ°åº•æ˜¯HTMLå…ƒç´ è¿˜æ˜¯ç»„ä»¶ï¼Œè¿™ç‚¹åŒæ ·é€šè¿‡patchå¤„ç†ã€‚
3. æ ¹æ®vnode.propså¯¹è±¡ï¼Œéå†æ¥è®¾ç½®HTMLå…ƒç´ çš„å±æ€§ã€‚



```typescript
// æ­¤æ—¶çš„vnode.typeæ˜¯ä¸€ä¸ªstringç±»å‹çš„HTMLå…ƒç´ 
function processElement(vnode: any, container: any) {
  mountElement(vnode, container)
}

```

## ç”ŸæˆçœŸå® DOM èŠ‚ç‚¹

ç”ŸæˆçœŸå®çš„DOMèŠ‚ç‚¹ï¼Œå…¶å®é€»è¾‘å°±åœ¨mountElement()é‡Œé¢ã€‚

> mountElement()å‡½æ•°ä¼ å…¥ä¸¤ä¸ªå‚æ•°ï¼š`vnode`å’Œ`container`ã€‚

å› ä¸ºæ­¤æ—¶è°ƒç”¨mountElementçš„vnode.typeå·²ç»è¢«è®¤å®šä¸ºæ˜¯æ™®é€šçš„HTMLElementï¼Œé‚£ä¹ˆå°±èƒ½ç”¨`document.createElement(vnode.type)`åˆ›å»ºdomèŠ‚ç‚¹ï¼Œæ³¨æ„ï¼šè¿™é‡Œçš„vnode.typeæ˜¯stringç±»å‹ã€‚

é™¤æ­¤ä¹‹å¤–ï¼Œæˆ‘ä»¬è¿˜å¿…é¡»å¤„ç†vnode.propså±æ€§ï¼Œå®ƒæ˜¯åŒ…å«ç€è¿™ä¸ªHTMLå…ƒç´ çš„æ‰€æœ‰å†…è”å±æ€§çš„å¯¹è±¡ï¼Œæ¯”å¦‚`id`ã€`class`ã€`style`ç­‰ç­‰ã€‚å¦‚æœclassæœ‰å¤šä¸ªç±»åï¼Œé€šè¿‡æ•°ç»„è¡¨ç¤ºã€‚å¤„ç†propså±æ€§æˆ‘ä»¬è”æƒ³åˆ°äº†éå†propså¯¹è±¡ç„¶åè°ƒç”¨`setAttribute()`å‡½æ•°ï¼ŒæŠŠå±æ€§æ·»åŠ åˆ°domèŠ‚ç‚¹ä¸Šã€‚

æˆ‘ä»¬è¿˜å¾—å¤„ç†domèŠ‚ç‚¹çš„å­èŠ‚ç‚¹ï¼Œè¿™é‡Œæˆ‘ä»¬åˆ†ä¸¤ç§æƒ…å†µï¼š
1. vnode.childrenæ˜¯ä¸€ä¸ª`string`ç±»å‹ï¼Œè¯´æ˜å­èŠ‚ç‚¹æ˜¯æ–‡æœ¬èŠ‚ç‚¹ã€‚
2. vnode.childrenæ˜¯ä¸€ä¸ª`array`ç±»å‹ï¼Œä¸æ¸…æ¥šé‡Œé¢çš„å­å…ƒç´ æ˜¯æ–‡æœ¬èŠ‚ç‚¹è¿˜æ˜¯ç»„ä»¶ï¼Œè¿™æ—¶æˆ‘ä»¬å¯ä»¥é€šè¿‡`patch()`åšæ‹†ç®±å¤„ç†ã€‚

å®šä¹‰ä¸€ä¸ªmountChildren()

é‡Œé¢çš„å®ç°å¤§è‡´å°±æ˜¯ï¼šé€šè¿‡éå†vnode.childrenæ•°ç»„ï¼Œè®©æ¯ä¸ªå­å…ƒç´ éƒ½æ‰§è¡Œpatch()
```typescript
function mountElement(vnode: any, container: any) {
  const el = document.createElement(vnode.type) as HTMLElement
  let { children, props } = vnode
  if (isString(children)) {
    el.textContent = children
  } else if (Array.isArray(children)) {
    mountChildren(vnode, el)
  }
  // å¯¹vnodeçš„propsè¿›è¡Œå¤„ç†ï¼ŒæŠŠè™šæ‹Ÿå±æ€§æ·»åŠ åˆ°el
  for (let key of Object.getOwnPropertyNames(props).values()) {
    if(Array.isArray(props[key])){
      el.setAttribute(key, props[key].join(' '))
    }else{
      el.setAttribute(key, props[key])
    }
  }
  container.append(el)
}

// å¤„ç†å­èŠ‚ç‚¹
function mountChildren(vnode: any, container: any){
  vnode.children.forEach((vnode: any) => {
    patch(vnode, container)
  });
}
```
## ä½¿ç”¨rollupæ‰“åŒ…ä»£ç 
1. å®‰è£…rollup


    ç»ˆç«¯è¾“å…¥å‘½ä»¤`pnpm i rollup @rollup/plugin-typescript typescript tslib -D`

    æ²¡æœ‰pnpmçš„å¯ä»¥ä½¿ç”¨npm
2. åœ¨æ ¹ç›®å½•æ–°å»ºrollup.config.js
   ```typescript
    import typescript from '@rollup/plugin-typescript'
    export default {
      input: './src/index.ts',
      output: [
        {
          file: './lib/guide-toy-vue3.cjs.js',
          format: 'cjs'
        },
        {
          file: './lib/guide-toy-vue3.esm.js',
          format: 'es'
        }
      ],
      plugins: [typescript()]
    }
   ```
3. package.jsonæ·»åŠ æ‰§è¡Œè„šæœ¬
   
```json
"scripts": {
  "build": "rollup -c rollup.config.js"
},
```

## æœ€å@æ„Ÿè°¢é˜…è¯»

å½“å­¦ä¹ æˆä¸ºä¸€ç§ä¹ æƒ¯ï¼ŒçŸ¥è¯†å°±å˜æˆäº†å¸¸è¯†ã€‚

## æœ¬é˜¶æ®µçš„å®Œæ•´æºç 
æœ¬ä»£ç å·²ç»æŒ‚åœ¨stackblitzä¸Šäº†ï¼Œå¤§å®¶è¿›å»ä¹‹åï¼Œä»–ä¼šè‡ªåŠ¨å¸®æˆ‘ä»¬å®‰è£…ä¾èµ–ã€‚

* æŸ¥çœ‹æ•ˆæœ`example/index.html`ï¼Œåªéœ€è¦åœ¨ç»ˆç«¯è¾“å…¥`npm start`
* æ‰“åŒ…runtime-coreçš„ä»£ç å¯ä»¥åœ¨ç»ˆç«¯è¾“å…¥`npm run build`


[å®Œæ•´æºç ](https://stackblitz.com/edit/ghx-vue3-runtime-core)
