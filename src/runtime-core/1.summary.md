# ğŸš€vue3 ä» template åˆ°çœŸå® DOM çš„æ¸²æŸ“ï¼ˆä¸€ï¼‰

## å‰è¨€

æœ¬æ–‡å°†ä¼šå®ç°ä¸€ä¸ªç®€å•çš„ vue è¿è¡Œæ—¶ runtimeï¼Œé€šè¿‡ rollup æ‰“åŒ… runtimeï¼Œå¹¶ç¡®ä¿èƒ½åœ¨ html ä¸­æ¸²æŸ“å‡ºå…ƒç´ ã€‚

æœ¬æ–‡çš„å‡½æ•°å‘½åå…¨éƒ¨é‡‡ç”¨ vue3 çš„å‡½æ•°åç§°ï¼Œé™ä½å¯¹ vue3 æºç çš„å­¦ä¹ æˆæœ¬ã€‚åœ¨å·©å›ºè‡ªå·±å¯¹ vue3 çš„ç†è§£çš„åŒæ—¶ï¼ŒæŠŠçŸ¥è¯†åˆ†äº«ç»™å¤§å®¶æ˜¯æˆ‘çš„ä¹è¶£æ‰€åœ¨ã€‚

> ğŸ¤£ å¦‚æœ‰é”™æ¼ï¼Œè¯·å¤šæŒ‡æ•™ â¤

## ç®€è¿°ä¸€ä¸‹å¤§è‡´çš„è¿‡ç¨‹

1. template ç¼–è¯‘æˆ render å‡½æ•°
2. æ ¹æ®ç¼–è¯‘åçš„ç»“æœç”Ÿæˆ vnode
3. patch å‡½æ•°å¯¹ vnode è¿›è¡Œ`æ‹†ç®±`æ“ä½œ
4. é€šè¿‡ createElement æŠŠ vnode è½¬æˆçœŸå®çš„ DOM
5. æŒ‚è½½ dom åˆ°æŒ‡å®šçš„ dom å®¹å™¨ä¸Š

## é¢„è§ˆæœ¬ demo çš„ä½¿ç”¨æ–¹æ³•

ä¸‡äº‹å¼€å¤´ï¼Œæœ‰ä¸€ä¸ªæœ€ç»ˆç»“æœå¾€å¾€èƒ½è®©æˆ‘ä»¬æœç€ä¸€ä¸ªæ–¹å‘å‰è¿›ã€‚

```html
<style>
  .red {
    width: 100px;
    color: red;
    background-color: aqua;
  }
  .blue {
    width: 100px;
    color: blue;
    background-color: aqua;
  }
  .flex {
    display: flex;
  }
  .container-r {
    flex-flow: row nowrap;
    justify-content: space-between;
    align-items: center;
  }
</style>
<body>
  <div id="app"></div>
  <script src="./main.js" type="module"></script>
</body>
```
```javascript
// In main.js

const rootContainer = document.querySelector('#app')

createApp(App).mount(rootContainer)
```
```javascript
// In app.js
// è¿™é‡Œå°±æ˜¯templateç»è¿‡ç¼–è¯‘åï¼Œå¾—åˆ°çš„å¯¹è±¡ï¼Œé‡Œé¢ä¼šåŒ…å«ä¸€ä¸ªrender()å‡½æ•°
export default {
  render() {
    return h('div', {
      id: 'root',
      class: ['flex', 'container-r']
    }, [
      h('p', {class: 'red'}, 'red'),
      h('p', {class: 'blue'}, 'blue')
    ])
  },
  setup() {
    // è¿”å›å¯¹è±¡æˆ–è€…h()æ¸²æŸ“å‡½æ•°
    return {
      name: 'hi my app'
    }
  }
}

```


## ç¼–è¯‘ template æˆ render å‡½æ•°



## ç”Ÿæˆè™šæ‹ŸèŠ‚ç‚¹ vnode

ç”±äºåªæ˜¯å®ç°ç®€å•çš„æ¸²æŸ“vnodeåŠŸèƒ½ï¼Œæ‰€ä»¥ç›®å‰åªéœ€è¦è¿”å›vnodeå¯¹è±¡

```typescript
export function createVNode(type: any, props?: any, children?: any) {
  const vnode = {
    type,
    props,
    children,
  }
  return vnode
}

```

## ç»è¿‡ patch æ‹†ç®±

patchä¼šåˆ¤æ–­å½“å‰ä¼ å…¥å‚æ•°çš„`vnode.type`å±æ€§æ˜¯ä»€ä¹ˆç±»å‹ã€‚

* å¦‚æœvnode.typeæ˜¯`string`ç±»å‹ï¼Œè¯´æ˜è¿™ä¸ªvnodeæ˜¯æ™®é€šå…ƒç´ æ ‡ç­¾ï¼Œpatchå†…éƒ¨ä¼šè°ƒç”¨processElementè¿›è¡Œå¯¹æ™®é€šå…ƒç´ çš„vnodeç»§ç»­å¤„ç†ï¼ŒprocessElementå†…éƒ¨åˆç”¨äº†mountElement()æŠŠvnode.typeç”¨createElementåˆ›å»ºå‡ºdomå…ƒç´ ã€‚

* å¦‚æœvnode.typeæ˜¯`object`ç±»å‹ï¼Œè¯´æ˜è¿™ä¸ªvnodeæ˜¯ä¸€ä¸ªç»„ä»¶ã€‚å†æ¬¡è°ƒç”¨vnode.type.render()å¯ä»¥å¾—åˆ°å­å…ƒç´ çš„vnodeï¼Œç”¨å­å…ƒç´ çš„vnodeå†æ¬¡è°ƒç”¨patch()è¿›è¡Œæ‹†ç®±æ“ä½œï¼Œç›´åˆ°vnode.typeæ˜¯æ™®é€šå…ƒç´ æ ‡ç­¾ä¸ºæ­¢ã€‚


## ç”ŸæˆçœŸå® DOM èŠ‚ç‚¹

ç”ŸæˆçœŸå®çš„DOMèŠ‚ç‚¹ï¼Œå…¶å®é€»è¾‘å°±åœ¨mountElement()é‡Œé¢ã€‚

mountElement()å‡½æ•°ä¼ å…¥ä¸¤ä¸ªå‚æ•°ï¼š`vnode`å’Œ`container`ã€‚

å› ä¸ºæ­¤æ—¶è°ƒç”¨mountElementçš„vnodeå·²ç»è¢«è®¤å®šä¸ºæ˜¯æ™®é€šçš„HTMLElementï¼Œé‚£ä¹ˆå°±èƒ½ç”¨`document.createElement(vnode.type)`åˆ›å»ºdomèŠ‚ç‚¹ï¼Œæ³¨æ„ï¼šè¿™é‡Œçš„vnode.typeæ˜¯stringç±»å‹ã€‚

é™¤æ­¤ä¹‹å¤–ï¼Œæˆ‘ä»¬è¿˜å¿…é¡»å¤„ç†vnode.propså±æ€§ï¼Œå®ƒæ˜¯åŒ…å«ç€è¿™ä¸ªHTMLå…ƒç´ çš„æ‰€æœ‰å†…è”å±æ€§çš„å¯¹è±¡ï¼Œæ¯”å¦‚`id`ã€`class`ã€`style`ç­‰ç­‰ã€‚å¦‚æœclassæœ‰å¤šä¸ªç±»åï¼Œé€šè¿‡æ•°ç»„è¡¨ç¤ºã€‚å¤„ç†propså±æ€§æˆ‘ä»¬è”æƒ³åˆ°äº†éå†propså¯¹è±¡ç„¶åè°ƒç”¨`setAttribute()`å‡½æ•°ï¼ŒæŠŠå±æ€§æ·»åŠ åˆ°domèŠ‚ç‚¹ä¸Šã€‚

æˆ‘ä»¬è¿˜å¾—å¤„ç†domèŠ‚ç‚¹çš„å­èŠ‚ç‚¹ï¼Œè¿™é‡Œæˆ‘ä»¬åˆ†ä¸¤ç§æƒ…å†µï¼š
1. vnode.childrenæ˜¯ä¸€ä¸ª`string`ç±»å‹ï¼Œè¯´æ˜å­èŠ‚ç‚¹æ˜¯æ–‡æœ¬èŠ‚ç‚¹ã€‚
2. vnode.childrenæ˜¯ä¸€ä¸ª`array`ç±»å‹ï¼Œä¸æ¸…æ¥šé‡Œé¢çš„å­å…ƒç´ æ˜¯æ–‡æœ¬èŠ‚ç‚¹è¿˜æ˜¯ç»„ä»¶ï¼Œè¿™æ—¶æˆ‘ä»¬å¯ä»¥é€šè¿‡`patch()`åšæ‹†ç®±å¤„ç†ã€‚

å®šä¹‰ä¸€ä¸ªmountChildren()

é‡Œé¢çš„å®ç°å¤§è‡´å°±æ˜¯ï¼šé€šè¿‡éå†vnode.childrenæ•°ç»„ï¼Œè®©æ¯ä¸ªå­å…ƒç´ éƒ½æ‰§è¡Œpatch()
```typescript

```


## æœ€å@æ„Ÿè°¢é˜…è¯»

## æœ¬é˜¶æ®µçš„å®Œæ•´æºç 
å¤§å®¶è¿›å»ä¹‹åï¼Œä»–ä¼šè‡ªåŠ¨å¸®æˆ‘ä»¬å®‰è£…ä¾èµ–ã€‚

* æŸ¥çœ‹æ•ˆæœ`example/index.html`ï¼Œåªéœ€è¦åœ¨ç»ˆç«¯è¾“å…¥`npm start`
* æ‰“åŒ…runtime-coreçš„ä»£ç å¯ä»¥åœ¨ç»ˆç«¯è¾“å…¥`npm run build`


[å®Œæ•´æºç ](https://stackblitz.com/edit/node-6ic27h?file=src%2Fruntime-core%2Fcomponent.ts,src%2Fruntime-core%2FcreateApp.ts,src%2Fruntime-core%2Fh.ts,src%2Fruntime-core%2Findex.ts,src%2Fruntime-core%2Frenderer.ts,src%2Fruntime-core%2Fvnode.ts,src%2Fshare%2Findex.ts,src%2Findex.ts,package.json,example%2Fapp.js,example%2Fmain.js,example%2Findex.html,server%2Findex.js)
